<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión Integral de Legajos - Juzgado de Ejecución Penal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:'Inter',sans-serif;}
    .relief-border{border:1px solid #d1d5db;border-radius:12px;}
    .kanban-column{min-height:260px}
    .card-drag{user-select:none}

    :root{
      --color-primary:#1e3a8a;
      --color-secondary:#f3f4f6;
      --color-accent:#2563eb;
    }
    header{background:var(--color-primary);color:white;padding:1rem 1.5rem;border-radius:0.75rem;}
    header h1{font-size:1.75rem;font-weight:700;}
    button{transition:all .2s ease}
    button:hover{opacity:.95}
    .btn-primary{background:var(--color-accent);color:white;padding:0.6rem 1rem;border-radius:0.6rem;font-weight:600}
    .btn-secondary{background:var(--color-secondary);color:#111827;padding:0.6rem 1rem;border-radius:0.6rem;font-weight:600}
    .btn-danger{background:#dc2626;color:white;padding:0.6rem 1rem;border-radius:0.6rem;font-weight:600}

    .tab-btn{padding:0.6rem 1rem;border-radius:.5rem}
    .tab-btn.font-medium{border-bottom:3px solid var(--color-accent)}

    .modal{background:white;border-radius:0.9rem;box-shadow:0 16px 40px rgba(0,0,0,.18)}

    .dark{background:#0f172a;color:#e5e7eb}
    .dark header{background:#0b1222;color:#e5e7eb}
    .dark .relief-border{border-color:#1f2937;background:#0b1222}
    .dark table{color:#e5e7eb}
    .dark .modal{background:#0b1222;color:#e5e7eb}

    .timeline{display:flex;align-items:center;gap:14px}
    .tl-step{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:78px}
    .tl-dot{width:14px;height:14px;border-radius:9999px;background:#d1d5db;transition:background .3s}
    .tl-dot.active{background:var(--color-accent)}
    .tl-line{flex:1;height:3px;background:#d1d5db;transition:background .3s}
    .tl-line.active{background:var(--color-accent)}
  </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors" id="body">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1>Juzgado de Ejecución Penal N°2</h1>
      <p id="view-title">Sistema de Gestión Integral de Legajos</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="nav-legajos" class="btn-primary">Legajos</button>
      <button id="nav-beneficios" class="btn-secondary">Beneficios</button>
      <button id="authBtn" class="btn-primary">Iniciar Sesión</button>
    </div>
  </header>

  <main id="app" class="space-y-6">
    <section id="view-legajos">
      <div class="relief-border p-4 bg-white">
        <div class="overflow-x-auto">
          <table class="w-full text-left text-base">
            <thead class="text-xs uppercase bg-gray-50">
              <tr><th class="px-4 py-2">ID Legajo</th><th class="px-4 py-2">Prontuario</th><th class="px-4 py-2">Nombre</th><th class="px-4 py-2">Defensor</th><th class="px-4 py-2">Estado</th><th class="px-4 py-2">Fin Condena</th></tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Detalle Legajo -->
  <div id="legajoDetailModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="modal p-6 w-[1040px] max-w-full overflow-y-auto max-h-[95vh]">
      <div class="flex justify-between items-center mb-4">
        <h2 id="detailTitle" class="text-xl font-bold">Detalle de Legajo</h2>
        <div class="flex items-center gap-2">
          <button id="editLegajoBtn" class="btn-secondary hidden">Modificar</button>
          <button id="deleteLegajoBtn" class="btn-danger hidden">Eliminar</button>
          <button id="closeDetail" class="btn-secondary">Cerrar</button>
        </div>
      </div>
      <div class="border-b mb-4 flex gap-4 text-base">
        <button class="tab-btn font-medium" data-tab="info">Datos del Legajo</button>
        <button class="tab-btn" data-tab="sentencias">Sentencias</button>
        <button class="tab-btn" data-tab="computo">Cómputo</button>
        <button class="tab-btn" data-tab="tramites">Trámites/Beneficios</button>
      </div>
      <div id="tab-content" class="space-y-4"></div>
    </div>
  </div>

  <script>
    const googleWebAppUrl = 'https://script.google.com/macros/s/REEMPLAZAR/exec';
    const PASSWORD = '454545';
    let allData={legajos:[],sentencias:[],beneficios:[],tramitesVarios:[]};
    let isAuthenticated=false;
    let currentLegajoId=null;

    const $=sel=>document.querySelector(sel);
    const $$=sel=>document.querySelectorAll(sel);

    async function fetchData(){const res=await fetch(googleWebAppUrl);allData=await res.json();renderLegajosTable(allData.legajos||[]);}
    async function postData(payload){
      if(!isAuthenticated){alert('Debes iniciar sesión');return;}
      await fetch(googleWebAppUrl,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'data='+encodeURIComponent(JSON.stringify({...payload,password:PASSWORD}))});
      await fetchData();
      if(currentLegajoId)openLegajoDetail(currentLegajoId);
    }

    function renderLegajosTable(legajos){
      const tbody=$('#legajosTableBody');tbody.innerHTML='';
      (legajos||[]).forEach(l=>{
        const tr=document.createElement('tr');
        tr.className='border-b hover:bg-gray-50 cursor-pointer';
        tr.innerHTML=`<td class='px-4 py-3'>${l.id_legajo}</td><td class='px-4 py-3'>${l.nro_prontuario||''}</td><td class='px-4 py-3'>${l.nombre_completo||''}</td><td class='px-4 py-3'>${l.defensor_actual||''}</td><td class='px-4 py-3'>${l.estado_computo||''}</td><td class='px-4 py-3'>${l.fecha_fin_condena||''}</td>`;
        tr.onclick=()=>openLegajoDetail(l.id_legajo);
        tbody.appendChild(tr);
      });
    }

    function openLegajoDetail(id){
      currentLegajoId=id;
      const leg=allData.legajos.find(x=>x.id_legajo==id)||{};
      $('#detailTitle').textContent=`${leg.nombre_completo||'Legajo'} — ${id}`;
      if(isAuthenticated){$('#deleteLegajoBtn').classList.remove('hidden');$('#editLegajoBtn').classList.remove('hidden');} else {$('#deleteLegajoBtn').classList.add('hidden');$('#editLegajoBtn').classList.add('hidden');}
      const tabContent=$('#tab-content');

      function renderTimeline(){
        let fechas={};try{fechas=JSON.parse(leg.fechas_clave_json||'{}');}catch(e){}
        const steps=[{key:'solicitudSPP',label:'SPP'},{key:'computoProvisorio',label:'Provisorio'},{key:'envioDefensoria',label:'Defensoría'},{key:'envioFiscalia',label:'Fiscalía'},{key:'autoAprobacion',label:'Aprobado'}];
        const html=`<div class='timeline'>${steps.map((s,i)=>`<div class='tl-step'><div class='tl-dot ${fechas[s.key]?'active':''}'></div><div class='text-xs'>${s.label}</div><div class='text-[11px] ${fechas[s.key]?'':'text-gray-400'}'>${fechas[s.key]?new Date(fechas[s.key]).toLocaleDateString():'—'}</div></div>${i<steps.length-1?`<div class='tl-line ${fechas[s.key]?'active':''}'></div>`:''}`).join('')}</div>`;
        return html;
      }

      function renderInfoTab(){
        tabContent.innerHTML=`<div class='grid grid-cols-2 gap-4'>
          <div><label>Prontuario</label><input id='editProntuario' disabled value='${leg.nro_prontuario||''}' class='w-full border rounded px-2 py-1'></div>
          <div><label>Nombre</label><input id='editNombre' disabled value='${leg.nombre_completo||''}' class='w-full border rounded px-2 py-1'></div>
          <div><label>Defensor</label><input id='editDefensor' disabled value='${leg.defensor_actual||''}' class='w-full border rounded px-2 py-1'></div>
          <div><label>Fiscal</label><input id='editFiscal' disabled value='${leg.fiscal_actual||''}' class='w-full border rounded px-2 py-1'></div>
        </div>
        <div class='mt-3 flex justify-end'><button id='saveLegajoBtn' class='btn-primary hidden'>Guardar</button></div>`;
        $('#editLegajoBtn').onclick=()=>{if(confirm('¿Seguro que quieres modificar este legajo?')){['#editProntuario','#editNombre','#editDefensor','#editFiscal'].forEach(sel=>$(sel).disabled=false);$('#saveLegajoBtn').classList.remove('hidden');}};
        $('#saveLegajoBtn').onclick=async()=>{
          if(!confirm('¿Seguro de guardar los cambios?'))return;
          const btn=$('#saveLegajoBtn');btn.textContent='Guardando datos...';btn.disabled=true;
          await postData({action:'updateLegajoField',id_legajo:id,field:'nro_prontuario',value:$('#editProntuario').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'nombre_completo',value:$('#editNombre').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'defensor_actual',value:$('#editDefensor').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'fiscal_actual',value:$('#editFiscal').value});
          alert('Datos guardados con éxito');
          btn.textContent='Guardar';btn.disabled=false;['#editProntuario','#editNombre','#editDefensor','#editFiscal'].forEach(sel=>$(sel).disabled=true);btn.classList.add('hidden');
        };
      }

      function renderComputoTab(){tabContent.innerHTML=renderTimeline()+`${isAuthenticated?`<div class='mt-4 flex gap-2'><button class='btn-secondary' onclick=\"updateEstadoYFecha('${id}','Pendiente SPP','solicitudSPP')\">Marcar SPP</button><button class='btn-secondary' onclick=\"updateEstadoYFecha('${id}','Provisorio','computoProvisorio')\">Marcar Provisorio</button><button class='btn-secondary' onclick=\"updateEstadoYFecha('${id}','Enviado a Defensoría','envioDefensoria')\">Enviar Defensoría</button><button class='btn-secondary' onclick=\"updateEstadoYFecha('${id}','Enviado a Fiscalía','envioFiscalia')\">Enviar Fiscalía</button><button class='btn-primary' onclick=\"updateEstadoYFecha('${id}','Aprobado','autoAprobacion')\">Aprobar</button></div>`:''}`;}

      $$('.tab-btn').forEach(btn=>{btn.classList.remove('font-medium');btn.onclick=()=>{$$('.tab-btn').forEach(b=>b.classList.remove('font-medium'));btn.classList.add('font-medium');if(btn.dataset.tab==='info')renderInfoTab();if(btn.dataset.tab==='computo')renderComputoTab();};});
      $('.tab-btn[data-tab=\"info\"]').click();

      $('#deleteLegajoBtn').onclick=()=>{if(confirm('¿Eliminar legajo completo?'))postData({action:'deleteLegajoCompleto',id_legajo:id});};
      $('#closeDetail').onclick=()=>$('#legajoDetailModal').style.display='none';
      $('#legajoDetailModal').style.display='flex';
    }

    window.updateEstadoYFecha=async function(id,newState,key){
      await postData({action:'updateComputoEstado',id_legajo:id,newState});
      let leg=allData.legajos.find(x=>x.id_legajo==id)||{};let fechas={};try{fechas=JSON.parse(leg.fechas_clave_json||'{}');}catch(e){}
      fechas[key]=new Date().toISOString();
      await postData({action:'updateLegajoField',id_legajo:id,field:'fechas_clave_json',value:JSON.stringify(fechas)});
      openLegajoDetail(id);
    }

    fetchData();
  </script>
</body>
</html>


<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n Integral de Legajos - Juzgado de Ejecuci√≥n Penal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:'Inter',sans-serif;}
    .relief-border{border:1px solid #d1d5db;border-radius:12px}
    .card-drag{user-select:none}

    :root{--color-primary:#1e3a8a;--color-secondary:#f3f4f6;--color-accent:#2563eb}
    header{background:var(--color-primary);color:white;padding:1rem 1.5rem;border-radius:0.75rem}
    header h1{font-size:1.75rem;font-weight:700}
    button{transition:all .2s ease}
    button:hover{opacity:.95}
    .btn-primary{background:var(--color-accent);color:white;padding:0.6rem 1rem;border-radius:0.6rem;font-weight:600}
    .btn-secondary{background:var(--color-secondary);color:#111827;padding:0.6rem 1rem;border-radius:0.6rem;font-weight:600}
    .btn-danger{background:#dc2626;color:white;padding:0.6rem 1rem;border-radius:0.6rem;font-weight:600}

    .tab-btn{padding:0.6rem 1rem;border-radius:.5rem}
    .tab-btn.font-medium{border-bottom:3px solid var(--color-accent)}

    .modal{background:white;border-radius:0.9rem;box-shadow:0 16px 40px rgba(0,0,0,.18)}

    .dark{background:#0f172a;color:#e5e7eb}
    .dark header{background:#0b1222;color:#e5e7eb}
    .dark .relief-border{border-color:#1f2937;background:#0b1222}
    .dark table{color:#e5e7eb}
    .dark .modal{background:#0b1222;color:#e5e7eb}

    .timeline{display:flex;align-items:center;gap:14px}
    .tl-step{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:88px}
    .tl-dot{width:14px;height:14px;border-radius:9999px;background:#d1d5db;transition:background .3s}
    .tl-dot.active{background:var(--color-accent)}
    .tl-line{flex:1;height:3px;background:#d1d5db;transition:background .3s}
    .tl-line.active{background:var(--color-accent)}
  </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors" id="body">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1>Juzgado de Ejecuci√≥n Penal N¬∞2</h1>
      <p id="view-title">Sistema de Gesti√≥n Integral de Legajos</p>
    </div>
    <div class="flex items-center gap-2 sm:gap-3">
      <button id="nav-legajos" class="btn-primary">Legajos</button>
      <button id="nav-beneficios" class="btn-secondary">Beneficios</button>
      <button id="settingsBtn" class="btn-secondary" title="Configuraci√≥n">‚öôÔ∏è</button>
      <button id="themeToggle" class="btn-secondary" title="Modo claro/oscuro">üåô</button>
      <button id="authBtn" class="btn-primary">Iniciar Sesi√≥n</button>
    </div>
  </header>

  <main id="app" class="space-y-6">
    <!-- ===== Vista Legajos ===== -->
    <section id="view-legajos">
      <div class="relief-border p-4 bg-white">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <input id="searchLegajosInput" placeholder="Buscar por prontuario o nombre..." class="border px-3 py-2 rounded w-full sm:w-1/3">
          <div class="flex items-center gap-2">
            <button id="addSentenceBtn" class="btn-primary hidden">+ Ingresar Sentencia</button>
            <button id="newBeneficioBtn" class="btn-secondary hidden">+ Nuevo Beneficio</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-base">
            <thead class="text-xs uppercase bg-gray-50">
              <tr>
                <th class="px-4 py-2">ID Legajo</th>
                <th class="px-4 py-2">Prontuario</th>
                <th class="px-4 py-2">Nombre</th>
                <th class="px-4 py-2">Defensor</th>
                <th class="px-4 py-2">Estado</th>
                <th class="px-4 py-2">Fin Condena</th>
              </tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ===== Vista Beneficios (Kanban + Chart) ===== -->
    <section id="view-beneficios" class="hidden">
      <div class="relief-border p-4 bg-white mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><h3 class="text-sm text-gray-500">Total Activos</h3><p id="total-activos" class="text-2xl font-bold">0</p></div>
        <div><h3 class="text-sm text-gray-500">Tiempo Promedio en Gabinete</h3><p id="avg-time" class="text-2xl font-bold">‚Äî</p></div>
        <div class="flex justify-end"><button id="refreshBtn" class="btn-primary">Actualizar</button></div>
      </div>
      <div id="kanban-board" class="relief-border p-4 bg-white"></div>
      <div id="chart-container" class="relief-border p-4 bg-white mt-4"><canvas id="benefitsChart" height="120"></canvas></div>
    </section>
  </main>

  <!-- ===== Modales ===== -->
  <!-- Login -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="modal p-6 w-96">
      <h2 class="text-lg font-bold mb-3">Acceso de Administrador</h2>
      <form id="loginForm" class="space-y-3">
        <input id="password" type="password" placeholder="Contrase√±a" class="w-full border px-3 py-2 rounded" required>
        <div class="flex justify-end gap-2"><button type="button" id="cancelLoginBtn" class="btn-secondary">Cancelar</button><button class="btn-primary">Ingresar</button></div>
      </form>
    </div>
  </div>

  <!-- Configuraci√≥n de tema/colores -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="modal p-6 w-[520px]">
      <div class="flex justify-between items-center mb-3"><h2 class="text-lg font-bold">Configuraci√≥n de Interfaz</h2><button id="closeSettings" class="btn-secondary">Cerrar</button></div>
      <div class="grid grid-cols-2 gap-4">
        <label class="text-sm">Color Primario (encabezado)<input id="colorPrimary" type="color" class="w-full h-10 border rounded mt-1" value="#1e3a8a"></label>
        <label class="text-sm">Color de Acci√≥n (botones)<input id="colorAccent" type="color" class="w-full h-10 border rounded mt-1" value="#2563eb"></label>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="flex items-center gap-2"><input id="darkToggle" type="checkbox"><label for="darkToggle" class="text-sm">Usar modo oscuro</label></div>
        <div class="flex gap-2"><button id="resetTheme" class="btn-secondary">Restablecer</button><button id="saveTheme" class="btn-primary">Guardar</button></div>
      </div>
    </div>
  </div>

  <!-- Ingresar Sentencia -->
  <div id="ingresarSentenciaModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Ingresar Nueva Sentencia</h2>
      <form id="ingresarSentenciaForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm">ID Legajo (si existe)</label><input name="id_legajo" class="w-full border px-2 py-2 rounded" placeholder="Dejar vac√≠o para crear legajo nuevo"></div>
          <div><label class="text-sm">N¬∞ Causa</label><input name="nro_causa" class="w-full border px-2 py-2 rounded" required></div>
          <div><label class="text-sm">Fecha Sentencia</label><input name="fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Delito</label><input name="delito" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Pena impuesta</label><input name="pena_impuesta" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Enlace Sentencia (opcional)</label><input name="enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded"></div>
          <div class="col-span-2 flex items-center gap-3"><input id="es_unificada" name="es_unificada" type="checkbox"><label for="es_unificada" class="text-sm">Es sentencia unificada</label></div>
        </div>
        <div class="flex justify-end gap-2"><button type="button" id="cancelIngresoBtn" class="btn-secondary">Cancelar</button><button type="submit" class="btn-primary">Guardar Sentencia</button></div>
      </form>
    </div>
  </div>

  <!-- Detalle de Legajo con pesta√±as -->
  <div id="legajoDetailModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="modal p-6 w-[1040px] max-w-full overflow-y-auto max-h-[95vh]">
      <div class="flex justify-between items-center mb-4">
        <h2 id="detailTitle" class="text-xl font-bold">Detalle de Legajo</h2>
        <div class="flex items-center gap-2">
          <button id="editLegajoBtn" class="btn-secondary hidden">Modificar</button>
          <button id="deleteLegajoBtn" class="btn-danger hidden">Eliminar</button>
          <button id="closeDetail" class="btn-secondary">Cerrar</button>
        </div>
      </div>
      <div class="border-b mb-4 flex gap-4 text-base">
        <button class="tab-btn font-medium" data-tab="info">Datos del Legajo</button>
        <button class="tab-btn" data-tab="sentencias">Sentencias</button>
        <button class="tab-btn" data-tab="computo">C√≥mputo</button>
        <button class="tab-btn" data-tab="tramites">Tr√°mites/Beneficios</button>
      </div>
      <div id="tab-content" class="space-y-4"></div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const googleWebAppUrl = 'https://script.google.com/macros/s/AKfycbzRQ69juuFx3HjRTRlG3pLT19tKZMb0XHJJyPIOqrYHiVNsSkcvBF2jIyVmCZZwTq6P/exec';
    const PASSWORD = '454545';

    let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
    let isAuthenticated = false;
    let currentLegajoId = null;

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    // ===== THEME / SETTINGS =====
    function applyThemeFromStorage(){
      const p = localStorage.getItem('theme_primary');
      const a = localStorage.getItem('theme_accent');
      const d = localStorage.getItem('theme_dark')==='1';
      if(p) document.documentElement.style.setProperty('--color-primary', p);
      if(a) document.documentElement.style.setProperty('--color-accent', a);
      if(d) document.getElementById('body').classList.add('dark');
    }

    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const bodyEl=document.getElementById('body');
      bodyEl.classList.toggle('dark');
      localStorage.setItem('theme_dark', bodyEl.classList.contains('dark')?'1':'0');
    });

    document.getElementById('settingsBtn').onclick = ()=>{
      document.getElementById('settingsModal').style.display='flex';
      document.getElementById('colorPrimary').value = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#1e3a8a';
      document.getElementById('colorAccent').value = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim() || '#2563eb';
      document.getElementById('darkToggle').checked = document.getElementById('body').classList.contains('dark');
    }
    document.getElementById('closeSettings').onclick = ()=> document.getElementById('settingsModal').style.display='none';
    document.getElementById('resetTheme').onclick = ()=>{
      localStorage.removeItem('theme_primary');
      localStorage.removeItem('theme_accent');
      localStorage.removeItem('theme_dark');
      document.documentElement.style.setProperty('--color-primary','#1e3a8a');
      document.documentElement.style.setProperty('--color-accent','#2563eb');
      document.getElementById('body').classList.remove('dark');
    }
    document.getElementById('saveTheme').onclick = ()=>{
      const p = document.getElementById('colorPrimary').value;
      const a = document.getElementById('colorAccent').value;
      const d = document.getElementById('darkToggle').checked;
      document.documentElement.style.setProperty('--color-primary', p);
      document.documentElement.style.setProperty('--color-accent', a);
      localStorage.setItem('theme_primary', p);
      localStorage.setItem('theme_accent', a);
      localStorage.setItem('theme_dark', d?'1':'0');
      const bodyEl=document.getElementById('body'); d? bodyEl.classList.add('dark'): bodyEl.classList.remove('dark');
      document.getElementById('settingsModal').style.display='none';
    }

    // ===== NAV =====
    document.getElementById('nav-legajos').onclick = ()=>{ document.getElementById('view-legajos').classList.remove('hidden'); document.getElementById('view-beneficios').classList.add('hidden'); };
    document.getElementById('nav-beneficios').onclick = ()=>{ document.getElementById('view-legajos').classList.add('hidden'); document.getElementById('view-beneficios').classList.remove('hidden'); };

    // ===== AUTH =====
    const authBtn = document.getElementById('authBtn');
    const loginModal = document.getElementById('loginModal');
    authBtn.onclick = ()=>{ if(isAuthenticated){ isAuthenticated=false; authBtn.textContent='Iniciar Sesi√≥n'; document.querySelectorAll('#addSentenceBtn,#newBeneficioBtn').forEach(b=>b.classList.add('hidden')); } else { loginModal.style.display='flex'; } };
    document.getElementById('cancelLoginBtn').onclick = ()=> loginModal.style.display='none';
    document.getElementById('loginForm').onsubmit = (e)=>{ e.preventDefault(); if(document.getElementById('password').value===PASSWORD){ isAuthenticated=true; authBtn.textContent='Cerrar Sesi√≥n'; loginModal.style.display='none'; document.querySelectorAll('#addSentenceBtn,#newBeneficioBtn').forEach(b=>b.classList.remove('hidden')); } else alert('Contrase√±a incorrecta'); };

    // ===== DATA =====
    async function fetchData(){
      try{ const res = await fetch(googleWebAppUrl); allData = await res.json(); renderLegajosTable(allData.legajos||[]); renderBoard(allData.beneficios||[]); renderChart(allData.beneficios||[]); calcStats(allData.beneficios||[]); }
      catch(e){ console.error(e); }
    }

    async function postData(payload){
      if(!isAuthenticated){ alert('Debes iniciar sesi√≥n'); return; }
      try{ await fetch(googleWebAppUrl,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'data='+encodeURIComponent(JSON.stringify({...payload,password:PASSWORD})) }); await fetchData(); if(currentLegajoId) openLegajoDetail(currentLegajoId); }
      catch(e){ console.error('post error',e); alert('Error al enviar datos'); }
    }

    // ===== Buscador =====
    document.getElementById('searchLegajosInput').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#legajosTableBody tr');
      rows.forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none'; });
    });

    // ===== Tabla Legajos =====
    function renderLegajosTable(legajos){
      const tbody=document.getElementById('legajosTableBody');
      tbody.innerHTML='';
      (legajos||[]).forEach(l=>{
        const tr=document.createElement('tr');
        tr.className='border-b hover:bg-gray-50 cursor-pointer';
        tr.innerHTML=`<td class='px-4 py-3'>${l.id_legajo}</td>
                       <td class='px-4 py-3'>${l.nro_prontuario||''}</td>
                       <td class='px-4 py-3'>${l.nombre_completo||''}</td>
                       <td class='px-4 py-3'>${l.defensor_actual||''}</td>
                       <td class='px-4 py-3'>${l.estado_computo||''}</td>
                       <td class='px-4 py-3'>${l.fecha_fin_condena||''}</td>`;
        tr.onclick=()=>openLegajoDetail(l.id_legajo);
        tbody.appendChild(tr);
      });
    }

    // ===== Kanban Beneficios =====
    const KANBAN_COLUMNS = ['Ingresado','En Gabinete','Regreso','Fiscal√≠a','Defensor√≠a','Para Despacho','Finalizado'];
    const statusDateMap = {
      'Ingresado': null,
      'En Gabinete': 'fechaEnvioGabinete',
      'Regreso': 'fechaRegresoGabinete',
      'Fiscal√≠a': 'fechaEnvioFiscalia',
      'Defensor√≠a': 'fechaEnvioDefensoria',
      'Para Despacho': 'fechaDespacho',
      'Finalizado': 'fechaFinalizado'
    };

    function renderBoard(beneficios){
      const board = document.getElementById('kanban-board'); if(!board) return;
      board.innerHTML='';
      const container = document.createElement('div'); container.className='grid grid-cols-1 md:grid-cols-3 gap-4';
      KANBAN_COLUMNS.forEach(status=>{
        const col=document.createElement('div'); col.className='p-3 relief-border bg-white';
        col.innerHTML = `<h3 class='font-semibold mb-2'>${status}</h3><div class='card-container min-h-[140px]' data-status='${status}' ondragover='event.preventDefault()'></div>`;
        container.appendChild(col);
      });
      board.appendChild(container);

      (beneficios||[]).forEach(b=>{
        const list = board.querySelector(`.card-container[data-status="${b.estado}"]`);
        if(list){ const card=document.createElement('div'); card.className='p-3 mb-2 border rounded bg-white card-drag'; card.draggable=true; card.dataset.id=b.id_beneficio_legajo||b.id; card.innerHTML=`<div class='font-medium'>${b.interno||''}</div><div class='text-xs'>${b.expediente||''} ‚Ä¢ ${b.beneficio||''}</div>`; card.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',card.dataset.id)}); list.appendChild(card);} });

      board.querySelectorAll('.card-container').forEach(c=> c.addEventListener('drop', async e=>{
        e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); const card=document.querySelector(`[data-id="${id}"]`); if(card){ c.appendChild(card); const newStatus=c.dataset.status; await postData({ action:'updateBeneficioStatus', id_beneficio_legajo:id, newStatus }); // servidor puede setear fechaXStatus
          // opcional: si tu planilla usa nombres exactos del mapa, descomenta para forzar fecha
          // const dateField = statusDateMap[newStatus]; if(dateField){ await postData({ action:'updateBeneficioField', id_beneficio_legajo:id, field:dateField, value:(new Date()).toISOString() }); }
        }
      }));
    }

    function calcStats(beneficios){
      document.getElementById('total-activos').textContent = (beneficios||[]).filter(b=>b.estado!=='Finalizado').length;
      // (Placeholder) C√°lculo de promedio ‚Äî si necesitas exactitud, traer fechas y computar diferencia
      document.getElementById('avg-time').textContent = '‚Äî';
    }

    let chartInstance=null;
    function renderChart(beneficios){
      const el = document.getElementById('benefitsChart'); if(!el) return; const ctx = el.getContext('2d');
      const counts={}; (beneficios||[]).forEach(b=> counts[b.beneficio]=(counts[b.beneficio]||0)+1);
      const labels=Object.keys(counts), data=labels.map(l=>counts[l]);
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx,{ type:'bar', data:{ labels, datasets:[{ label:'Beneficios por tipo', data }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
    }

    // ===== Ingreso de Sentencia =====
    document.getElementById('addSentenceBtn').onclick = ()=> document.getElementById('ingresarSentenciaModal').style.display='flex';
    document.getElementById('cancelIngresoBtn').onclick = ()=> document.getElementById('ingresarSentenciaModal').style.display='none';
    document.getElementById('ingresarSentenciaForm').onsubmit = (e)=>{
      e.preventDefault(); const fd=new FormData(e.target); const payload=Object.fromEntries(fd.entries()); payload.es_unificada = fd.has('es_unificada'); payload.action = payload.id_legajo? 'addSentencia' : 'addLegajoYsentencia'; postData(payload); document.getElementById('ingresarSentenciaModal').style.display='none'; };

    // ===== Detalle Legajo + Pesta√±as =====
    const detailModal = document.getElementById('legajoDetailModal');
    document.getElementById('closeDetail').onclick = ()=> detailModal.style.display='none';

    function getLegajoById(id){ return (allData.legajos||[]).find(x=>x.id_legajo==id) || {}; }

    function openLegajoDetail(id){
      currentLegajoId=id;
      const leg = getLegajoById(id);
      const sent = (allData.sentencias||[]).filter(s=>s.id_legajo==id);
      const ben = (allData.beneficios||[]).filter(b=>b.id_legajo==id);
      const tram = (allData.tramitesVarios||[]).filter(t=>t.id_legajo==id);

      document.getElementById('detailTitle').textContent = `${leg.nombre_completo||'Legajo'} ‚Äî ${id}`;
      if(isAuthenticated){ document.getElementById('deleteLegajoBtn').classList.remove('hidden'); document.getElementById('editLegajoBtn').classList.remove('hidden'); }
      else { document.getElementById('deleteLegajoBtn').classList.add('hidden'); document.getElementById('editLegajoBtn').classList.add('hidden'); }

      const tabContent = document.getElementById('tab-content');

      function renderTimeline(){
        let fechas = {}; try{ fechas = JSON.parse(leg.fechas_clave_json||'{}'); }catch(e){}
        const steps = [
          { key:'solicitudSPP', label:'SPP/Defensor'},
          { key:'computoProvisorio', label:'Provisorio'},
          { key:'envioDefensoria', label:'Defensor√≠a'},
          { key:'envioFiscalia', label:'Fiscal√≠a'},
          { key:'autoAprobacion', label:'Aprobaci√≥n'}
        ];
        return `<div class="timeline">${steps.map((s,i)=>`
          <div class="tl-step">
            <div class="tl-dot ${fechas[s.key]?'active':''}"></div>
            <div class="text-xs text-center">${s.label}</div>
            <div class="text-[11px] ${fechas[s.key]?'':'text-gray-400'}">${fechas[s.key]? new Date(fechas[s.key]).toLocaleDateString(): '‚Äî'}</div>
          </div>
          ${i<steps.length-1?`<div class="tl-line ${fechas[s.key]?'active':''}"></div>`:''}
        `).join('')}</div>`
      }

      function renderInfoTab(){
        tabContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="text-sm">ID Legajo</label><input value="${leg.id_legajo||''}" disabled class="w-full border rounded px-3 py-2 bg-gray-50"></div>
            <div><label class="text-sm">N¬∞ Prontuario</label><input id="editProntuario" value="${leg.nro_prontuario||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Nombre Completo</label><input id="editNombre" value="${leg.nombre_completo||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Defensor Actual</label><input id="editDefensor" value="${leg.defensor_actual||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Fiscal Actual</label><input id="editFiscal" value="${leg.fiscal_actual||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Estado C√≥mputo</label>
              <select id="editEstado" class="w-full border rounded px-3 py-2" disabled>
                ${['Pendiente SPP','Provisorio','Enviado a Defensor√≠a','Enviado a Fiscal√≠a','Aprobado','Observado'].map(v=>`<option ${v===(leg.estado_computo||'')?'selected':''}>${v}</option>`).join('')}
              </select>
            </div>
            <div><label class="text-sm">Fecha Fin Condena</label><input id="editFin" type="date" value="${(leg.fecha_fin_condena||'').slice(0,10)}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Link C√≥mputo</label><input id="editLink" type="url" value="${leg.link_computo||''}" class="w-full border rounded px-3 py-2" disabled></div>
          </div>
          <div class="mt-5">
            <h3 class="font-semibold mb-2">L√≠nea de tiempo del c√≥mputo</h3>
            ${renderTimeline()}
            ${isAuthenticated?`
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mt-3">
              <button class="btn-secondary" onclick="setFechaClave('${id}','solicitudSPP')">Marcar SPP</button>
              <button class="btn-secondary" onclick="setFechaClave('${id}','computoProvisorio')">Marcar Provisorio</button>
              <button class="btn-secondary" onclick="updateEstadoYFecha('${id}','Enviado a Defensor√≠a','envioDefensoria')">Enviar Defensor√≠a</button>
              <button class="btn-secondary" onclick="updateEstadoYFecha('${id}','Enviado a Fiscal√≠a','envioFiscalia')">Enviar Fiscal√≠a</button>
              <button class="btn-primary" onclick="updateEstadoYFecha('${id}','Aprobado','autoAprobacion')">Aprobar</button>
            </div>`:''}
          </div>
          ${isAuthenticated?`<div class="mt-5 flex justify-end gap-2">
            <button id="saveLegajoBtn" class="btn-primary hidden">Guardar</button>
          </div>`:''}
        `;

        // Bot√≥n Modificar ‚Äî desbloquea campos con confirmaci√≥n
        document.getElementById('editLegajoBtn').onclick = ()=>{
          if(!isAuthenticated) return alert('Inicia sesi√≥n');
          if(confirm('¬øSeguro que quieres modificar este legajo?')){
            ['#editProntuario','#editNombre','#editDefensor','#editFiscal','#editEstado','#editFin','#editLink'].forEach(sel=>{ const el=document.querySelector(sel); if(el) el.disabled=false; });
            document.getElementById('saveLegajoBtn').classList.remove('hidden');
          }
        }

        // Guardar con confirmaci√≥n y estado del bot√≥n
        document.getElementById('saveLegajoBtn').onclick = async()=>{
          if(!confirm('¬øSeguro de guardar los cambios?')) return;
          const btn=document.getElementById('saveLegajoBtn'); btn.textContent='Guardando datos...'; btn.disabled=true;
          await postData({action:'updateLegajoField',id_legajo:id,field:'nro_prontuario',value:document.getElementById('editProntuario').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'nombre_completo',value:document.getElementById('editNombre').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'defensor_actual',value:document.getElementById('editDefensor').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'fiscal_actual',value:document.getElementById('editFiscal').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'estado_computo',value:document.getElementById('editEstado').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'fecha_fin_condena',value:document.getElementById('editFin').value});
          await postData({action:'updateLegajoField',id_legajo:id,field:'link_computo',value:document.getElementById('editLink').value});
          alert('Datos guardados con √©xito');
          btn.textContent='Guardar'; btn.disabled=false;
          ['#editProntuario','#editNombre','#editDefensor','#editFiscal','#editEstado','#editFin','#editLink'].forEach(sel=>{ const el=document.querySelector(sel); if(el) el.disabled=true; });
          btn.classList.add('hidden');
        }
      }

      function renderSentenciasTab(){
        tabContent.innerHTML = sent.length ? sent.map(s=>`<div class='p-3 border rounded flex items-center justify-between'>
          <div>
            <div class='font-medium'>Causa ${s.nro_causa}</div>
            <div class='text-sm text-gray-600'>${s.delito} ‚Ä¢ ${s.pena_impuesta} ‚Ä¢ ${s.fecha_sentencia}</div>
          </div>
          ${s.enlace_sentencia?`<a class='btn-secondary' target='_blank' href='${s.enlace_sentencia}'>Ver</a>`:''}
        </div>`).join('') : '<div class="text-sm text-gray-500">Sin sentencias.</div>';
      }

      function renderComputoTab(){ tabContent.innerHTML = renderTimeline() + `${isAuthenticated?`<div class='mt-4 flex flex-wrap gap-2'>
        <button class='btn-secondary' onclick="updateEstadoYFecha('${id}','Pendiente SPP','solicitudSPP')">Marcar SPP</button>
        <button class='btn-secondary' onclick="updateEstadoYFecha('${id}','Provisorio','computoProvisorio')">Marcar Provisorio</button>
        <button class='btn-secondary' onclick="updateEstadoYFecha('${id}','Enviado a Defensor√≠a','envioDefensoria')">Enviar Defensor√≠a</button>
        <button class='btn-secondary' onclick="updateEstadoYFecha('${id}','Enviado a Fiscal√≠a','envioFiscalia')">Enviar Fiscal√≠a</button>
        <button class='btn-primary' onclick="updateEstadoYFecha('${id}','Aprobado','autoAprobacion')">Aprobar</button>
      </div>`:''}`; }

      function renderTramitesTab(){
        const all = ben.concat(tram);
        tabContent.innerHTML = (all.length? all.map(t=>`<div class='p-3 border rounded'>
          <div class='font-medium'>${t.expediente||t.tipo_tramite||''}</div>
          <div class='text-sm text-gray-600'>${t.beneficio||t.tipo_tramite||''} ‚Ä¢ Estado: ${t.estado||''}</div>
        </div>`).join('') : '<div class="text-sm text-gray-500">Sin tr√°mites/beneficios.</div>');
      }

      // Bind tabs
      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.classList.remove('font-medium');
        btn.onclick=()=>{ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('font-medium')); btn.classList.add('font-medium'); const tab=btn.dataset.tab; if(tab==='info') renderInfoTab(); if(tab==='sentencias') renderSentenciasTab(); if(tab==='computo') renderComputoTab(); if(tab==='tramites') renderTramitesTab(); };
      });
      document.querySelector('.tab-btn[data-tab="info"]').click();

      // Eliminar legajo completo
      document.getElementById('deleteLegajoBtn').onclick = ()=>{
        if(!isAuthenticated) return alert('Inicia sesi√≥n');
        if(confirm('¬øEliminar legajo y TODOS sus registros vinculados? Esta acci√≥n no se puede deshacer.')){
          postData({action:'deleteLegajoCompleto',id_legajo:id});
          detailModal.style.display='none';
        }
      };

      detailModal.style.display='flex';
    }

    // ===== Helpers de fechas clave =====
    window.setFechaClave = async function(id, key){
      const leg = getLegajoById(id);
      let fechas = {}; try{ fechas = JSON.parse(leg.fechas_clave_json||'{}'); }catch(e){}
      fechas[key] = new Date().toISOString();
      await postData({ action:'updateLegajoField', id_legajo:id, field:'fechas_clave_json', value: JSON.stringify(fechas) });
      openLegajoDetail(id);
    }
    window.updateEstadoYFecha = async function(id, newState, key){
      await postData({ action:'updateComputoEstado', id_legajo:id, newState });
      await setFechaClave(id, key);
    }

    // ===== Inicio =====
    applyThemeFromStorage();
    fetchData();
  </script>
</body>
</html>


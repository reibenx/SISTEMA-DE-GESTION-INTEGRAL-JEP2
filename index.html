            &lt;div class="flex justify-end"&gt;&lt;button type="button" id="closeAlertBtn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-xl hover:bg-yellow-600 relief-button"&gt;Entendido&lt;/button&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div id="promptModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-40" role="dialog" aria-modal="true" aria-labelledby="promptTitle"&gt;
        &lt;div class="bg-white rounded-xl p-8 w-full max-w-md transform transition-all dark:bg-gray-800 relief-border modal-content"&gt;
            &lt;h2 id="promptTitle" class="text-2xl font-bold mb-4 dark:text-white"&gt;&lt;/h2&gt;
            &lt;p id="promptMessage" class="text-gray-600 dark:text-gray-300 mb-4"&gt;&lt;/p&gt;
            &lt;input type="text" id="promptInput" class="w-full px-3 py-2 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600"&gt;
            &lt;div class="flex justify-end space-x-4 mt-6"&gt;
                &lt;button type="button" id="cancelPromptBtn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-xl hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500 relief-button"&gt;Cancelar&lt;/button&gt;
                &lt;button type="button" id="confirmPromptBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-xl hover:bg-indigo-700 relief-button"&gt;Confirmar&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-20" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle"&gt;
        &lt;div class="bg-white rounded-xl p-8 w-full max-w-lg transform transition-all dark:bg-gray-800 relief-border modal-content"&gt;
            &lt;h2 id="settingsModalTitle" class="text-2xl font-bold mb-4 dark:text-white"&gt;Configuración&lt;/h2&gt;
&lt;script&gt;
// ----------- CONFIGURACIÓN -----------
const googleWebAppUrl = 'https://script.google.com/macros/s/AKfycbyB3_NG1o_BGWxlY1_JTBRyoUF4Alqf3Jx9naB1hJhCUny-Z1VXiJ208ALBbFc-J40U/exec';

// ¡¡¡ADVERTENCIA DE SEGURIDAD CRÍTICA!!!
// La variable PASSWORD ha sido eliminada. La autenticación NUNCA debe realizarse
// en el código del cliente (frontend). Debe implementarse un sistema de tokens
// donde el servidor (Google Apps Script) valida la contraseña.
const KANBAN_COLUMNS = [
    { status: 'Ingresado', color: 'bg-gray-300', textColor: 'text-gray-800' },
    { status: 'En Gabinete', color: 'bg-yellow-300', textColor: 'text-yellow-800' },
document.addEventListener('DOMContentLoaded', () =&gt; {
    // --- ESTADO GLOBAL ---
    let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
    let sessionToken = null; // Reemplaza a 'isAuthenticated'. Si hay token, está autenticado.
    let benefitsChart = null;
    let currentLegajoId = null;
    let caseIdToFinalize = null;
    const cancelLoginBtn = document.getElementById('cancelLoginBtn');
    const headerSubtitle = document.getElementById('header-subtitle');
    const ingresarSentenciaForm = document.getElementById('ingresarSentenciaForm');
    const loginError = document.getElementById('loginError');
    const searchInternoInput = document.getElementById('searchInternoInput');
    const searchResults = document.getElementById('searchResults');
    const createNewLegajoBtn = document.getElementById('createNewLegajoBtn');
    const stateDateContainer = document.getElementById('stateDateContainer');
    const stateDateEditLabel = document.getElementById('stateDateEditLabel');
    const stateDateEdit = document.getElementById('stateDateEdit');
    const stateDateField = document.getElementById('stateDateField');
    const promptModal = document.getElementById('promptModal');
    const promptTitle = document.getElementById('promptTitle');
    const promptMessage = document.getElementById('promptMessage');
    const promptInput = document.getElementById('promptInput');
    
    // --- NAVEGACIÓN ---
    function showView(viewName) {
        }
    }

    // --- DATOS ---
    async function fetchData() {
        setConnectionStatus('connecting');
        }
    }
    
    async function postData(payload) {
        if (!sessionToken) {
            showAlert('Acción no permitida', 'Debes iniciar sesión para realizar cambios.');
            return Promise.reject(new Error('Not authenticated'));
        }
        setConnectionStatus('connecting', 'Guardando...');
        try {
            // En una aplicación real, el token se enviaría de forma segura,
            // por ejemplo, en la cabecera 'Authorization'.
            // El backend (Google Apps Script) validaría este token.
            const response = await fetch(googleWebAppUrl, {
                method: 'POST',
                mode: 'no-cors', // 'no-cors' limita la respuesta, pero es necesario para el setup actual de Google Apps Script.
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ ...payload, token: sessionToken }), // Se envía el token, no la contraseña.
            });
            // Como 'no-cors' no permite leer la respuesta, asumimos éxito y recargamos.
            setConnectionStatus('connected', 'Guardado');
            setTimeout(fetchData, 1500);
            return Promise.resolve(); // Indica éxito
        } catch (error) {
            console.error('Error al enviar datos:', error);
            setConnectionStatus('error', 'Fallo al guardar');
            return Promise.reject(error); // Indica fallo
        }
    }

                    updateColumnCounter(caseItem.estado, 1);
                }
            });
        }
        if (sessionToken) setupDragAndDrop();
    }

    function createCardElement(caseItem) {
        }

        let actionButtonsHTML = '';
        if (sessionToken) {
            if (caseItem.estado === 'Finalizado') {
                actionButtonsHTML += `&lt;button class="action-btn archive-btn text-gray-400 dark:text-gray-500" data-id="${caseItem.id_beneficio_legajo}" title="Archivar"&gt;&lt;svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"&gt;&lt;path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z" /&gt;&lt;path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" /&gt;&lt;/svg&gt;&lt;/button&gt;`;
            }
            if (daysInState &gt; 7) card.classList.add('alarm');
        }

        if (sessionToken) {
            card.classList.add('editable', 'draggable');
            card.draggable = true;
            card.tabIndex = 0; // Hace la tarjeta enfocable con el teclado
            card.addEventListener('click', () =&gt; openEditModal(caseItem));
            card.addEventListener('keydown', (e) =&gt; {
                if (e.key === 'Enter' || e.key === ' ') {
                    openEditModal(caseItem);
                }
            });
            card.querySelector('.delete-btn')?.addEventListener('click', (e) =&gt; {
                e.stopPropagation();
                caseIdToDelete = e.currentTarget.dataset.id;
    
    // --- AUTENTICACIÓN ---
    function updateAuthStateUI() {
        const isAuthenticated = !!sessionToken;
        const editableElements = document.querySelectorAll('.edit-field-btn, #addSentenceBtn, #addBeneficioBtn, #addTramiteBtn, #computo-buttons-container button');
        if (isAuthenticated) {
            if(addSentenceBtn) addSentenceBtn.classList.remove('hidden');
            if(addCaseBtn) addCaseBtn.classList.remove('hidden');
                authBtn.classList.replace('bg-green-600', 'bg-red-600');
            }
            if(headerSubtitle) headerSubtitle.textContent = 'Modo de edición activado.';
            editableElements.forEach(el =&gt; el.classList.remove('hidden'));
        } else {
            if(addSentenceBtn) addSentenceBtn.classList.add('hidden');
            if(addCaseBtn) addCaseBtn.classList.add('hidden');
                authBtn.classList.replace('bg-red-600', 'bg-green-600');
            }
            if(headerSubtitle) headerSubtitle.textContent = 'Modo de solo lectura.';
            editableElements.forEach(el =&gt; el.classList.add('hidden'));
        }
        renderBoard(allData.beneficios); // Re-renderiza el tablero para mostrar/ocultar botones y drag-drop
    }

    function handleLogin(e) {
        e.preventDefault();
        const passwordInput = loginForm.querySelector('#password');
        const password = passwordInput.value;
        loginError.classList.add('hidden');

        // --- SIMULACIÓN DE AUTENTICACIÓN ---
        // En una aplicación real, aquí se haría una llamada `fetch` al backend
        // para validar la contraseña y obtener un token.
        // Este código es INSEGURO y solo para demostración.
        if (password === '454545') {
            sessionToken = 'dummy-token-' + Date.now(); // Simula un token de sesión
            loginModal.style.display = 'none';
            passwordInput.value = '';
            updateAuthStateUI();
            showAlert('Sesión Iniciada', 'Modo de edición activado.');
        } else {
            loginError.textContent = 'Contraseña incorrecta.';
            loginError.classList.remove('hidden');
        }
        // --- FIN DE LA SIMULACIÓN ---
    }

    function handleLogout() {
        sessionToken = null;
        updateAuthStateUI();
        showAlert('Sesión Cerrada', 'Has vuelto al modo de solo lectura.');
    }

    function setupEventListeners() {
        navLegajos.addEventListener('click', () =&gt; showView('legajos'));
        navBeneficios.addEventListener('click', () =&gt; showView('beneficios'));
        authBtn.addEventListener('click', () =&gt; sessionToken ? handleLogout() : (loginModal.style.display = 'flex'));
        loginForm.addEventListener('submit', handleLogin);
        cancelLoginBtn.addEventListener('click', () =&gt; loginModal.style.display = 'none');
        closeAlertBtn.addEventListener('click', () =&gt; alertModal.style.display = 'none');
    
    // --- EVENTOS ---
    function resetSentenciaModal() {
        ingresarSentenciaForm.reset();
        existingLegajoIdInput.value = '';
    }

    caseForm.addEventListener('submit', async (e) =&gt; {
        e.preventDefault();
        const formData = new FormData(caseForm);
        }
        caseModal.style.display = 'none';
    });
    
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(content =&gt; content.classList.add('hidden'));
        document.getElementById(tabId).classList.remove('hidden');
        document.querySelector(`.tab-link[data-tab="${tabId}"]`).classList.add('active');
    }

    searchInternoInput.addEventListener('input', (e) =&gt; {
        const searchTerm = e.target.value.toLowerCase();
        ingresarSentenciaModal.style.display = 'none';
    });

    computoButtonsContainer.addEventListener('click', async (e) =&gt; {
        const button = e.target.closest('button[data-action="updateComputo"]');
        if (button) {
            const nuevoEstado = button.dataset.estado;
            if (!sessionToken) {
                showAlert("Autenticación Requerida", "Debe iniciar sesión para poder cambiar el estado del cómputo.");
                return;
            }
            if (!currentLegajoId) return;

            const payload = {
                action: 'updateComputoEstado', 
                id_legajo: currentLegajoId, 
                nuevoEstado: nuevoEstado 
            };

            if (nuevoEstado === 'Aprobado') {
                try {
                    const linkComputo = await showPrompt("Aprobar Cómputo", "Por favor, ingrese el enlace al Auto de Aprobación de Cómputo:");
                    payload.link_computo = linkComputo;
                } catch (error) {
                    // El usuario canceló el prompt
                    showAlert("Acción Cancelada", "No se aprobó el cómputo porque no se proporcionó un enlace.");
                    return; // Detiene la ejecución
                }
            }
            
            await postData(payload);
            document.getElementById('detail-estado_computo').textContent = nuevoEstado;
            styleComputoButtons(nuevoEstado);
        }
    });

    legajoDetailModal.addEventListener('click', (e) =&gt; {
        if (e.target.matches('.tab-link')) {
            showTab(e.target.dataset.tab);
        }
        const button = e.target.closest('.edit-field-btn');
        if (button) {
            if (!sessionToken) return;
            if (legajoDetailModal.querySelector('.inline-edit-wrapper')) return;

            const field = button.dataset.field;
    });

    addBeneficioBtn.addEventListener('click', () =&gt; {
        if (!sessionToken || !currentLegajoId) return;
        const legajo = allData.legajos.find(l =&gt; l.id_legajo === currentLegajoId);
        caseForm.reset();
        document.getElementById('modalTitle').textContent = 'Nuevo Trámite de Beneficio';
    });

    addTramiteBtn.addEventListener('click', () =&gt; {
        if (!sessionToken || !currentLegajoId) return;
        showPrompt("Nuevo Trámite", "Ingrese el tipo de trámite (Ej: Examen Médico):")
            .then(tipo =&gt; {
                if (!tipo) return Promise.reject();
                return showPrompt("Descripción del Trámite", "Ingrese una breve descripción:");
            })
            .then(desc =&gt; {
                postData({ action: 'addTramiteVario', id_legajo: currentLegajoId, tipo_tramite: tipo, descripcion: desc });
            })
            .catch(() =&gt; showAlert("Acción Cancelada", "No se agregó el nuevo trámite."));
    });
    }

    // --- APARIENCIA Y CONFIGURACIÓN ---
    function toggleTheme() {
        });
    }

    // --- UTILIDADES ---
    function setConnectionStatus(status, message) {
        const dot = document.getElementById('connection-dot');
        alertModal.style.display = 'flex';
    }
    
    function showPrompt(title, message) {
        return new Promise((resolve, reject) =&gt; {
            promptTitle.textContent = title;
            promptMessage.textContent = message;
            promptInput.value = '';
            promptModal.style.display = 'flex';
            promptInput.focus();

            const confirmBtn = document.getElementById('confirmPromptBtn');
            const cancelBtn = document.getElementById('cancelPromptBtn');

            const onConfirm = () =&gt; {
                cleanup();
                resolve(promptInput.value);
            };

            const onCancel = () =&gt; {
                cleanup();
                reject(new Error('User cancelled prompt'));
            };

            const cleanup = () =&gt; {
                promptModal.style.display = 'none';
                confirmBtn.removeEventListener('click', onConfirm);
                cancelBtn.removeEventListener('click', onCancel);
            };

            confirmBtn.addEventListener('click', onConfirm);
            cancelBtn.addEventListener('click', onCancel);
        });
    }

    function getContrastColor(hex) {
        if (!hex) return '#000000';
        const r = parseInt(hex.substr(1, 2), 16), g = parseInt(hex.substr(3, 2), 16), b = parseInt(hex.substr(5, 2), 16);
        return (((r * 299) + (g * 587) + (b * 114)) / 1000 &gt;= 128) ? '#000000' : '#ffffff';
    }

    function initializeApp() {
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }
        initializeBoard();
        setupEventListeners();
        fetchData();
        showView('legajos');
        updateAuthStateUI(); // Asegura que la UI refleje el estado inicial (no autenticado)
    }

    initializeApp();
});
&lt;/script&gt;
&lt;/body&gt;


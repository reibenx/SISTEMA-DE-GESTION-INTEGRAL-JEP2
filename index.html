<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión Integral de Legajos - Juzgado de Ejecución Penal</title>

  <!-- Tailwind para prototipado -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --color-primary:#1e3a8a;
      --color-secondary:#f3f4f6;
      --color-accent:#2563eb;

      --light-bg-general:#e5e7eb;
      --light-bg-content:#ffffff;
      --light-text-main:#111827;
      --light-card-bg:#ffffff;
      --light-card-text-main:#111827;
      --light-card-text-secondary:#6b7280;

      --dark-bg-general:#0d1117;
      --dark-bg-content:#161b22;
      --dark-text-main:#f0f6fc;
      --dark-card-bg:#21262d;
      --dark-card-text-main:#f0f6fc;
      --dark-card-text-secondary:#8b949e;
      --dark-border:#30363d;
    }

    html,body{height:100%}
    body{font-family:'Inter',sans-serif;background:#f7f7f8;color:#111827}

    header{background:var(--color-primary);color:white;padding:1rem 1.5rem;border-radius:0.75rem}
    header h1{font-size:1.75rem;font-weight:700}

    .relief-border{border:1px solid #e5e7eb;border-radius:12px;background:white}
    .btn{transition:all .2s ease;font-weight:600;border-radius:0.6rem;padding:0.6rem 1rem}
    .btn:hover{opacity:.95}
    .btn-primary{background:var(--color-accent);color:white}
    .btn-secondary{background:var(--color-secondary);color:#111827}
    .btn-danger{background:#dc2626;color:white}

    .tab-btn{padding:0.6rem 1rem;border-radius:.5rem}
    .tab-btn.active{border-bottom:3px solid var(--color-accent);font-weight:600}

    /* Modal base */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.40);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{background:white;border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.18)}

    /* Dark mode */
    .dark{background:#0f172a;color:#e5e7eb}
    .dark header{background:#0b1222;color:#e5e7eb}
    .dark .relief-border{border-color:#1f2937;background:#0b1222}
    .dark .modal{background:#0b1222;color:#e5e7eb}
    .dark table{color:#e5e7eb}
    .dark thead{color:#e5e7eb}
    .dark .btn-secondary{background:#111827;color:#e5e7eb;border:1px solid #1f2937}
    .dark input, .dark select, .dark textarea{ background:#0f172a;color:#e5e7eb;border-color:#334155 }
    .dark .text-gray-500, .dark .text-gray-600{ color:#cbd5e1 !important }

    /* Timeline */
    .timeline{display:flex;align-items:center;gap:14px}
    .tl-step{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:90px;text-align:center}
    .tl-dot{width:14px;height:14px;border-radius:9999px;background:#cfd4dc;transition:all .25s}
    .tl-dot.completed{background:var(--color-accent)}
    .tl-dot.current{background:#fff;border:3px solid var(--color-accent)}
    .tl-line{flex:1;height:3px;background:#cfd4dc;transition:background .25s}
    .tl-line.active{background:var(--color-accent)}

    /* Toast */
    #toast{position:fixed;bottom:18px;right:18px;z-index:60;display:none}
    .toast-card{background:#111827;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);max-width:340px}

    /* Tabla responsiva */
    .table-wrap{overflow-x:auto}
    th,td{white-space:nowrap}

    /* Kanban (monitor beneficios) */
    .kanban-column { min-height: 400px; display: flex; flex-direction: column; }
    .card-container { max-height: 60vh; overflow-y: auto; padding-right: 8px; flex-grow: 1; }
    .kanban-card { position: relative; background-color: var(--light-card-bg); }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.05); }

    .dark .kanban-column, .dark .modal{ background-color: var(--dark-bg-content); border-color: var(--dark-border); }
    .dark .kanban-card { background-color: var(--dark-card-bg); border-color: var(--dark-border); }

    .drag-over { background-color: #dbeafe; }
    .dark .drag-over { background-color: #1e3a8a; }

    .card-text-main { color: var(--light-card-text-main); }
    .card-text-secondary { color: var(--light-card-text-secondary); }
    .dark .card-text-main { color: var(--dark-card-text-main); }
    .dark .card-text-secondary { color: var(--dark-card-text-secondary); }
    .dragging { opacity: 0.5; transform: rotate(2deg); }

    /* Mejoras visuales */
    .bg-white-relief{ background:#fff }
    .dark .bg-white-relief{ background:var(--dark-bg-content) }
  </style>
</head>

<body id="body">
  <!-- Header -->
  <div class="container mx-auto max-w-7xl px-3 pt-4">
    <header class="flex items-center justify-between">
      <div>
        <h1>Juzgado de Ejecución Penal N°2</h1>
        <p class="opacity-90">Sistema de Gestión Integral de Legajos</p>
      </div>
      <div class="flex items-center gap-2 sm:gap-3">
        <button id="nav-legajos" class="btn btn-primary">Legajos</button>
        <button id="nav-beneficios" class="btn btn-secondary">Beneficios</button>
        <button id="settingsBtn" class="btn btn-secondary" title="Configuración">⚙️</button>
        <button id="themeToggle" class="btn btn-secondary" title="Modo claro/oscuro">🌙</button>
        <button id="authBtn" class="btn btn-primary">Iniciar Sesión</button>
      </div>
    </header>
  </div>

  <!-- App -->
  <main id="app" class="container mx-auto max-w-7xl px-3 mt-6 space-y-6">
    <!-- Vista: Legajos -->
    <section id="view-legajos">
      <div class="relief-border p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <input id="searchLegajosInput" placeholder="Buscar por prontuario o nombre..." class="border px-3 py-2 rounded w-full sm:w-1/3">
          <div class="flex items-center gap-2">
            <button id="addSentenceBtn" class="btn btn-primary hidden">+ Ingresar Sentencia</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="w-full text-left text-base">
            <thead class="text-xs uppercase bg-gray-50 dark:bg-[#111827]">
              <tr>
                <th class="px-4 py-2">ID Legajo</th>
                <th class="px-4 py-2">Prontuario</th>
                <th class="px-4 py-2">Nombre</th>
                <th class="px-4 py-2">Defensor</th>
                <th class="px-4 py-2">Estado de Cómputo</th>
                <th class="px-4 py-2">Fin Condena</th>
              </tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

        <!-- Vista: Beneficios (Monitor integrado) -->
    <section id="view-beneficios" class="hidden">
      <!-- Controles -->
      <div class="relief-border p-4">
        <div class="flex flex-col md:flex-row justify-between items-center gap-3">
          <div class="flex items-center gap-3">
            <input type="text" id="searchInput" placeholder="Buscar por N° o Interno..."
              class="w-full md:w-72 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
              <input type="checkbox" id="alarmToggle">
              <span>Alarmas visuales</span>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <button id="addCaseBtn" class="btn btn-primary hidden">+ Nuevo Trámite</button>
            <button id="refreshBenefitsBtn" class="btn btn-secondary">Actualizar</button>
          </div>
        </div>
      </div>

      <!-- Dashboard -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-xl relief-border bg-white-relief">
          <h3 class="text-sm font-medium dark:text-gray-400">Total Activos</h3>
          <p id="total-activos" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-white p-4 rounded-xl relief-border bg-white-relief">
          <h3 class="text-sm font-medium dark:text-gray-400">Tiempo Prom. en Gabinete</h3>
          <p id="avg-time" class="text-3xl font-bold">N/A</p>
        </div>
      </div>

      <!-- Loader -->
      <div id="loader" class="text-center py-10 hidden">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 
          5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 
          3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-gray-500">Cargando datos...</p>
      </div>

      <!-- Tablero Kanban -->
      <div id="kanban-board" class="relief-border p-4"></div>

      <!-- Gráfico -->
      <div id="chart-container" class="bg-white p-6 rounded-xl mt-6 relief-border bg-white-relief">
        <h3 class="text-lg font-medium mb-4 dark:text-white">Distribución de Beneficios Activos</h3>
        <div class="relative h-80"><canvas id="benefitsChart"></canvas></div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast"><div class="toast-card" id="toastText">Listo</div></div>

  <!-- Modal: Login -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal p-6 w-96">
      <h2 class="text-lg font-bold mb-3">Acceso de Administrador</h2>
      <form id="loginForm" class="space-y-3">
        <input id="password" type="password" placeholder="Contraseña" class="w-full border px-3 py-2 rounded" required>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelLoginBtn" class="btn btn-secondary">Cancelar</button>
          <button class="btn btn-primary">Ingresar</button>
        </div>
        <p id="loginError" class="text-red-500 text-sm hidden">Contraseña incorrecta.</p>
      </form>
    </div>
  </div>

  <!-- Modal: Configuración -->
  <div id="settingsModal" class="modal-backdrop">
    <div class="modal p-6 w-[520px]">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold">Configuración de Interfaz</h2>
        <button id="closeSettings" class="btn btn-secondary">Cerrar</button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <label class="text-sm">Color Primario (encabezado)
          <input id="colorPrimary" type="color" class="w-full h-10 border rounded mt-1" value="#1e3a8a">
        </label>
        <label class="text-sm">Color de Acción (botones)
          <input id="colorAccent" type="color" class="w-full h-10 border rounded mt-1" value="#2563eb">
        </label>
      </div>

      <!-- 🔹 NUEVO: colores de beneficios -->
      <div class="col-span-2 mt-4">
        <h3 class="font-semibold mb-2">Colores de Beneficios</h3>
        <div id="benefitColorsContainer" class="grid grid-cols-2 gap-2"></div>
      </div>

      <div class="flex items-center justify-between mt-4">
        <div class="flex items-center gap-2">
          <input id="darkToggle" type="checkbox">
          <label for="darkToggle" class="text-sm">Usar modo oscuro</label>
        </div>
        <div class="flex gap-2">
          <button id="resetTheme" class="btn btn-secondary">Restablecer</button>
          <button id="saveTheme" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ingresar Sentencia -->
  <div id="ingresarSentenciaModal" class="modal-backdrop">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Ingresar Nueva Sentencia</h2>
      <form id="ingresarSentenciaForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">ID Legajo (si existe)</label>
            <input name="id_legajo" class="w-full border px-2 py-2 rounded" placeholder="Dejar vacío para crear legajo nuevo">
          </div>
          <div>
            <label class="text-sm">N° Causa</label>
            <input name="nro_causa" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div>
            <label class="text-sm">Fecha Sentencia</label>
            <input name="fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div class="col-span-2">
            <label class="text-sm">Delito</label>
            <input name="delito" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div class="col-span-2">
            <label class="text-sm">Pena impuesta</label>
            <input name="pena_impuesta" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div class="col-span-2">
            <label class="text-sm">Enlace Sentencia (opcional)</label>
            <input name="enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded">
          </div>
          <div class="col-span-2 flex items-center gap-3">
            <input id="es_unificada" name="es_unificada" type="checkbox">
            <label for="es_unificada" class="text-sm">Es sentencia unificada</label>
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelIngresoBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Sentencia</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal: Editar Sentencia -->
  <div id="editarSentenciaModal" class="modal-backdrop">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Editar Sentencia</h2>
      <form id="editarSentenciaForm" class="space-y-3">
        <input type="hidden" name="id_sentencia" id="edit_id_sentencia">
        <input type="hidden" name="id_legajo" id="edit_id_legajo">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">N° Causa</label>
            <input name="nro_causa" id="edit_nro_causa" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div>
            <label class="text-sm">Fecha Sentencia</label>
            <input name="fecha_sentencia" id="edit_fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div class="col-span-2">
            <label class="text-sm">Delito</label>
            <input name="delito" id="edit_delito" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div class="col-span-2">
            <label class="text-sm">Pena impuesta</label>
            <input name="pena_impuesta" id="edit_pena_impuesta" class="w-full border px-2 py-2 rounded" required>
          </div>
          <div class="col-span-2">
            <label class="text-sm">Enlace Sentencia</label>
            <input name="enlace_sentencia" id="edit_enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded">
          </div>
          <div class="col-span-2 flex items-center gap-3">
            <input id="edit_es_unificada" name="es_unificada" type="checkbox">
            <label for="edit_es_unificada" class="text-sm">Es sentencia unificada</label>
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEditarSentenciaBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalle de Legajo -->
  <div id="legajoDetailModal" class="modal-backdrop">
    <div class="modal p-6 w-[1040px] max-w-full overflow-y-auto max-h-[95vh]">
      <div class="flex justify-between items-center mb-4">
        <h2 id="detailTitle" class="text-xl font-bold">Detalle de Legajo</h2>
        <div class="flex items-center gap-2">
          <button id="editLegajoBtn" class="btn btn-secondary hidden">Modificar</button>
          <button id="deleteLegajoBtn" class="btn btn-danger hidden">Eliminar</button>
          <button id="closeDetail" class="btn btn-secondary">Cerrar</button>
        </div>
      </div>
      <div class="border-b mb-4 flex gap-4 text-base">
        <button class="tab-btn active" data-tab="info">Datos del Legajo</button>
        <button class="tab-btn" data-tab="sentencias">Sentencias</button>
        <button class="tab-btn" data-tab="computo">Cómputo</button>
        <button class="tab-btn" data-tab="tramites">Trámites/Beneficios</button>
      </div>
      <div id="tab-content" class="space-y-4"></div>
    </div>
  </div>

  <!-- Modal Beneficios: Alta/Edición -->
  <div id="caseModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-md">
      <h2 id="modalTitle" class="text-xl font-bold mb-4">Agregar Nuevo Trámite</h2>
      <div class="max-h-[70vh] overflow-y-auto pr-2">
        <form id="caseForm" class="space-y-4">
          <input type="hidden" id="caseId" name="caseId">

          <!-- 🔹 Asociación obligatoria al Legajo -->
          <div>
            <label class="block text-sm font-medium">Legajo</label>
            <select id="caseLegajo" name="id_legajo" required
              class="mt-1 block w-full px-3 py-2 border rounded-xl bg-white dark:bg-gray-700">
              <option value="">Seleccione un legajo</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium">N° de Expediente</label>
            <input type="text" id="expediente" name="expediente"
              class="mt-1 block w-full px-3 py-2 border rounded-xl" required>
          </div>

          <div>
            <label class="block text-sm font-medium">Nombre del Interno/a</label>
            <input type="text" id="interno" name="interno"
              class="mt-1 block w-full px-3 py-2 border rounded-xl" required>
          </div>

          <div>
            <label class="block text-sm font-medium">Fecha de Ingreso</label>
            <input type="date" id="fechaIngreso" name="fechaIngreso"
              class="mt-1 block w-full px-3 py-2 border rounded-xl" required>
          </div>

          <div>
            <label class="block text-sm font-medium">Tipo de Beneficio</label>
            <select id="beneficio" name="beneficio"
              class="mt-1 block w-full px-3 py-2 border rounded-xl bg-white dark:bg-gray-700" required>
              <option>Salidas Transitorias</option>
              <option>Prisión Domiciliaria</option>
              <option>Estímulo Educativo</option>
              <option>Libertad Asistida</option>
              <option>Libertad Condicional</option>
              <option>Régimen Preparatorio</option>
              <option>Otro</option>
            </select>
          </div>

          <!-- 🔹 Campos de Finalización -->
          <div id="finalizeFieldsContainer" class="hidden border-t pt-4 mt-2">
            <div>
              <label class="block text-sm font-medium">Motivo de Finalización</label>
              <textarea id="motivoFinalizadoEdit" rows="3"
                class="mt-1 block w-full px-3 py-2 border rounded-xl"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium">Enlace a Resolución</label>
              <input type="url" id="enlaceResolucionEdit" placeholder="https://..."
                class="mt-1 block w-full px-3 py-2 border rounded-xl">
            </div>
          </div>
        </form>
      </div>
      <div class="flex justify-between items-center pt-4">
        <!-- 🔹 Botón eliminar -->
        <button type="button" id="deleteCaseBtn" class="btn btn-danger hidden">Eliminar</button>
        <div class="flex gap-2">
          <button type="button" id="cancelBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" form="caseForm" id="saveCaseBtn"
            class="btn btn-primary w-36 flex justify-center items-center">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Beneficios: Finalizar -->
  <div id="finalizeModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Finalizar Trámite</h2>
      <form id="finalizeForm" class="space-y-4">
        <input type="hidden" id="finalizeCaseId">
        <div>
          <label class="block text-sm font-medium">Motivo / Razón de Finalización</label>
          <textarea id="motivoFinalizado" rows="3"
            class="mt-1 block w-full px-3 py-2 border rounded-xl" required></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium">Enlace a Resolución (Opcional)</label>
          <input type="url" id="enlaceResolucion" placeholder="https://..."
            class="mt-1 block w-full px-3 py-2 border rounded-xl">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelFinalizeBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Confirmar Finalización</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal genérico de alerta -->
  <div id="alertModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-md">
      <h2 id="alertTitle" class="text-xl font-bold mb-3 text-yellow-500">Alerta</h2>
      <p id="alertMessage" class="text-gray-700 dark:text-gray-200 mb-4"></p>
      <div class="flex justify-end">
        <button type="button" id="closeAlertBtn" class="btn btn-secondary">Entendido</button>
      </div>
    </div>
  </div>

    <footer class="text-center py-8 mt-8 border-t border-gray-200 dark:border-gray-700">
    <p class="text-sm text-gray-500">By create RBM 2025</p>
  </footer>

  <script>
  /**********************
   * CONFIG
   **********************/
  const googleWebAppUrl = "https://script.google.com/macros/s/AKfycbxWByUh6NTMZAykR91XIgU1ZUIpF64eg4cJTDL8q4pJSelVi6MwawAvHpfWdYmqW_g/exec";
  const PASSWORD = "454545";
  let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
  let isAuthenticated = false;
  let currentLegajoId = null;
  let isDetailModalOpen = false;
  let currentSentencia = null;

  const $ = sel => document.querySelector(sel);
  const $$ = sel => document.querySelectorAll(sel);

  /**********************
   * THEME / SETTINGS
   **********************/
  function applyThemeFromStorage(){
    const p = localStorage.getItem('theme_primary');
    const a = localStorage.getItem('theme_accent');
    const d = localStorage.getItem('theme_dark')==='1';
    if(p) document.documentElement.style.setProperty('--color-primary', p);
    if(a) document.documentElement.style.setProperty('--color-accent', a);
    if(d) $('#body').classList.add('dark');
  }

  function showToast(msg, ms=2000){
    const t = $('#toast'), tx = $('#toastText');
    tx.textContent = msg;
    t.style.display = 'block';
    setTimeout(()=>{ t.style.display='none'; }, ms);
  }

  $('#themeToggle').addEventListener('click', ()=>{
    const bodyEl = $('#body');
    bodyEl.classList.toggle('dark');
    localStorage.setItem('theme_dark', bodyEl.classList.contains('dark')?'1':'0');
  });

  $('#settingsBtn').onclick = ()=>{
    $('#settingsModal').classList.add('show');
    $('#colorPrimary').value = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#1e3a8a';
    $('#colorAccent').value = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim() || '#2563eb';
    $('#darkToggle').checked = $('#body').classList.contains('dark');

    // 🔹 generar pickers de colores de beneficios
    const container = $('#benefitColorsContainer');
    container.innerHTML = '';
    Object.entries(benefitColors).forEach(([k,v])=>{
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <label class="text-xs">${k}
          <input type="color" data-benefit="${k}" value="${v}" class="w-full h-8 border rounded mt-1">
        </label>`;
      container.appendChild(wrap);
    });
  };

  $('#closeSettings').onclick = ()=> $('#settingsModal').classList.remove('show');

  $('#resetTheme').onclick = ()=>{
    localStorage.removeItem('theme_primary');
    localStorage.removeItem('theme_accent');
    localStorage.removeItem('theme_dark');
    localStorage.removeItem('benefitColors');
    document.documentElement.style.setProperty('--color-primary','#1e3a8a');
    document.documentElement.style.setProperty('--color-accent','#2563eb');
    $('#body').classList.remove('dark');
    benefitColors = {...DEFAULT_BENEFIT_COLORS};
  };

  $('#saveTheme').onclick = ()=>{
    const p = $('#colorPrimary').value;
    const a = $('#colorAccent').value;
    const d = $('#darkToggle').checked;
    document.documentElement.style.setProperty('--color-primary', p);
    document.documentElement.style.setProperty('--color-accent', a);
    localStorage.setItem('theme_primary', p);
    localStorage.setItem('theme_accent', a);
    localStorage.setItem('theme_dark', d?'1':'0');
    d? $('#body').classList.add('dark') : $('#body').classList.remove('dark');

    // guardar colores de beneficios
    const inputs = $('#benefitColorsContainer').querySelectorAll('input[type=color]');
    inputs.forEach(inp=>{
      benefitColors[inp.dataset.benefit] = inp.value;
    });
    localStorage.setItem('benefitColors', JSON.stringify(benefitColors));

    $('#settingsModal').classList.remove('show');
    showToast('Preferencias guardadas');
  };

  /**********************
   * NAV / AUTH
   **********************/
  $('#nav-legajos').onclick = ()=>{
    $('#view-legajos').classList.remove('hidden');
    $('#view-beneficios').classList.add('hidden');
  };

  $('#nav-beneficios').onclick = ()=>{
    $('#view-legajos').classList.add('hidden');
    $('#view-beneficios').classList.remove('hidden');
    renderBoard(casesData);
    renderChart(casesData);
    calcStats(casesData);
  };

  const loginModal = $('#loginModal');
  $('#authBtn').onclick = ()=>{
    if(isAuthenticated){
      isAuthenticated=false;
      $('#authBtn').textContent='Iniciar Sesión';
      $('#addSentenceBtn').classList.add('hidden');
      $('#addCaseBtn').classList.add('hidden');
      showToast('Sesión finalizada');
      renderBoard(casesData);
    } else {
      loginModal.classList.add('show');
    }
  };

  $('#cancelLoginBtn').onclick = ()=> loginModal.classList.remove('show');

  $('#loginForm').onsubmit = (e)=>{
    e.preventDefault();
    if($('#password').value === PASSWORD){
      isAuthenticated = true;
      $('#authBtn').textContent = 'Cerrar Sesión';
      $('#addSentenceBtn').classList.remove('hidden');
      $('#addCaseBtn').classList.remove('hidden');
      loginModal.classList.remove('show');
      $('#loginError').classList.add('hidden');
      showToast('Sesión iniciada');
      renderBoard(casesData);
    } else {
      $('#loginError').classList.remove('hidden');
    }
  };

  /**********************
   * DATA (GET / POST)
   **********************/
  async function fetchData(){
    const res = await fetch(googleWebAppUrl);
    allData = await res.json();
    renderLegajosTable(allData.legajos || []);
    hydrateCasesFromBeneficios(allData.beneficios || []);
    if (!$('#view-beneficios').classList.contains('hidden')) {
      renderBoard(casesData);
      renderChart(casesData);
      calcStats(casesData);
    }
    // 🔹 actualizar select de legajos
    populateLegajosSelect();
  }

  async function postData(payload, {refreshData=true, refreshModal=false} = {}){
    if(!isAuthenticated){
      alert('Debes iniciar sesión');
      return;
    }
    await fetch(googleWebAppUrl,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:'data='+encodeURIComponent(JSON.stringify({...payload,password:PASSWORD}))
    });
    if (refreshData) await fetchData();
    if (refreshModal && isDetailModalOpen && currentLegajoId) {
      openLegajoDetail(currentLegajoId);
    }
  }

  /**********************
   * LISTADO LEGAJOS
   **********************/
  function renderLegajosTable(legajos){
    const tbody=$("#legajosTableBody");
    tbody.innerHTML="";
    (legajos||[]).forEach(l=>{
      const tr=document.createElement("tr");
      tr.className="border-b hover:bg-gray-50 dark:hover:bg-[#0f172a] cursor-pointer";
      const fin = (l.fecha_fin_condena||'').toString().slice(0,10);
      tr.innerHTML = `
        <td class='px-4 py-3'>${l.id_legajo}</td>
        <td class='px-4 py-3'>${l.nro_prontuario||''}</td>
        <td class='px-4 py-3'>${l.nombre_completo||''}</td>
        <td class='px-4 py-3'>${l.defensor_actual||''}</td>
        <td class='px-4 py-3'>${l.estado_computo||''}</td>
        <td class='px-4 py-3'>${fin}</td>
      `;
      tr.onclick = ()=> openLegajoDetail(l.id_legajo);
      tbody.appendChild(tr);
    });
  }

  $('#searchLegajosInput').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#legajosTableBody tr');
    rows.forEach(r=>{
      r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });

      /**********************
   * MODAL SENTENCIA (nuevo/alta)
   **********************/
  $('#addSentenceBtn').onclick = ()=> $('#ingresarSentenciaModal').classList.add('show');
  $('#cancelIngresoBtn').onclick = ()=> $('#ingresarSentenciaModal').classList.remove('show');

  $('#ingresarSentenciaForm').onsubmit = async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const payload = Object.fromEntries(fd.entries());
    payload.es_unificada = fd.has('es_unificada');
    payload.action = payload.id_legajo ? 'addSentencia' : 'addLegajoYsentencia';
    await postData(payload, {refreshData:true});
    $('#ingresarSentenciaModal').classList.remove('show');
    showToast('Sentencia guardada');
  };

  /**********************
   * DETALLE LEGAJO (abre modal)
   **********************/
  function openLegajoDetail(id){
    currentLegajoId=id;
    isDetailModalOpen = true;
    const leg = (allData.legajos||[]).find(x=>x.id_legajo==id) || {};
    $('#detailTitle').textContent = `${leg.nombre_completo||'Legajo'} — ${id}`;

    detailModal.classList.add('show');
  }

  /**********************
   * BENEFICIOS / KANBAN
   **********************/
  const KANBAN_COLUMNS = [
    'Ingresado','En Gabinete','Regreso','Fiscalía',
    'Defensoría','Para Despacho','Finalizado'
  ];

  const DEFAULT_BENEFIT_COLORS = {
    'Salidas Transitorias':'#dbeafe',
    'Prisión Domiciliaria':'#d1fae5',
    'Estímulo Educativo':'#e9d5ff',
    'Libertad Asistida':'#ccfbf1',
    'Libertad Condicional':'#e0e7ff',
    'Régimen Preparatorio':'#fce7f3',
    'Otro':'#f3f4f6'
  };

  let benefitColors = JSON.parse(localStorage.getItem('benefitColors') || 'null') || {...DEFAULT_BENEFIT_COLORS};
  let casesData = [];
  let caseIdToFinalize = null;

  function hydrateCasesFromBeneficios(beneficios){
    casesData = (beneficios||[]).map(b=>({
      id: b.id_beneficio_legajo,
      id_legajo: b.id_legajo,
      expediente: b.expediente,
      interno: b.interno,
      beneficio: b.beneficio,
      estado: b.estado,
      fechaIngreso: b.fechaIngreso,
      fechaFinalizado: b.fechaFinalizado,
      motivoFinalizado: b.motivoFinalizado,
      enlaceResolucion: b.enlaceResolucion
    }));
  }

  function populateLegajosSelect(){
    const sel = $('#caseLegajo');
    if(!sel) return;
    sel.innerHTML = '<option value="">Seleccione un legajo</option>';
    (allData.legajos||[]).forEach(l=>{
      const opt = document.createElement('option');
      opt.value = l.id_legajo;
      opt.textContent = `${l.nombre_completo} — Legajo #${l.id_legajo}`;
      sel.appendChild(opt);
    });
  }

  function renderBoard(data){
    const board = $('#kanban-board');
    board.innerHTML = '';
    KANBAN_COLUMNS.forEach(status=>{
      const col = document.createElement('div');
      col.className = 'rounded-xl p-4 kanban-column relief-border';
      col.dataset.status = status;
      col.innerHTML = `
        <h2 class="font-bold text-lg mb-4 dark:text-white">${status}</h2>
        <div class="space-y-3 card-container"></div>
      `;
      board.appendChild(col);
    });

    (data||[]).forEach(item=>{
      const col = board.querySelector(`.kanban-column[data-status="${item.estado}"] .card-container`);
      if(col) col.appendChild(createCardElement(item));
    });
  }

  function createCardElement(item){
    const card = document.createElement('div');
    card.className = 'kanban-card p-4 rounded-xl relief-border';
    card.dataset.id = item.id;

    const bgColor = benefitColors[item.beneficio] || benefitColors['Otro'];
    const textColor = getContrastColor(bgColor);

    card.innerHTML = `
      <div class="font-bold text-lg" style="color:${textColor}">${item.expediente||'S/N'}</div>
      <div class="text-sm">${item.interno||''}</div>
      <div class="mt-1 text-xs">Beneficio: ${item.beneficio}</div>
      <div class="mt-1 text-xs">Estado: ${item.estado}</div>
      ${item.estado==='Finalizado' && item.motivoFinalizado? `<p class="mt-2 text-xs italic">Motivo: ${item.motivoFinalizado}</p>`:''}
      ${item.estado==='Finalizado' && item.enlaceResolucion? `<a href="${item.enlaceResolucion}" target="_blank" class="text-xs text-blue-600">Ver Resolución</a>`:''}
    `;

    if(isAuthenticated){
      card.addEventListener('click', ()=> openEditModal(item));
    }
    return card;
  }

  function getContrastColor(hex){
    if(!hex) return '#000';
    const r=parseInt(hex.substr(1,2),16), g=parseInt(hex.substr(3,2),16), b=parseInt(hex.substr(5,2),16);
    return (((r*299)+(g*587)+(b*114))/1000>=128)?'#000':'#fff';
  }

  /**********************
   * EDITAR / ELIMINAR BENEFICIOS
   **********************/
  function openEditModal(item){
    $('#modalTitle').textContent = 'Editar Trámite';
    $('#caseId').value = item.id;
    $('#caseLegajo').value = item.id_legajo;
    $('#expediente').value = item.expediente;
    $('#interno').value = item.interno;
    $('#beneficio').value = item.beneficio;
    $('#fechaIngreso').value = item.fechaIngreso? item.fechaIngreso.split('T')[0] : '';

    if(item.estado==='Finalizado'){
      $('#finalizeFieldsContainer').classList.remove('hidden');
      $('#motivoFinalizadoEdit').value = item.motivoFinalizado||'';
      $('#enlaceResolucionEdit').value = item.enlaceResolucion||'';
    } else {
      $('#finalizeFieldsContainer').classList.add('hidden');
    }

    if(isAuthenticated){
      $('#deleteCaseBtn').classList.remove('hidden');
      $('#deleteCaseBtn').onclick = async ()=>{
        if(confirm("¿Está seguro de eliminar este beneficio?")){
          await postData({action:'deleteBeneficio', id_beneficio_legajo:item.id}, {refreshData:true});
          $('#caseModal').classList.remove('show');
          showToast('Beneficio eliminado');
        }
      };
    }

    $('#caseModal').classList.add('show');
  }

  $('#caseForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const id = fd.get('caseId');
    const data = Object.fromEntries(fd.entries());

    if(id){
      await postData({action:'updateBeneficio', ...data, id_beneficio_legajo:id}, {refreshData:true});
      showToast('Beneficio actualizado');
    } else {
      await postData({action:'addBeneficio', ...data, estado:'Ingresado'}, {refreshData:true});
      showToast('Beneficio creado');
    }
    $('#caseModal').classList.remove('show');
  });

  /**********************
   * INICIO
   **********************/
  applyThemeFromStorage();
  fetchData();
  </script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión Integral de Legajos - Juzgado de Ejecución Penal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:'Inter',sans-serif;}
    .relief-border{border:1px solid #d1d5db;border-radius:12px;}
    .kanban-column{min-height:260px}
    .card-drag{user-select:none}

    :root{
      --color-primary:#1e3a8a;
      --color-secondary:#f3f4f6;
      --color-accent:#2563eb;
    }
    header{background:var(--color-primary);color:white;padding:1rem 1.5rem;border-radius:0.5rem;}
    header h1{font-size:1.5rem;font-weight:600;}
    button{transition:all 0.2s ease;}
    button:hover{opacity:0.9;}
    .btn-primary{background:var(--color-accent);color:white;padding:0.5rem 1rem;border-radius:0.5rem;}
    .btn-secondary{background:var(--color-secondary);color:#111827;padding:0.5rem 1rem;border-radius:0.5rem;}
    .btn-danger{background:#dc2626;color:white;padding:0.5rem 1rem;border-radius:0.5rem;}

    .tab-btn{padding:0.5rem 1rem;}
    .tab-btn.font-medium{border-bottom:3px solid var(--color-accent);}

    .modal{background:white;border-radius:0.75rem;box-shadow:0 10px 25px rgba(0,0,0,0.15);}

    .dark{background:#111827;color:#f9fafb;}
    .dark header{background:#1f2937;color:white;}
    .dark .relief-border{border-color:#374151;background:#1f2937;}
    .dark table{color:#f9fafb;}
    .dark .modal{background:#1f2937;color:#f9fafb;}
  </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors" id="body">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1>Juzgado de Ejecución Penal N°2</h1>
      <p id="view-title">Sistema de Gestión Integral de Legajos</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="nav-legajos" class="btn-primary">Legajos</button>
      <button id="nav-beneficios" class="btn-secondary">Beneficios</button>
      <button id="themeToggle" class="btn-secondary">🌙</button>
      <button id="authBtn" class="btn-primary">Iniciar Sesión</button>
    </div>
  </header>

  <main id="app" class="space-y-6">
    <section id="view-legajos">
      <div class="relief-border p-4 bg-white">
        <div class="flex justify-between items-center mb-4">
          <input id="searchLegajosInput" placeholder="Buscar por prontuario o nombre..." class="border px-3 py-2 rounded w-1/3">
          <div class="flex items-center gap-2">
            <button id="addSentenceBtn" class="btn-primary hidden">+ Ingresar Sentencia</button>
            <button id="newBeneficioBtn" class="btn-primary hidden">+ Nuevo Beneficio</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="text-xs uppercase bg-gray-50">
              <tr><th class="px-4 py-2">ID Legajo</th><th class="px-4 py-2">Prontuario</th><th class="px-4 py-2">Nombre</th><th class="px-4 py-2">Defensor</th><th class="px-4 py-2">Estado</th><th class="px-4 py-2">Fin Condena</th></tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-beneficios" class="hidden">
      <div class="relief-border p-4 bg-white mb-4 grid grid-cols-3 gap-4">
        <div><h3 class="text-sm text-gray-500">Total Activos</h3><p id="total-activos" class="text-2xl font-bold">0</p></div>
        <div><h3 class="text-sm text-gray-500">Tiempo Promedio en Gabinete</h3><p id="avg-time" class="text-2xl font-bold">N/A</p></div>
        <div class="flex justify-end"><button id="refreshBtn" class="btn-primary">Actualizar</button></div>
      </div>
      <div id="kanban-board" class="relief-border p-4 bg-white"></div>
      <div id="chart-container" class="relief-border p-4 bg-white mt-4"><canvas id="benefitsChart" height="120"></canvas></div>
    </section>
  </main>

  <div id="legajoDetailModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="modal p-6 w-[1000px] max-w-full overflow-y-auto max-h-[95vh]">
      <div class="flex justify-between items-center mb-4">
        <h2 id="detailTitle" class="text-lg font-bold">Detalle de Legajo</h2>
        <button id="closeDetail" class="btn-secondary">Cerrar</button>
      </div>
      <div class="border-b mb-4 flex gap-4 text-sm">
        <button class="tab-btn font-medium" data-tab="info">Datos del Legajo</button>
        <button class="tab-btn" data-tab="sentencias">Sentencias</button>
        <button class="tab-btn" data-tab="computo">Cómputo</button>
        <button class="tab-btn" data-tab="tramites">Trámites/Beneficios</button>
      </div>
      <div id="tab-content" class="space-y-4"></div>
      <div class="mt-4 flex gap-2 justify-end hidden" id="adminActions">
        <button id="deleteLegajoBtn" class="btn-danger">Eliminar Legajo</button>
      </div>
    </div>
  </div>

  <script>
    const googleWebAppUrl = 'https://script.google.com/macros/s/AKfycbz3pHMP0zZo8HfqaOTuAGwpTvwA46AGRXDTr8cmOoZ8zIzAChWi8304QTbw3ArozHKI/exec';
    const PASSWORD = '454545';
    let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
    let isAuthenticated = false;
    let currentLegajoId = null;

    async function fetchData(){
      const res = await fetch(googleWebAppUrl);
      allData = await res.json();
      renderLegajosTable(allData.legajos || []);
    }

    async function postData(payload){
      if(!isAuthenticated){ alert('Debes iniciar sesión para realizar cambios'); return; }
      await fetch(googleWebAppUrl,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:"data="+encodeURIComponent(JSON.stringify({...payload,password:PASSWORD}))});
      fetchData();
    }

    function renderLegajosTable(legajos){
      const tbody=document.getElementById('legajosTableBody');
      tbody.innerHTML='';
      legajos.forEach(l=>{
        const tr=document.createElement('tr');
        tr.className='border-b hover:bg-gray-50 cursor-pointer';
        tr.innerHTML = `<td class='px-4 py-2 font-mono'>${l.id_legajo}</td><td class='px-4 py-2'>${l.nro_prontuario||''}</td><td class='px-4 py-2 font-medium'>${l.nombre_completo||''}</td><td class='px-4 py-2'>${l.defensor_actual||''}</td><td class='px-4 py-2'>${l.estado_computo||''}</td><td class='px-4 py-2'>${l.fecha_fin_condena||''}</td>`;
        tr.addEventListener('click',()=>openLegajoDetail(l.id_legajo));
        tbody.appendChild(tr);
      });
    }

    function openLegajoDetail(id){
      currentLegajoId=id;
      const leg = allData.legajos.find(x=>x.id_legajo==id)||{};
      const sent = allData.sentencias.filter(s=>s.id_legajo==id);
      const ben = allData.beneficios.filter(b=>b.id_legajo==id);
      const tram = allData.tramitesVarios.filter(t=>t.id_legajo==id);

      document.getElementById('detailTitle').textContent=`Legajo ${id}`;
      const tabContent=document.getElementById('tab-content');

      const renderTab=(tab)=>{
        if(tab==='info'){
          tabContent.innerHTML=`<div class='grid grid-cols-2 gap-3'>
            <div><label class='text-sm'>Prontuario</label><input id='editProntuario' value='${leg.nro_prontuario||''}' class='w-full border rounded px-2 py-1'></div>
            <div><label class='text-sm'>Nombre Completo</label><input id='editNombre' value='${leg.nombre_completo||''}' class='w-full border rounded px-2 py-1'></div>
            <div><label class='text-sm'>Defensor</label><input id='editDefensor' value='${leg.defensor_actual||''}' class='w-full border rounded px-2 py-1'></div>
            <div><label class='text-sm'>Fiscal</label><input id='editFiscal' value='${leg.fiscal_actual||''}' class='w-full border rounded px-2 py-1'></div>
          </div>
          <div class='mt-3 flex justify-end'><button id='saveLegajoBtn' class='btn-primary'>Guardar Cambios</button></div>`;
          document.getElementById('saveLegajoBtn').onclick=()=>{
            postData({action:'updateLegajoField',id_legajo:id,field:'nro_prontuario',value:document.getElementById('editProntuario').value});
            postData({action:'updateLegajoField',id_legajo:id,field:'nombre_completo',value:document.getElementById('editNombre').value});
            postData({action:'updateLegajoField',id_legajo:id,field:'defensor_actual',value:document.getElementById('editDefensor').value});
            postData({action:'updateLegajoField',id_legajo:id,field:'fiscal_actual',value:document.getElementById('editFiscal').value});
          };
        }
        if(tab==='sentencias'){
          tabContent.innerHTML = sent.map(s=>`<div class='p-2 border rounded'>${s.nro_causa} - ${s.delito} (${s.pena_impuesta})</div>`).join('')||'Sin sentencias.';
        }
        if(tab==='computo'){
          tabContent.innerHTML=`<div class='flex flex-col gap-2'>
            <button class='btn-secondary' onclick="postData({action:'updateComputoEstado',id_legajo:'${id}',newState:'Pendiente SPP'})">Designación Defensor (SPP)</button>
            <button class='btn-secondary' onclick="postData({action:'updateComputoEstado',id_legajo:'${id}',newState:'Provisorio'})">Cómputo Provisorio</button>
            <button class='btn-secondary' onclick="postData({action:'updateComputoEstado',id_legajo:'${id}',newState:'Enviado a Defensoría'})">Enviar a Defensoría</button>
            <button class='btn-secondary' onclick="postData({action:'updateComputoEstado',id_legajo:'${id}',newState:'Enviado a Fiscalía'})">Enviar a Fiscalía</button>
            <button class='btn-primary' onclick="postData({action:'updateComputoEstado',id_legajo:'${id}',newState:'Aprobado'})">Aprobar Cómputo</button>
          </div>`;
        }
        if(tab==='tramites'){
          const all=ben.concat(tram);
          tabContent.innerHTML = all.map(t=>`<div class='p-2 border rounded'>${t.expediente||t.tipo_tramite} - ${t.beneficio||t.tipo_tramite} (${t.estado})</div>`).join('')||'Sin trámites/beneficios.';
        }
      };

      document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.classList.remove('font-medium');
        btn.onclick=()=>{document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('font-medium'));btn.classList.add('font-medium');renderTab(btn.dataset.tab);};
      });
      document.querySelector('.tab-btn[data-tab="info"]').click();
      if(isAuthenticated) document.getElementById('adminActions').classList.remove('hidden');
      detailModal.style.display='flex';

      document.getElementById('deleteLegajoBtn').onclick=()=>{
        if(confirm('¿Eliminar legajo y todos sus registros asociados?')){
          postData({action:'deleteLegajoCompleto',id_legajo:id});
          detailModal.style.display='none';
        }
      };
    }

    document.getElementById('closeDetail').onclick=()=>detailModal.style.display='none';
    fetchData();
  </script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión Integral de Legajos - Juzgado de Ejecución Penal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --light-bg-general:#f3f4f6; --light-bg-content:#ffffff; --light-text-main:#111827; }
    body{font-family:'Inter',sans-serif;background:var(--light-bg-general);color:var(--light-text-main);}
    .relief-border{border:1px solid #e5e7eb;border-radius:12px}
    .relief-button{transition:all .15s}
    .kanban-column{min-height:260px}
    .card-drag{user-select:none}
  </style>
</head>
<body class="p-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold">Juzgado de Ejecución Penal N°2</h1>
      <p id="view-title" class="text-sm text-gray-600">Dashboard de Legajos — Sistema de Gestión Integral</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="nav-legajos" class="px-4 py-2 bg-indigo-600 text-white rounded">Legajos</button>
      <button id="nav-beneficios" class="px-4 py-2 bg-gray-200 rounded">Beneficios</button>
      <button id="authBtn" class="px-4 py-2 bg-green-600 text-white rounded">Iniciar Sesión</button>
    </div>
  </header>

  <main id="app">
    <!-- Legajos table -->
    <section id="view-legajos">
      <div class="relief-border p-4 mb-6 bg-white">
        <div class="flex justify-between items-center mb-4">
          <input id="searchLegajosInput" placeholder="Buscar por prontuario o nombre..." class="border px-3 py-2 rounded w-1/3">
          <div class="flex items-center gap-2">
            <button id="addSentenceBtn" class="bg-indigo-600 text-white px-4 py-2 rounded hidden">+ Ingresar Sentencia</button>
            <button id="newBeneficioBtn" class="bg-blue-600 text-white px-4 py-2 rounded hidden">+ Nuevo Beneficio</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="text-xs text-gray-600 uppercase">
              <tr><th class="px-4 py-2">ID Legajo</th><th class="px-4 py-2">Prontuario</th><th class="px-4 py-2">Nombre</th><th class="px-4 py-2">Defensor</th><th class="px-4 py-2">Estado</th><th class="px-4 py-2">Fin Condena</th></tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Beneficios view -->
    <section id="view-beneficios" class="hidden">
      <div class="relief-border p-4 bg-white mb-4">
        <div class="grid grid-cols-3 gap-4">
          <div><h3 class="text-sm text-gray-500">Total Activos</h3><p id="total-activos" class="text-2xl font-bold">0</p></div>
          <div><h3 class="text-sm text-gray-500">Tiempo Promedio en Gabinete</h3><p id="avg-time" class="text-2xl font-bold">N/A</p></div>
          <div class="flex justify-end"><button id="refreshBtn" class="px-4 py-2 bg-indigo-600 text-white rounded">Actualizar</button></div>
        </div>
      </div>

      <div id="kanban-board" class="relief-border p-4 bg-white"></div>
      <div id="chart-container" class="relief-border p-4 bg-white mt-4"><canvas id="benefitsChart" height="120"></canvas></div>
    </section>
  </main>

  <!-- Modals -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-lg font-bold mb-3">Acceso de Administrador</h2>
      <form id="loginForm">
        <input id="password" type="password" placeholder="Contraseña" class="w-full border px-3 py-2 rounded mb-3">
        <div class="flex justify-end gap-2"><button type="button" id="cancelLoginBtn" class="px-4 py-2 rounded bg-gray-200">Cancelar</button><button class="px-4 py-2 bg-indigo-600 text-white rounded">Ingresar</button></div>
      </form>
    </div>
  </div>

  <div id="ingresarSentenciaModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-[720px] max-w-full">
      <h2 class="text-lg font-bold mb-3">Ingresar Nueva Sentencia</h2>
      <form id="ingresarSentenciaForm">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm">ID Legajo (si existe)</label><input name="id_legajo" class="w-full border px-2 py-2 rounded" placeholder="Dejar vacío para crear nuevo legajo"></div>
          <div><label class="text-sm">N° Causa</label><input name="nro_causa" class="w-full border px-2 py-2 rounded" required></div>
          <div><label class="text-sm">Fecha Sentencia</label><input name="fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Delito</label><input name="delito" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Pena impuesta</label><input name="pena_impuesta" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Enlace Sentencia (opcional)</label><input name="enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded"></div>
          <div class="col-span-2 flex items-center gap-3"><input id="es_unificada" name="es_unificada" type="checkbox"><label for="es_unificada" class="text-sm">Es sentencia unificada</label></div>
        </div>
        <div class="flex justify-end gap-2 mt-4"><button type="button" id="cancelIngresoBtn" class="px-3 py-2 rounded bg-gray-200">Cancelar</button><button type="submit" class="px-3 py-2 rounded bg-indigo-600 text-white">Guardar Sentencia</button></div>
      </form>
    </div>
  </div>

  <div id="caseModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-96">
      <h2 class="text-lg font-bold mb-3">Agregar Nuevo Trámite/Beneficio</h2>
      <form id="caseForm">
        <input type="hidden" id="caseId" name="caseId">
        <input type="hidden" id="legajoIdForBeneficio" name="id_legajo">
        <label class="text-sm">N° Expediente</label><input id="expediente" name="expediente" class="w-full border px-2 py-2 rounded mb-2" required>
        <label class="text-sm">Interno</label><input id="interno" name="interno" class="w-full border px-2 py-2 rounded mb-2" required>
        <label class="text-sm">Fecha Ingreso</label><input id="fechaIngreso" name="fechaIngreso" type="date" class="w-full border px-2 py-2 rounded mb-2" required>
        <label class="text-sm">Tipo de Beneficio</label>
        <select id="beneficio" name="beneficio" class="w-full border px-2 py-2 rounded mb-3">
          <option>Salidas Transitorias</option><option>Prisión Domiciliaria</option><option>Estímulo Educativo</option><option>Libertad Asistida</option><option>Libertad Condicional</option><option>Régimen Preparatorio</option><option>Otro</option>
        </select>
        <div class="flex justify-end gap-2"><button type="button" id="cancelBtn" class="px-3 py-2 rounded bg-gray-200">Cancelar</button><button type="submit" id="saveCaseBtn" class="px-3 py-2 rounded bg-indigo-600 text-white">Guardar</button></div>
      </form>
    </div>
  </div>

  <div id="legajoDetailModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center">
    <div class="bg-white p-6 rounded shadow w-[900px] max-w-full">
      <div class="flex justify-between items-center mb-4"><h2 id="detailTitle" class="text-lg font-bold">Detalle de Legajo</h2><button id="closeDetail" class="px-3 py-1 bg-gray-200 rounded">Cerrar</button></div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <h3 class="font-semibold">Sentencias Vinculadas</h3>
          <div id="sentenciasList" class="mt-2 space-y-2"></div>
        </div>
        <div>
          <h3 class="font-semibold">Trámites y Beneficios</h3>
          <div id="tramitesList" class="mt-2 space-y-2"></div>
        </div>
      </div>
      <div class="mt-4 flex gap-2 justify-end">
        <button id="sendToFiscaliaBtn" class="px-3 py-2 bg-yellow-500 text-white rounded">Enviar a Fiscalía</button>
        <button id="sendToDefensoriaBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Enviar a Defensoría</button>
        <button id="approveComputoBtn" class="px-3 py-2 bg-green-600 text-white rounded">Aprobar Cómputo (Auto)</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    /****************************************************************************
     * Archivo principal: Frontend para Gestión Integral de Legajos
     * - Implementa: lectura (doGet) y escritura (doPost) sobre Google Apps Script WebApp
     * - Funcionalidades añadidas: Drag & Drop Kanban que persiste estado, Chart.js, vista detallada
     * - Reemplazar googleWebAppUrl por la URL de tu WebApp y PASSWORD por la que definas
     ****************************************************************************/

    const googleWebAppUrl = 'https://script.google.com/macros/s/AKfycbyjpUOuB1B2ORVzT3PpwwuqRR04vc1Csnthbi2GDzbpmHhOThd26rv5pEkpk4T1LA/exec';
    const PASSWORD = '454545';

    let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
    let isAuthenticated = false;
    let currentLegajoId = null;

    // Selectores
    const viewLegajos = document.getElementById('view-legajos');
    const viewBeneficios = document.getElementById('view-beneficios');
    const navLegajos = document.getElementById('nav-legajos');
    const navBeneficios = document.getElementById('nav-beneficios');
    const legajosTableBody = document.getElementById('legajosTableBody');
    const kanbanBoard = document.getElementById('kanban-board');
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const authBtn = document.getElementById('authBtn');
    const addSentenceBtn = document.getElementById('addSentenceBtn');
    const newBeneficioBtn = document.getElementById('newBeneficioBtn');
    const ingresarSentenciaModal = document.getElementById('ingresarSentenciaModal');
    const ingresarSentenciaForm = document.getElementById('ingresarSentenciaForm');
    const caseModal = document.getElementById('caseModal');
    const caseForm = document.getElementById('caseForm');
    const detailModal = document.getElementById('legajoDetailModal');
    const sentenciasList = document.getElementById('sentenciasList');
    const tramitesList = document.getElementById('tramitesList');

    navLegajos.addEventListener('click', ()=>{ viewLegajos.classList.remove('hidden'); viewBeneficios.classList.add('hidden'); });
    navBeneficios.addEventListener('click', ()=>{ viewBeneficios.classList.remove('hidden'); viewLegajos.classList.add('hidden'); });

    async function fetchData(){
      try{
        const res = await fetch(googleWebAppUrl);
        if(!res.ok) throw new Error('Error al conectar con WebApp');
        const data = await res.json();
        allData = data;
        renderLegajosTable(allData.legajos || []);
        renderBoard(allData.beneficios || []);
        renderChart(allData.beneficios || []);
      }catch(err){
        console.error(err);
        legajosTableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-red-500">Error al cargar datos.</td></tr>';
      }
    }

   async function postData(payload){
  if(!isAuthenticated){ 
    alert('Debes iniciar sesión para realizar cambios'); 
    return; 
  }
  try{
    const res = await fetch(googleWebAppUrl, { 
      method:'POST', 
      headers:{'Content-Type':'application/x-www-form-urlencoded'}, 
      body: "data=" + encodeURIComponent(JSON.stringify({...payload, password: PASSWORD})) 
    });
    const json = await res.json();
    console.log("Respuesta WebApp:", json);
    await fetchData();
  }catch(err){ 
    console.error('Err post',err); 
    alert('Error al enviar datos'); 
  }
}

    function renderLegajosTable(legajos){
      legajosTableBody.innerHTML='';
      if(!legajos || legajos.length===0){ legajosTableBody.innerHTML='<tr><td colspan="6" class="p-4">No hay legajos.</td></tr>'; return; }
      legajos.forEach(l=>{
        const tr=document.createElement('tr');
        tr.className='border-b hover:bg-gray-50 cursor-pointer';
        tr.innerHTML = `<td class="px-4 py-2 font-mono">${l.id_legajo}</td><td class="px-4 py-2">${l.nro_prontuario||''}</td><td class="px-4 py-2 font-medium">${l.nombre_completo||''}</td><td class="px-4 py-2">${l.defensor_actual||'N/A'}</td><td class="px-4 py-2">${l.estado_computo||'N/A'}</td><td class="px-4 py-2">${l.fecha_fin_condena? new Date(l.fecha_fin_condena).toLocaleDateString():'N/A'}</td>`;
        tr.addEventListener('click', ()=> openLegajoDetail(l.id_legajo));
        legajosTableBody.appendChild(tr);
      });
    }

    // Detalle de legajo con acciones de flujo
    function openLegajoDetail(id){
      currentLegajoId = id;
      const leg = (allData.legajos||[]).find(x=>x.id_legajo==id) || {};
      const sent = (allData.sentencias||[]).filter(s=>s.id_legajo==id);
      const ben = (allData.beneficios||[]).filter(b=>b.id_legajo==id);
      const tram = (allData.tramitesVarios||[]).filter(t=>t.id_legajo==id);

      document.getElementById('detailTitle').textContent = `${leg.nombre_completo || 'Legajo'} — ${id}`;
      sentenciasList.innerHTML = '';
      sent.forEach(s=>{ const div=document.createElement('div'); div.className='p-2 border rounded'; div.innerHTML = `<div class="font-medium">Causa: ${s.nro_causa}</div><div class="text-xs text-gray-600">${s.delito} • ${s.pena_impuesta} • ${s.fecha_sentencia}</div>`; sentenciasList.appendChild(div); });

      tramitesList.innerHTML='';
      ben.concat(tram).forEach(t=>{ const div=document.createElement('div'); div.className='p-2 border rounded'; div.innerHTML=`<div class="font-medium">${t.expediente || t.tipo_tramite || ''}</div><div class="text-xs text-gray-600">${t.beneficio || t.tipo_tramite || ''} • Estado: ${t.estado || t.estado}</div>`; tramitesList.appendChild(div); });

      detailModal.style.display='flex';
    }

    document.getElementById('closeDetail').addEventListener('click', ()=> detailModal.style.display='none');

    // Botones de flujo en detalle
    document.getElementById('sendToFiscaliaBtn').addEventListener('click', ()=>{ if(!currentLegajoId) return; postData({ action:'updateComputoEstado', id_legajo: currentLegajoId, newState:'Enviado a Fiscalía' }); alert('Enviado a Fiscalía'); });
    document.getElementById('sendToDefensoriaBtn').addEventListener('click', ()=>{ if(!currentLegajoId) return; postData({ action:'updateComputoEstado', id_legajo: currentLegajoId, newState:'Enviado a Defensoría' }); alert('Enviado a Defensoría'); });
    document.getElementById('approveComputoBtn').addEventListener('click', ()=>{ if(!currentLegajoId) return; postData({ action:'updateComputoEstado', id_legajo: currentLegajoId, newState:'Aprobado' }); alert('Cómputo aprobado'); });

    // Kanban
    const KANBAN_COLUMNS = ['Ingresado','En Gabinete','Regreso','Fiscalía','Defensoría','Para Despacho','Finalizado'];
    function renderBoard(beneficios){
      kanbanBoard.innerHTML='';
      const container = document.createElement('div'); container.className='grid grid-cols-3 gap-4';
      KANBAN_COLUMNS.forEach(status=>{
        const col=document.createElement('div'); col.className='p-3 relief-border';
        col.innerHTML = `<h3 class="font-semibold mb-2">${status}</h3><div class="card-container min-h-[120px]" data-status="${status}" ondragover="event.preventDefault()"></div>`;
        container.appendChild(col);
      });
      kanbanBoard.appendChild(container);

      (beneficios||[]).forEach(b=>{
        const list = kanbanBoard.querySelector(`.card-container[data-status="${b.estado}"]`);
        if(list){
          const card = document.createElement('div'); card.className='p-2 mb-2 border rounded bg-white card-drag';
          card.draggable = true;
          card.dataset.id = b.id_beneficio_legajo || b.id;
          card.innerHTML = `<div class="font-medium">${b.interno || b.interno}</div><div class="text-xs">${b.expediente || ''} • ${b.beneficio || ''}</div>`;
          card.addEventListener('dragstart', onDragStart);
          list.appendChild(card);
        }
      });

      // attach drop handlers
      const containers = kanbanBoard.querySelectorAll('.card-container');
      containers.forEach(c=>{
        c.addEventListener('dragover', e=> e.preventDefault());
        c.addEventListener('drop', onDrop);
      });
    }

    function onDragStart(e){ e.dataTransfer.setData('text/plain', e.target.dataset.id); e.dataTransfer.effectAllowed = 'move'; }

    function onDrop(e){ e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); const target = e.currentTarget; if(!id) return; const card = document.querySelector(`[data-id="${id}"]`); if(card && target){ target.appendChild(card); const newStatus = target.dataset.status; // persist change
      postData({ action:'updateBeneficioStatus', id_beneficio_legajo: id, newStatus }); }
    }

    // Chart
    let chartInstance = null;
    function renderChart(beneficios){
      const ctx = document.getElementById('benefitsChart').getContext('2d');
      const counts = {};
      beneficios.forEach(b=>{ counts[b.beneficio] = (counts[b.beneficio]||0) + 1; });
      const labels = Object.keys(counts);
      const data = labels.map(l=>counts[l]);
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Beneficios por tipo', data }] }, options:{ responsive:true, plugins:{ legend:{ display:false } } } });
    }

    // Login behavior
    authBtn.addEventListener('click', ()=>{ if(isAuthenticated){ isAuthenticated=false; authBtn.textContent='Iniciar Sesión'; addSentenceBtn.classList.add('hidden'); newBeneficioBtn.classList.add('hidden'); } else { loginModal.style.display='flex'; }});
    document.getElementById('cancelLoginBtn').addEventListener('click', ()=> loginModal.style.display='none');
    loginForm.addEventListener('submit',(e)=>{ e.preventDefault(); if(document.getElementById('password').value === PASSWORD){ isAuthenticated=true; loginModal.style.display='none'; authBtn.textContent='Cerrar Sesión'; addSentenceBtn.classList.remove('hidden'); newBeneficioBtn.classList.remove('hidden'); } else alert('Contraseña incorrecta'); });

    // Ingresar Sentencia
    document.getElementById('cancelIngresoBtn').addEventListener('click',()=> ingresarSentenciaModal.style.display='none');
    addSentenceBtn.addEventListener('click', ()=>{ ingresarSentenciaModal.style.display='flex'; });
    ingresarSentenciaForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(ingresarSentenciaForm);
      const payload = Object.fromEntries(fd.entries());
      payload.es_unificada = fd.has('es_unificada');
      payload.action = payload.id_legajo ? 'addSentencia' : 'addLegajoYsentencia';
      postData(payload);
      ingresarSentenciaModal.style.display='none';
    });

    // Case form (beneficio)
    newBeneficioBtn.addEventListener('click', ()=>{ caseModal.style.display='flex'; });
    document.getElementById('cancelBtn').addEventListener('click', ()=> caseModal.style.display='none');
    caseForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(caseForm);
      const payload = Object.fromEntries(fd.entries());
      payload.action = 'addBeneficio';
      await postData(payload);
      caseModal.style.display='none';
    });

    document.getElementById('refreshBtn').addEventListener('click', fetchData);

    // Inicializar
    fetchData();

    // Deployment notes displayed as console info
    console.info('Frontend cargado. Reemplaza googleWebAppUrl y PASSWORD por tus valores. Publica tu Apps Script como Web App con acceso "Cualquiera, incluso anónimo" para evitar CORS o ajusta las llamadas fetch con mode:no-cors según tu despliegue.');
  </script>

  <!-- Instrucciones de despliegue (visibles en HTML, pero resumidas) -->
  <footer class="mt-6 text-sm text-gray-500 p-4">
    <strong>Instrucciones rápidas para desplegar el sistema:</strong>
    <ol class="list-decimal ml-6 mt-2">
      <li>Crea un proyecto en Google Apps Script e importa el contenido del Apps Script (doGet/doPost y funciones auxiliares). Configura SPREADSHEET_ID apuntando a tu Google Sheet.</li>
      <li>Publica el proyecto -> Deploy -> New deployment -> Web app. Acceso: "Cualquiera, incluso anónimo" (si el juzgado lo permite) y copia la URL del Web App.</li>
      <li>Abre este archivo HTML en un servidor estático (GitHub Pages, Netlify) o incluso cargándolo localmente. Reemplaza la constante <code>googleWebAppUrl</code> por la URL obtenida y <code>PASSWORD</code> por la que definiste en el Apps Script.</li>
      <li>Prueba la lectura (GET) y las acciones (POST). Si necesitas usar <code>mode: 'no-cors'</code> en fetch, ten en cuenta que no recibirás respuesta legible; preferible es permitir CORS/publicar correctamente.</li>
      <li>Habilita permisos en la planilla para que el Apps Script pueda leer/escribir. Testea flujos: crear legajo+sentencia, crear beneficio, mover tarjeta Kanban.</li>
    </ol>
    <strong>Si querés, hago ahora:</strong> activar validaciones adicionales, cron de sincronización, PDF automático de cómputos, o migrar autenticación a Google OAuth (recomendado para producción). 
  </footer>
</body>
</html>


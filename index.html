<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n Integral de Legajos - Juzgado de Ejecuci√≥n Penal</title>

  <!-- Tailwind para prototipado (puedes compilarlo luego para prod) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --color-primary:#1e3a8a;   /* encabezado */
      --color-secondary:#f3f4f6; /* botones neutros */
      --color-accent:#2563eb;    /* acciones */
    }

    html,body{height:100%}
    body{font-family:'Inter',sans-serif;background:#f7f7f8;color:#111827}

    header{background:var(--color-primary);color:white;padding:1rem 1.5rem;border-radius:0.75rem}
    header h1{font-size:1.75rem;font-weight:700}

    .relief-border{border:1px solid #e5e7eb;border-radius:12px;background:white}
    .btn{transition:all .2s ease;font-weight:600;border-radius:0.6rem;padding:0.6rem 1rem}
    .btn:hover{opacity:.95}
    .btn-primary{background:var(--color-accent);color:white}
    .btn-secondary{background:var(--color-secondary);color:#111827}
    .btn-danger{background:#dc2626;color:white}
    .tab-btn{padding:0.6rem 1rem;border-radius:.5rem}
    .tab-btn.active{border-bottom:3px solid var(--color-accent);font-weight:600}

    /* Modal base */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.40);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{background:white;border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.18)}

    /* Dark mode */
    .dark{background:#0f172a;color:#e5e7eb}
    .dark header{background:#0b1222;color:#e5e7eb}
    .dark .relief-border{border-color:#1f2937;background:#0b1222}
    .dark .modal{background:#0b1222;color:#e5e7eb}
    .dark table{color:#e5e7eb}
    .dark thead{color:#e5e7eb}
    .dark .btn-secondary{background:#111827;color:#e5e7eb;border:1px solid #1f2937}
    .dark input, .dark select, .dark textarea{ background:#0f172a;color:#e5e7eb;border-color:#334155 }
    .dark .text-gray-500, .dark .text-gray-600{ color:#cbd5e1 !important }

    /* Timeline */
    .timeline{display:flex;align-items:center;gap:14px}
    .tl-step{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:90px;text-align:center}
    .tl-dot{width:14px;height:14px;border-radius:9999px;background:#cfd4dc;transition:all .25s}
    .tl-dot.completed{background:var(--color-accent)}
    .tl-dot.current{background:#fff;border:3px solid var(--color-accent)}
    .tl-line{flex:1;height:3px;background:#cfd4dc;transition:background .25s}
    .tl-line.active{background:var(--color-accent)}

    /* Toast simple */
    #toast{position:fixed;bottom:18px;right:18px;z-index:60;display:none}
    .toast-card{background:#111827;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);max-width:340px}

    /* Tabla responsiva */
    .table-wrap{overflow-x:auto}
    th,td{white-space:nowrap}
  </style>
</head>

<body id="body">
  <!-- Header -->
  <div class="container mx-auto max-w-7xl px-3 pt-4">
    <header class="flex items-center justify-between">
      <div>
        <h1>Juzgado de Ejecuci√≥n Penal N¬∞2</h1>
        <p class="opacity-90">Sistema de Gesti√≥n Integral de Legajos</p>
      </div>
      <div class="flex items-center gap-2 sm:gap-3">
        <button id="nav-legajos" class="btn btn-primary">Legajos</button>
        <button id="nav-beneficios" class="btn btn-secondary">Beneficios</button>
        <button id="settingsBtn" class="btn btn-secondary" title="Configuraci√≥n">‚öôÔ∏è</button>
        <button id="themeToggle" class="btn btn-secondary" title="Modo claro/oscuro">üåô</button>
        <button id="authBtn" class="btn btn-primary">Iniciar Sesi√≥n</button>
      </div>
    </header>
  </div>

  <!-- App -->
  <main id="app" class="container mx-auto max-w-7xl px-3 mt-6 space-y-6">
    <!-- Vista: Legajos -->
    <section id="view-legajos">
      <div class="relief-border p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <input id="searchLegajosInput" placeholder="Buscar por prontuario o nombre..." class="border px-3 py-2 rounded w-full sm:w-1/3">
          <div class="flex items-center gap-2">
            <button id="addSentenceBtn" class="btn btn-primary hidden">+ Ingresar Sentencia</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="w-full text-left text-base">
            <thead class="text-xs uppercase bg-gray-50 dark:bg-[#111827]">
              <tr>
                <th class="px-4 py-2">ID Legajo</th>
                <th class="px-4 py-2">Prontuario</th>
                <th class="px-4 py-2">Nombre</th>
                <th class="px-4 py-2">Defensor</th>
                <th class="px-4 py-2">Estado de C√≥mputo</th>
                <th class="px-4 py-2">Fin Condena</th>
              </tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Vista: Beneficios -->
    <section id="view-beneficios" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="relief-border p-4">
          <h3 class="text-sm text-gray-500 dark:text-gray-300">Total Activos</h3>
          <p id="total-activos" class="text-2xl font-bold">0</p>
        </div>
        <div class="relief-border p-4">
          <h3 class="text-sm text-gray-500 dark:text-gray-300">Tiempo Promedio en Gabinete</h3>
          <p id="avg-time" class="text-2xl font-bold">‚Äî</p>
        </div>
        <div class="relief-border p-4 flex items-center justify-between">
          <span class="text-sm opacity-80">Distribuci√≥n por tipo</span>
          <button id="refreshBtn" class="btn btn-primary">Actualizar</button>
        </div>
      </div>

      <div id="kanban-board" class="relief-border p-4 mt-4"></div>
      <div id="chart-container" class="relief-border p-4 mt-4"><canvas id="benefitsChart" height="120"></canvas></div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast"><div class="toast-card" id="toastText">Listo</div></div>

  <!-- Modal: Login -->
  <div id="loginModal" class="modal-backdrop">
    <div class="modal p-6 w-96">
      <h2 class="text-lg font-bold mb-3">Acceso de Administrador</h2>
      <form id="loginForm" class="space-y-3">
        <input id="password" type="password" placeholder="Contrase√±a" class="w-full border px-3 py-2 rounded" required>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelLoginBtn" class="btn btn-secondary">Cancelar</button>
          <button class="btn btn-primary">Ingresar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Configuraci√≥n -->
  <div id="settingsModal" class="modal-backdrop">
    <div class="modal p-6 w-[520px]">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold">Configuraci√≥n de Interfaz</h2>
        <button id="closeSettings" class="btn btn-secondary">Cerrar</button>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <label class="text-sm">Color Primario (encabezado)
          <input id="colorPrimary" type="color" class="w-full h-10 border rounded mt-1" value="#1e3a8a">
        </label>
        <label class="text-sm">Color de Acci√≥n (botones)
          <input id="colorAccent" type="color" class="w-full h-10 border rounded mt-1" value="#2563eb">
        </label>
      </div>
      <div class="flex items-center justify-between mt-4">
        <div class="flex items-center gap-2">
          <input id="darkToggle" type="checkbox"><label for="darkToggle" class="text-sm">Usar modo oscuro</label>
        </div>
        <div class="flex gap-2">
          <button id="resetTheme" class="btn btn-secondary">Restablecer</button>
          <button id="saveTheme" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ingresar Sentencia -->
  <div id="ingresarSentenciaModal" class="modal-backdrop">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Ingresar Nueva Sentencia</h2>
      <form id="ingresarSentenciaForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm">ID Legajo (si existe)</label><input name="id_legajo" class="w-full border px-2 py-2 rounded" placeholder="Dejar vac√≠o para crear legajo nuevo"></div>
          <div><label class="text-sm">N¬∞ Causa</label><input name="nro_causa" class="w-full border px-2 py-2 rounded" required></div>
          <div><label class="text-sm">Fecha Sentencia</label><input name="fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Delito</label><input name="delito" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Pena impuesta</label><input name="pena_impuesta" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Enlace Sentencia (opcional)</label><input name="enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded"></div>
          <div class="col-span-2 flex items-center gap-3"><input id="es_unificada" name="es_unificada" type="checkbox"><label for="es_unificada" class="text-sm">Es sentencia unificada</label></div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelIngresoBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Sentencia</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Editar Sentencia -->
  <div id="editarSentenciaModal" class="modal-backdrop">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Editar Sentencia</h2>
      <form id="editarSentenciaForm" class="space-y-3">
        <input type="hidden" name="id_sentencia" id="edit_id_sentencia">
        <input type="hidden" name="id_legajo" id="edit_id_legajo">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm">N¬∞ Causa</label><input name="nro_causa" id="edit_nro_causa" class="w-full border px-2 py-2 rounded" required></div>
          <div><label class="text-sm">Fecha Sentencia</label><input name="fecha_sentencia" id="edit_fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Delito</label><input name="delito" id="edit_delito" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Pena impuesta</label><input name="pena_impuesta" id="edit_pena_impuesta" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Enlace Sentencia</label><input name="enlace_sentencia" id="edit_enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded"></div>
          <div class="col-span-2 flex items-center gap-3"><input id="edit_es_unificada" name="es_unificada" type="checkbox"><label for="edit_es_unificada" class="text-sm">Es sentencia unificada</label></div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEditarSentenciaBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalle de Legajo -->
  <div id="legajoDetailModal" class="modal-backdrop">
    <div class="modal p-6 w-[1040px] max-w-full overflow-y-auto max-h-[95vh]">
      <div class="flex justify-between items-center mb-4">
        <h2 id="detailTitle" class="text-xl font-bold">Detalle de Legajo</h2>
        <div class="flex items-center gap-2">
          <button id="editLegajoBtn" class="btn btn-secondary hidden">Modificar</button>
          <button id="deleteLegajoBtn" class="btn btn-danger hidden">Eliminar</button>
          <button id="closeDetail" class="btn btn-secondary">Cerrar</button>
        </div>
      </div>

      <div class="border-b mb-4 flex gap-4 text-base">
        <button class="tab-btn active" data-tab="info">Datos del Legajo</button>
        <button class="tab-btn" data-tab="sentencias">Sentencias</button>
        <button class="tab-btn" data-tab="computo">C√≥mputo</button>
        <button class="tab-btn" data-tab="tramites">Tr√°mites/Beneficios</button>
      </div>

      <div id="tab-content" class="space-y-4"></div>
    </div>
  </div>

  <script>
    /**********************
     * CONFIG
     **********************/
    const googleWebAppUrl = "https://script.google.com/macros/s/AKfycbyeY6uqUypUlY_JZnWxA09ygNdf9wd54LrHPWXSLuhK00nF370qrS1N3t9oZ2Fk5bJU/exec";
    const PASSWORD = "454545";

    let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
    let isAuthenticated = false;
    let currentLegajoId = null;
    let isDetailModalOpen = false;
    let currentSentencia = null; // para edici√≥n

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    /**********************
     * THEME / SETTINGS
     **********************/
    function applyThemeFromStorage(){
      const p = localStorage.getItem('theme_primary');
      const a = localStorage.getItem('theme_accent');
      const d = localStorage.getItem('theme_dark')==='1';
      if(p) document.documentElement.style.setProperty('--color-primary', p);
      if(a) document.documentElement.style.setProperty('--color-accent', a);
      if(d) $('#body').classList.add('dark');
    }

    function showToast(msg, ms=2000){
      const t = $('#toast'), tx = $('#toastText');
      tx.textContent = msg;
      t.style.display = 'block';
      setTimeout(()=>{ t.style.display='none'; }, ms);
    }

    $('#themeToggle').addEventListener('click', ()=>{
      const bodyEl = $('#body');
      bodyEl.classList.toggle('dark');
      localStorage.setItem('theme_dark', bodyEl.classList.contains('dark')?'1':'0');
    });

    $('#settingsBtn').onclick = ()=>{
      $('#settingsModal').classList.add('show');
      $('#colorPrimary').value = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#1e3a8a';
      $('#colorAccent').value  = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim() || '#2563eb';
      $('#darkToggle').checked = $('#body').classList.contains('dark');
    };
    $('#closeSettings').onclick = ()=> $('#settingsModal').classList.remove('show');
    $('#resetTheme').onclick = ()=>{
      localStorage.removeItem('theme_primary');
      localStorage.removeItem('theme_accent');
      localStorage.removeItem('theme_dark');
      document.documentElement.style.setProperty('--color-primary','#1e3a8a');
      document.documentElement.style.setProperty('--color-accent','#2563eb');
      $('#body').classList.remove('dark');
    };
    $('#saveTheme').onclick = ()=>{
      const p = $('#colorPrimary').value;
      const a = $('#colorAccent').value;
      const d = $('#darkToggle').checked;
      document.documentElement.style.setProperty('--color-primary', p);
      document.documentElement.style.setProperty('--color-accent', a);
      localStorage.setItem('theme_primary', p);
      localStorage.setItem('theme_accent', a);
      localStorage.setItem('theme_dark', d?'1':'0');
      d? $('#body').classList.add('dark') : $('#body').classList.remove('dark');
      $('#settingsModal').classList.remove('show');
      showToast('Preferencias guardadas');
    };

    /**********************
     * NAV / AUTH
     **********************/
    $('#nav-legajos').onclick = ()=>{
      $('#view-legajos').classList.remove('hidden');
      $('#view-beneficios').classList.add('hidden');
    };
    $('#nav-beneficios').onclick = ()=>{
      $('#view-legajos').classList.add('hidden');
      $('#view-beneficios').classList.remove('hidden');
      renderBoard(allData.beneficios||[]);
      renderChart(allData.beneficios||[]);
      calcStats(allData.beneficios||[]);
    };

    const loginModal = $('#loginModal');
    $('#authBtn').onclick = ()=>{
      if(isAuthenticated){
        isAuthenticated=false;
        $('#authBtn').textContent='Iniciar Sesi√≥n';
        $('#addSentenceBtn').classList.add('hidden');
        showToast('Sesi√≥n finalizada');
      } else {
        loginModal.classList.add('show');
      }
    };
    $('#cancelLoginBtn').onclick = ()=> loginModal.classList.remove('show');
    $('#loginForm').onsubmit = (e)=>{
      e.preventDefault();
      if($('#password').value === PASSWORD){
        isAuthenticated = true;
        $('#authBtn').textContent = 'Cerrar Sesi√≥n';
        $('#addSentenceBtn').classList.remove('hidden');
        loginModal.classList.remove('show');
        showToast('Sesi√≥n iniciada');
      } else {
        alert('Contrase√±a incorrecta');
      }
    };

    /**********************
     * DATA (GET / POST)
     **********************/
    async function fetchData(){
      const res = await fetch(googleWebAppUrl);
      allData = await res.json();
      console.log("üì• Datos recibidos:", allData);
      renderLegajosTable(allData.legajos || []);
    }

    async function postData(payload, {refreshData=true, refreshModal=false} = {}){
      if(!isAuthenticated){ alert('Debes iniciar sesi√≥n'); return; }
      await fetch(googleWebAppUrl,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'data='+encodeURIComponent(JSON.stringify({...payload,password:PASSWORD}))
      });
      if (refreshData) await fetchData();
      if (refreshModal && isDetailModalOpen && currentLegajoId) {
        openLegajoDetail(currentLegajoId);
      }
    }

    /**********************
     * LISTADO LEGAJOS
     **********************/
    function renderLegajosTable(legajos){
      const tbody=$("#legajosTableBody"); tbody.innerHTML="";
      (legajos||[]).forEach(l=>{
        const tr=document.createElement("tr");
        tr.className="border-b hover:bg-gray-50 dark:hover:bg-[#0f172a] cursor-pointer";
        const fin = (l.fecha_fin_condena||'').toString().slice(0,10);
        tr.innerHTML = `
          <td class='px-4 py-3'>${l.id_legajo}</td>
          <td class='px-4 py-3'>${l.nro_prontuario||''}</td>
          <td class='px-4 py-3'>${l.nombre_completo||''}</td>
          <td class='px-4 py-3'>${l.defensor_actual||''}</td>
          <td class='px-4 py-3'>${l.estado_computo||''}</td>
          <td class='px-4 py-3'>${fin}</td>
        `;
        tr.onclick = ()=> openLegajoDetail(l.id_legajo);
        tbody.appendChild(tr);
      });
    }
    $('#searchLegajosInput').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#legajosTableBody tr');
      rows.forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none'; });
    });

    /**********************
     * MODAL SENTENCIA (nuevo/alta)
     **********************/
    $('#addSentenceBtn').onclick = ()=> $('#ingresarSentenciaModal').classList.add('show');
    $('#cancelIngresoBtn').onclick = ()=> $('#ingresarSentenciaModal').classList.remove('show');
    $('#ingresarSentenciaForm').onsubmit = async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      payload.es_unificada = fd.has('es_unificada');
      payload.action = payload.id_legajo ? 'addSentencia' : 'addLegajoYsentencia';
      await postData(payload, {refreshData:true, refreshModal:false});
      $('#ingresarSentenciaModal').classList.remove('show');
      showToast('Sentencia guardada');
    };

    /**********************
     * MODAL EDITAR SENTENCIA (nuevo)
     **********************/
    const editarSentenciaModal = $('#editarSentenciaModal');
    $('#cancelEditarSentenciaBtn').onclick = ()=> editarSentenciaModal.classList.remove('show');

    function openEditarSentenciaModal(id_sentencia){
      currentSentencia = (allData.sentencias||[]).find(s=>s.id_sentencia==id_sentencia);
      if(!currentSentencia) return;
      // Prellenar campos
      $('#edit_id_sentencia').value   = currentSentencia.id_sentencia || '';
      $('#edit_id_legajo').value      = currentSentencia.id_legajo || '';
      $('#edit_nro_causa').value      = currentSentencia.nro_causa || '';
      $('#edit_delito').value         = currentSentencia.delito || '';
      $('#edit_pena_impuesta').value  = currentSentencia.pena_impuesta || '';
      const fecha = (currentSentencia.fecha_sentencia||'').toString().slice(0,10);
      $('#edit_fecha_sentencia').value= fecha || '';
      $('#edit_enlace_sentencia').value= currentSentencia.enlace_sentencia || '';
      $('#edit_es_unificada').checked = !!(currentSentencia.es_unificada === true || currentSentencia.es_unificada === 'SI' || currentSentencia.es_unificada === 'true');
      editarSentenciaModal.classList.add('show');
    }

    $('#editarSentenciaForm').onsubmit = async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const obj = Object.fromEntries(fd.entries());
      obj.es_unificada = fd.has('es_unificada');
      // Actualizamos campo x campo (patr√≥n existente)
      await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'nro_causa', value:obj.nro_causa},{refreshData:false});
      await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'delito', value:obj.delito},{refreshData:false});
      await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'pena_impuesta', value:obj.pena_impuesta},{refreshData:false});
      await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'fecha_sentencia', value:obj.fecha_sentencia},{refreshData:false});
      await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'enlace_sentencia', value:obj.enlace_sentencia},{refreshData:false});
      await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'es_unificada', value:obj.es_unificada},{refreshData:true, refreshModal:true});
      editarSentenciaModal.classList.remove('show');
      showToast('Sentencia actualizada');
    };

    async function deleteSentencia(id_sentencia){
      if(!isAuthenticated) return alert('Inicia sesi√≥n');
      if(!confirm('¬øEliminar esta sentencia? Esta acci√≥n no se puede deshacer.')) return;
      await postData({action:'deleteSentencia', id_sentencia}, {refreshData:true, refreshModal:true});
      showToast('Sentencia eliminada');
    }

    /**********************
     * DETALLE LEGAJO
     **********************/
    const detailModal = $('#legajoDetailModal');
    $('#closeDetail').onclick = ()=>{
      detailModal.classList.remove('show');
      isDetailModalOpen = false;
    };

    function getLegajoById(id){ return (allData.legajos||[]).find(x=>x.id_legajo==id) || {}; }
    function getSentenciasByLegajo(id){ return (allData.sentencias||[]).filter(s=>s.id_legajo==id); }
    function getBeneficiosByLegajo(id){ return (allData.beneficios||[]).filter(b=>b.id_legajo==id); }
    function getTramitesByLegajo(id){ return (allData.tramitesVarios||[]).filter(t=>t.id_legajo==id); }

    const stateOrder = ['Pendiente SPP','Provisorio','Enviado a Defensor√≠a','Enviado a Fiscal√≠a','Aprobado'];
    const stateToKey = {
      'Pendiente SPP':'solicitudSPP',
      'Provisorio':'computoProvisorio',
      'Enviado a Defensor√≠a':'envioDefensoria',
      'Enviado a Fiscal√≠a':'envioFiscalia',
      'Aprobado':'autoAprobacion'
      // Observado queda fuera del timeline
    };
    const steps = [
      { key:'solicitudSPP',     label:'SPP/Defensor' },
      { key:'computoProvisorio',label:'Provisorio' },
      { key:'envioDefensoria',  label:'Defensor√≠a' },
      { key:'envioFiscalia',    label:'Fiscal√≠a' },
      { key:'autoAprobacion',   label:'Aprobaci√≥n' }
    ];

    function openLegajoDetail(id){
      currentLegajoId=id;
      isDetailModalOpen = true;
      const leg = getLegajoById(id);

      $('#detailTitle').textContent = `${leg.nombre_completo||'Legajo'} ‚Äî ${id}`;
      if(isAuthenticated){ $('#deleteLegajoBtn').classList.remove('hidden'); $('#editLegajoBtn').classList.remove('hidden'); }
      else { $('#deleteLegajoBtn').classList.add('hidden'); $('#editLegajoBtn').classList.add('hidden'); }

      $$('.tab-btn').forEach(b=>b.classList.remove('active'));
      $$('.tab-btn')[0].classList.add('active');

      const tabContent = $('#tab-content');

      function renderTimeline(legRef){
        const currentState = legRef.estado_computo || '';
        const currentIdx = stateOrder.indexOf(currentState);
        let fechas={}; try{ fechas = JSON.parse(legRef.fechas_clave_json||'{}'); }catch(e){}
        return `<div class="timeline">
          ${steps.map((s,i)=>`
            <div class="tl-step">
              <div class="tl-dot
                ${currentIdx>-1 && i<currentIdx ? 'completed' : ''}
                ${currentIdx===i ? 'current' : ''}"></div>
              <div class="text-xs">${s.label}</div>
              <div class="text-[11px] ${fechas[s.key]?'':'text-gray-400'}">
                ${fechas[s.key]? new Date(fechas[s.key]).toLocaleDateString(): '‚Äî'}
              </div>
            </div>
            ${i<steps.length-1?`<div class="tl-line ${(currentIdx>-1 && i<currentIdx)?'active':''}"></div>`:''}
          `).join('')}
        </div>`;
      }

      function renderInfoTab(){
        const fin = (leg.fecha_fin_condena||'').toString().slice(0,10);
        const linkBtn = leg.link_computo ? `<button id="openComputoBtnInfo" class="btn btn-primary mt-3">Abrir C√≥mputo PDF</button>` : '';
        tabContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="text-sm">ID Legajo</label><input value="${leg.id_legajo||''}" disabled class="w-full border rounded px-3 py-2 bg-gray-50 dark:bg-[#0f172a]"></div>
            <div><label class="text-sm">N¬∞ Prontuario</label><input id="editProntuario" value="${leg.nro_prontuario||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Nombre Completo</label><input id="editNombre" value="${leg.nombre_completo||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Defensor Actual</label><input id="editDefensor" value="${leg.defensor_actual||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Fiscal Actual</label><input id="editFiscal" value="${leg.fiscal_actual||''}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Estado C√≥mputo</label>
              <select id="editEstado" class="w-full border rounded px-3 py-2" disabled>
                ${['Pendiente SPP','Provisorio','Enviado a Defensor√≠a','Enviado a Fiscal√≠a','Aprobado','Observado'].map(v=>`<option ${v===(leg.estado_computo||'')?'selected':''}>${v}</option>`).join('')}
              </select>
            </div>
            <div><label class="text-sm">Fecha Fin Condena</label><input id="editFin" type="date" value="${fin}" class="w-full border rounded px-3 py-2" disabled></div>
            <div><label class="text-sm">Link C√≥mputo</label><input id="editLink" type="url" value="${leg.link_computo||''}" class="w-full border rounded px-3 py-2" disabled></div>
          </div>

          <div class="mt-6">
            <h3 class="font-semibold mb-2">L√≠nea de tiempo del c√≥mputo</h3>
            <div id="timelineWrap">${renderTimeline(leg)}</div>
            ${linkBtn}
          </div>

          ${isAuthenticated?`<div class="mt-5 flex justify-end gap-2">
            <button id="saveLegajoBtn" class="btn btn-primary hidden">Guardar</button>
          </div>`:''}
        `;

        if (leg.link_computo) {
          $('#openComputoBtnInfo').onclick = ()=> window.open(leg.link_computo, '_blank');
        }

        // Editar (desbloqueo con confirm)
        $('#editLegajoBtn').onclick = ()=>{
          if(!isAuthenticated) return alert('Inicia sesi√≥n');
          if(confirm('¬øSeguro que quieres modificar este legajo?')){
            ['#editProntuario','#editNombre','#editDefensor','#editFiscal','#editEstado','#editFin','#editLink'].forEach(sel=>{
              const el = document.querySelector(sel); if(el) el.disabled=false;
            });
            $('#saveLegajoBtn').classList.remove('hidden');

            // Cambio inmediato del estado: guarda estado_computo + fecha
            $('#editEstado').addEventListener('change', async (ev)=>{
              const newState = ev.target.value;
              await postData({ action:'updateComputoEstado', id_legajo:leg.id_legajo, newState }, {refreshData:false, refreshModal:false});
              const key = stateToKey[newState];
              if (key){
                let fechas={}; try{ fechas = JSON.parse(leg.fechas_clave_json||'{}'); }catch(e){}
                fechas[key] = new Date().toISOString();
                await postData({ action:'updateLegajoField', id_legajo:leg.id_legajo, field:'fechas_clave_json', value: JSON.stringify(fechas) }, {refreshData:true, refreshModal:true});
              } else {
                await fetchData();
                if(isDetailModalOpen) openLegajoDetail(leg.id_legajo);
              }
            }, { once:true });
          }
        };

        // Guardar con confirm + feedback
        $('#saveLegajoBtn').onclick = async ()=>{
          if(!confirm('¬øSeguro de guardar los cambios?')) return;
          const btn = $('#saveLegajoBtn');
          btn.textContent = 'Guardando datos...'; btn.disabled = true;

          await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'nro_prontuario',value:$('#editProntuario').value},{refreshData:false});
          await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'nombre_completo',value:$('#editNombre').value},{refreshData:false});
          await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'defensor_actual',value:$('#editDefensor').value},{refreshData:false});
          await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'fiscal_actual',value:$('#editFiscal').value},{refreshData:false});
          await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'fecha_fin_condena',value:$('#editFin').value},{refreshData:false});
          await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'link_computo',value:$('#editLink').value},{refreshData:true, refreshModal:true});

          btn.textContent = 'Guardar'; btn.disabled=false;
          ['#editProntuario','#editNombre','#editDefensor','#editFiscal','#editEstado','#editFin','#editLink'].forEach(sel=>{
            const el = document.querySelector(sel); if(el) el.disabled=true;
          });
          btn.classList.add('hidden');
          showToast('Datos guardados con √©xito');
        };
      }

      function renderSentenciasTab(){
        const sent = getSentenciasByLegajo(id);
        $('#tab-content').innerHTML = sent.length
          ? sent.map(s=>`
            <div class='p-3 border rounded flex items-center justify-between gap-3'>
              <div class='min-w-0'>
                <div class='font-medium truncate'>Causa ${s.nro_causa}</div>
                <div class='text-sm opacity-80 truncate'>${s.delito} ‚Ä¢ ${s.pena_impuesta} ‚Ä¢ ${ (s.fecha_sentencia||'').toString().slice(0,10) }</div>
              </div>
              <div class='flex items-center gap-2 flex-shrink-0'>
                ${s.enlace_sentencia?`<a class='btn btn-secondary' target='_blank' href='${s.enlace_sentencia}'>Ver</a>`:''}
                ${isAuthenticated?`<button class='btn btn-secondary' onclick="openEditarSentenciaModal('${s.id_sentencia}')">Modificar</button>`:''}
                ${isAuthenticated?`<button class='btn btn-danger' onclick="deleteSentencia('${s.id_sentencia}')">Eliminar</button>`:''}
              </div>
            </div>`).join('')
          : '<div class="text-sm opacity-70">Sin sentencias.</div>';
      }

      function renderComputoTab(){
        const linkBtn = leg.link_computo ? `<button id="openComputoBtnComp" class="btn btn-primary mt-3">Abrir C√≥mputo PDF</button>` : '';
        $('#tab-content').innerHTML = `
          <div id="timelineWrap">${renderTimeline(leg)}</div>
          ${linkBtn}
        `;
        if (leg.link_computo) {
          $('#openComputoBtnComp').onclick = ()=> window.open(leg.link_computo, '_blank');
        }
      }

      function renderTramitesTab(){
        const ben  = getBeneficiosByLegajo(id);
        const tram = getTramitesByLegajo(id);
        const all  = ben.concat(tram);
        $('#tab-content').innerHTML = (all.length
          ? all.map(t=>`
            <div class='p-3 border rounded'>
              <div class='font-medium'>${t.expediente||t.tipo_tramite||''}</div>
              <div class='text-sm opacity-80'>${t.beneficio||t.tipo_tramite||''} ‚Ä¢ Estado: ${t.estado||''}</div>
            </div>`).join('')
          : '<div class="text-sm opacity-70">Sin tr√°mites/beneficios.</div>');
      }

      // Bind de tabs
      $$('.tab-btn').forEach(btn=>{
        btn.onclick = ()=>{
          $$('.tab-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.dataset.tab;
          if(tab==='info')      renderInfoTab();
          if(tab==='sentencias')renderSentenciasTab();
          if(tab==='computo')   renderComputoTab();
          if(tab==='tramites')  renderTramitesTab();
        };
      });
      renderInfoTab(); // default

      // Eliminar legajo
      $('#deleteLegajoBtn').onclick = async ()=>{
        if(!isAuthenticated) return alert('Inicia sesi√≥n');
        if(confirm('¬øEliminar legajo y TODOS sus registros vinculados? Esta acci√≥n no se puede deshacer.')){
          await postData({action:'deleteLegajoCompleto',id_legajo:id}, {refreshData:true, refreshModal:false});
          detailModal.classList.remove('show');
          isDetailModalOpen = false;
          showToast('Legajo eliminado');
        }
      };

      detailModal.classList.add('show');
    }

    // Helpers timeline usables por botones (a√∫n disponibles si los llamara el backend)
    window.setFechaClave = async function(id, key){
      const leg = (allData.legajos||[]).find(x=>x.id_legajo==id) || {};
      let fechas={}; try{ fechas = JSON.parse(leg.fechas_clave_json||'{}'); }catch(e){}
      fechas[key] = new Date().toISOString();
      await postData({ action:'updateLegajoField', id_legajo:id, field:'fechas_clave_json', value: JSON.stringify(fechas) }, {refreshData:true, refreshModal:true});
    }
    window.updateEstadoYFecha = async function(id, newState, key){
      await postData({ action:'updateComputoEstado', id_legajo:id, newState }, {refreshData:false, refreshModal:false});
      if (key){
        await setFechaClave(id, key);
      } else {
        await fetchData();
        if(isDetailModalOpen) openLegajoDetail(id);
      }
    }

    /**********************
     * KANBAN BENEFICIOS
     **********************/
    const KANBAN_COLUMNS = ['Ingresado','En Gabinete','Regreso','Fiscal√≠a','Defensor√≠a','Para Despacho','Finalizado'];

    function renderBoard(beneficios){
      const board = $('#kanban-board'); if(!board) return;
      board.innerHTML = '';

      const container = document.createElement('div');
      container.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

      KANBAN_COLUMNS.forEach(status=>{
        const col = document.createElement('div');
        col.className = 'p-3 relief-border';
        col.innerHTML = `<h3 class='font-semibold mb-2'>${status}</h3><div class='card-container min-h-[140px]' data-status='${status}' ondragover='event.preventDefault()'></div>`;
        container.appendChild(col);
      });
      board.appendChild(container);

      (beneficios||[]).forEach(b=>{
        const list = board.querySelector(`.card-container[data-status="${b.estado}"]`);
        if(list){
          const card = document.createElement('div');
          card.className = 'p-3 mb-2 border rounded bg-white dark:bg-[#0b1222] card-drag';
          card.draggable = true;
          card.dataset.id = b.id_beneficio_legajo || b.id;
          card.innerHTML = `<div class='font-medium'>${b.interno||''}</div><div class='text-xs opacity-80'>${b.expediente||''} ‚Ä¢ ${b.beneficio||''}</div>`;
          card.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',card.dataset.id));
          list.appendChild(card);
        }
      });

      board.querySelectorAll('.card-container').forEach(c=> c.addEventListener('drop', async e=>{
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const card = document.querySelector(`[data-id="${id}"]`);
        if(card){
          c.appendChild(card);
          const newStatus = c.dataset.status;
          await postData({ action:'updateBeneficioStatus', id_beneficio_legajo:id, newStatus }, {refreshData:true, refreshModal:false});
          showToast(`Estado movido a: ${newStatus}`, 1500);
        }
      }));
    }

    function calcStats(beneficios){
      $('#total-activos').textContent = (beneficios||[]).filter(b=>b.estado!=='Finalizado').length;
      $('#avg-time').textContent = '‚Äî';
    }

    let chartInstance = null;
    function renderChart(beneficios){
      const el = document.getElementById('benefitsChart'); if(!el) return;
      const ctx = el.getContext('2d');
      const counts = {};
      (beneficios||[]).forEach(b=> counts[b.beneficio]=(counts[b.beneficio]||0)+1);
      const labels = Object.keys(counts);
      const data   = labels.map(l=>counts[l]);
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ label:'Beneficios por tipo', data }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } } }
      });
    }

    /**********************
     * INICIO
     **********************/
    applyThemeFromStorage();

    // Cerrar modales al hacer click fuera (y marcar estado)
    document.querySelectorAll('.modal-backdrop').forEach(m=>{
      m.addEventListener('click', (e)=>{
        if(e.target===m){
          m.classList.remove('show');
          if(m.id==='legajoDetailModal') isDetailModalOpen = false;
        }
      });
    });

    // Cargar datos iniciales
    fetchData();
  </script>
</body>
</html>

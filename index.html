<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gesti√≥n Integral de Legajos - Juzgado de Ejecuci√≥n Penal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --color-primary:#1e3a8a;
      --color-secondary:#f3f4f6;
      --color-accent:#2563eb;
      --light-bg-general:#e5e7eb;
      --light-bg-content:#ffffff;
      --light-text-main:#111827;
      --light-card-bg:#ffffff;
      --light-card-text-main:#111827;
      --light-card-text-secondary:#6b7280;
      --dark-bg-general:#0d1117;
      --dark-bg-content:#161b22;
      --dark-text-main:#f0f6fc;
      --dark-card-bg:#21262d;
      --dark-card-text-main:#f0f6fc;
      --dark-card-text-secondary:#8b949e;
      --dark-border:#30363d;
    }

    html,body{height:100%}
    body{font-family:'Inter',sans-serif;background:#f7f7f8;color:#111827}

    header{background:var(--color-primary);color:white;padding:1rem 1.5rem;border-radius:0.75rem}
    header h1{font-size:1.75rem;font-weight:700}

    .relief-border{border:1px solid #e5e7eb;border-radius:12px;background:white}
    .btn{transition:all .2s ease;font-weight:600;border-radius:0.6rem;padding:0.6rem 1rem}
    .btn:hover{opacity:.95}
    .btn-primary{background:var(--color-accent);color:white}
    .btn-secondary{background:var(--color-secondary);color:#111827}
    .btn-danger{background:#dc2626;color:white}
    .tab-btn{padding:0.6rem 1rem;border-radius:.5rem}
    .tab-btn.active{border-bottom:3px solid var(--color-accent);font-weight:600}

    /* Modal base */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.40);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{background:white;border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.18)}

    /* Dark mode */
    .dark{background:#0f172a;color:#e5e7eb}
    .dark header{background:#0b1222;color:#e5e7eb}
    .dark .relief-border{border-color:#1f2937;background:#0b1222}
    .dark .modal{background:#0b1222;color:#e5e7eb}
    .dark table{color:#e5e7eb}
    .dark thead{color:#e5e7eb}
    .dark .btn-secondary{background:#111827;color:#e5e7eb;border:1px solid #1f2937}
    .dark input, .dark select, .dark textarea{ background:#0f172a;color:#e5e7eb;border-color:#334155 }
    .dark .text-gray-500, .dark .text-gray-600{ color:#cbd5e1 !important }

    /* Timeline */
    .timeline{display:flex;align-items:center;gap:14px}
    .tl-step{display:flex;flex-direction:column;align-items:center;gap:6px;min-width:90px;text-align:center}
    .tl-dot{width:14px;height:14px;border-radius:9999px;background:#cfd4dc;transition:all .25s}
    .tl-dot.completed{background:var(--color-accent)}
    .tl-dot.current{background:#fff;border:3px solid var(--color-accent)}
    .tl-line{flex:1;height:3px;background:#cfd4dc;transition:background .25s}
    .tl-line.active{background:var(--color-accent)}

    /* Toast */
    #toast{position:fixed;bottom:18px;right:18px;z-index:60;display:none}
    .toast-card{background:#111827;color:white;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);max-width:340px}

    /* Tabla responsiva */
    .table-wrap{overflow-x:auto}
    th,td{white-space:nowrap}

    /* Kanban (monitor beneficios) */
    .kanban-column { min-height: 400px; display: flex; flex-direction: column; }
    .card-container { max-height: 60vh; overflow-y: auto; padding-right: 8px; flex-grow: 1; }
    .kanban-card { position: relative; background-color: var(--light-card-bg); }
    .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.05); }
    .dark .kanban-column, .dark .modal{ background-color: var(--dark-bg-content); border-color: var(--dark-border); }
    .dark .kanban-card { background-color: var(--dark-card-bg); border-color: var(--dark-border); }
    .drag-over { background-color: #dbeafe; }
    .dark .drag-over { background-color: #1e3a8a; }
    .card-text-main { color: var(--light-card-text-main); }
    .card-text-secondary { color: var(--light-card-text-secondary); }
    .dark .card-text-main { color: var(--dark-card-text-main); }
    .dark .card-text-secondary { color: var(--dark-card-text-secondary); }
    .dragging { opacity: 0.5; transform: rotate(2deg); }

    /* Mejoras visuales del panel Beneficios */
    .bg-white-relief{ background:#fff }
    .dark .bg-white-relief{ background:var(--dark-bg-content) }
  </style>
</head>

<body id="body">
  <div class="container mx-auto max-w-7xl px-3 pt-4">
    <header class="flex items-center justify-between">
      <div>
        <h1>Juzgado de Ejecuci√≥n Penal N¬∞2</h1>
        <p class="opacity-90">Sistema de Gesti√≥n Integral de Legajos</p>
      </div>
      <div class="flex items-center gap-2 sm:gap-3">
        <button id="nav-legajos" class="btn btn-primary">Legajos</button>
        <button id="nav-beneficios" class="btn btn-secondary">Beneficios</button>
        <button id="settingsBtn" class="btn btn-secondary" title="Configuraci√≥n">‚öôÔ∏è</button>
        <button id="themeToggle" class="btn btn-secondary" title="Modo claro/oscuro">üåô</button>
        <button id="authBtn" class="btn btn-primary">Iniciar Sesi√≥n</button>
      </div>
    </header>
  </div>

  <main id="app" class="container mx-auto max-w-7xl px-3 mt-6 space-y-6">
    <section id="view-legajos">
      <div class="relief-border p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <input id="searchLegajosInput" placeholder="Buscar por prontuario o nombre..." class="border px-3 py-2 rounded w-full sm:w-1/3">
          <div class="flex items-center gap-2">
            <button id="addSentenceBtn" class="btn btn-primary hidden">+ Ingresar Sentencia</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="w-full text-left text-base">
            <thead class="text-xs uppercase bg-gray-50 dark:bg-[#111827]">
              <tr>
                <th class="px-4 py-2">ID Legajo</th>
                <th class="px-4 py-2">Prontuario</th>
                <th class="px-4 py-2">Nombre</th>
                <th class="px-4 py-2">Defensor</th>
                <th class="px-4 py-2">Estado de C√≥mputo</th>
                <th class="px-4 py-2">Fin Condena</th>
              </tr>
            </thead>
            <tbody id="legajosTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="view-beneficios" class="hidden">
      <div class="relief-border p-4">
        <div class="flex flex-col md:flex-row justify-between items-center gap-3">
          <div class="flex items-center gap-3">
            <input type="text" id="searchInput" placeholder="Buscar por N¬∞ o Interno..." class="w-full md:w-72 px-4 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
              <input type="checkbox" id="alarmToggle">
              <span>Alarmas visuales</span>
            </label>
          </div>
          <div class="flex items-center gap-2">
            <button id="addCaseBtn" class="btn btn-primary hidden">+ Nuevo Tr√°mite</button>
            <button id="refreshBenefitsBtn" class="btn btn-secondary">Actualizar</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white p-4 rounded-xl relief-border bg-white-relief">
          <h3 class="text-sm font-medium dark:text-gray-400">Total Activos</h3>
          <p id="total-activos" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-white p-4 rounded-xl relief-border bg-white-relief">
          <h3 class="text-sm font-medium dark:text-gray-400">Tiempo Prom. en Gabinete</h3>
          <p id="avg-time" class="text-3xl font-bold">N/A</p>
        </div>
      </div>

      <div id="loader" class="text-center py-10 hidden">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-2 text-gray-500">Cargando datos...</p>
      </div>

      <div id="kanban-board" class="relief-border p-4"></div>

      <div id="chart-container" class="bg-white p-6 rounded-xl mt-6 relief-border bg-white-relief">
        <h3 class="text-lg font-medium mb-4 dark:text-white">Distribuci√≥n de Beneficios Activos</h3>
        <div class="relative h-80"><canvas id="benefitsChart"></canvas></div>
      </div>
    </section>
  </main>

  <div id="toast"><div class="toast-card" id="toastText">Listo</div></div>

  <div id="loginModal" class="modal-backdrop">
    <div class="modal p-6 w-96">
      <h2 class="text-lg font-bold mb-3">Acceso de Administrador</h2>
      <form id="loginForm" class="space-y-3">
        <input id="password" type="password" placeholder="Contrase√±a" class="w-full border px-3 py-2 rounded" required>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelLoginBtn" class="btn btn-secondary">Cancelar</button>
          <button class="btn btn-primary">Ingresar</button>
        </div>
        <p id="loginError" class="text-red-500 text-sm hidden">Contrase√±a incorrecta.</p>
      </form>
    </div>
  </div>

  <div id="settingsModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-2xl">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Configuraci√≥n de Interfaz</h2>
        <button id="closeSettings" class="btn btn-secondary">Cerrar</button>
      </div>
      
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Tema General</h3>
          <div class="grid grid-cols-2 gap-4">
            <label class="text-sm">Color Primario (encabezado)
              <input id="colorPrimary" type="color" class="w-full h-10 border rounded mt-1" value="#1e3a8a">
            </label>
            <label class="text-sm">Color de Acci√≥n (botones)
              <input id="colorAccent" type="color" class="w-full h-10 border rounded mt-1" value="#2563eb">
            </label>
          </div>
        </div>

        <div>
          <h3 class="font-semibold mb-2">Colores de Beneficios</h3>
          <div id="benefitColorSettings" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
            </div>
        </div>
      </div>

      <div class="flex items-center justify-between mt-6">
        <div class="flex items-center gap-2">
          <input id="darkToggle" type="checkbox"><label for="darkToggle" class="text-sm">Usar modo oscuro</label>
        </div>
        <div class="flex gap-2">
          <button id="resetTheme" class="btn btn-secondary">Restablecer</button>
          <button id="saveTheme" class="btn btn-primary">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="ingresarSentenciaModal" class="modal-backdrop">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Ingresar Nueva Sentencia</h2>
      <form id="ingresarSentenciaForm" class="space-y-3">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm">ID Legajo (si existe)</label><input name="id_legajo" class="w-full border px-2 py-2 rounded" placeholder="Dejar vac√≠o para crear legajo nuevo"></div>
          <div><label class="text-sm">N¬∞ Causa</label><input name="nro_causa" class="w-full border px-2 py-2 rounded" required></div>
          <div><label class="text-sm">Fecha Sentencia</label><input name="fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Delito</label><input name="delito" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Pena impuesta</label><input name="pena_impuesta" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Enlace Sentencia (opcional)</label><input name="enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded"></div>
          <div class="col-span-2 flex items-center gap-3"><input id="es_unificada" name="es_unificada" type="checkbox"><label for="es_unificada" class="text-sm">Es sentencia unificada</label></div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelIngresoBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Sentencia</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editarSentenciaModal" class="modal-backdrop">
    <div class="modal p-6 w-[760px] max-w-full overflow-y-auto max-h-[90vh]">
      <h2 class="text-lg font-bold mb-3">Editar Sentencia</h2>
      <form id="editarSentenciaForm" class="space-y-3">
        <input type="hidden" name="id_sentencia" id="edit_id_sentencia">
        <input type="hidden" name="id_legajo" id="edit_id_legajo">
        <div class="grid grid-cols-2 gap-3">
          <div><label class="text-sm">N¬∞ Causa</label><input name="nro_causa" id="edit_nro_causa" class="w-full border px-2 py-2 rounded" required></div>
          <div><label class="text-sm">Fecha Sentencia</label><input name="fecha_sentencia" id="edit_fecha_sentencia" type="date" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Delito</label><input name="delito" id="edit_delito" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Pena impuesta</label><input name="pena_impuesta" id="edit_pena_impuesta" class="w-full border px-2 py-2 rounded" required></div>
          <div class="col-span-2"><label class="text-sm">Enlace Sentencia</label><input name="enlace_sentencia" id="edit_enlace_sentencia" type="url" class="w-full border px-2 py-2 rounded"></div>
          <div class="col-span-2 flex items-center gap-3"><input id="edit_es_unificada" name="es_unificada" type="checkbox"><label for="edit_es_unificada" class="text-sm">Es sentencia unificada</label></div>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelEditarSentenciaBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <div id="legajoDetailModal" class="modal-backdrop">
    <div class="modal p-6 w-[1040px] max-w-full overflow-y-auto max-h-[95vh]">
      <div class="flex justify-between items-center mb-4">
        <h2 id="detailTitle" class="text-xl font-bold">Detalle de Legajo</h2>
        <div class="flex items-center gap-2">
          <button id="editLegajoBtn" class="btn btn-secondary hidden">Modificar</button>
          <button id="deleteLegajoBtn" class="btn btn-danger hidden">Eliminar</button>
          <button id="closeDetail" class="btn btn-secondary">Cerrar</button>
        </div>
      </div>

      <div class="border-b mb-4 flex gap-4 text-base">
        <button class="tab-btn active" data-tab="info">Datos del Legajo</button>
        <button class="tab-btn" data-tab="sentencias">Sentencias</button>
        <button class="tab-btn" data-tab="computo">C√≥mputo</button>
        <button class="tab-btn" data-tab="tramites">Tr√°mites/Beneficios</button>
      </div>

      <div id="tab-content" class="space-y-4"></div>
    </div>
  </div>

  <div id="caseModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-xl">
      <h2 id="modalTitle" class="text-xl font-bold mb-4">Agregar Nuevo Tr√°mite</h2>
      <div class="max-h-[70vh] overflow-y-auto pr-2">
        <form id="caseForm" class="space-y-4">
          <input type="hidden" id="caseId" name="caseId">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">Legajo Asociado <span class="text-red-500">*</span></label>
              <select id="id_legajo" name="id_legajo" class="mt-1 block w-full px-3 py-2 border rounded-xl" required>
                </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Tipo de Beneficio <span class="text-red-500">*</span></label>
              <select id="beneficio" name="beneficio" class="mt-1 block w-full px-3 py-2 border rounded-xl bg-white dark:bg-gray-700" required>
                <option>Salidas Transitorias</option>
                <option>Prisi√≥n Domiciliaria</option>
                <option>Est√≠mulo Educativo</option>
                <option>Libertad Asistida</option>
                <option>Libertad Condicional</option>
                <option>R√©gimen Preparatorio</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">N¬∞ de Expediente</label>
              <input type="text" id="expediente" name="expediente" class="mt-1 block w-full px-3 py-2 border rounded-xl">
            </div>
            <div>
              <label class="block text-sm font-medium">Nombre del Interno/a (auto-completado)</label>
              <input type="text" id="interno" name="interno" class="mt-1 block w-full px-3 py-2 border rounded-xl" readonly>
            </div>
          </div>

          <div class="border-t pt-4 mt-4">
              <label for="observacion" class="block text-sm font-medium">Observaciones del estado actual</label>
              <textarea id="observacion" name="observacion" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-xl"></textarea>
              <div id="charCounter" class="text-xs text-right text-gray-500 dark:text-gray-400 mt-1">0 / 255</div>
          </div>
          
          <div class="border-t pt-4 mt-4">
            <h3 class="text-md font-semibold mb-2">Fechas Clave del Tr√°mite</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                  <label class="block text-sm font-medium">Fecha de Ingreso</label>
                  <input type="date" id="fechaIngreso" name="fechaIngreso" class="mt-1 block w-full px-3 py-2 border rounded-xl" required>
              </div>
              <div>
                  <label class="block text-sm font-medium">Env√≠o a Gabinete</label>
                  <input type="date" id="fechaEnvioGabinete" name="fechaEnvioGabinete" class="mt-1 block w-full px-3 py-2 border rounded-xl">
              </div>
              <div>
                  <label class="block text-sm font-medium">Regreso de Gabinete</label>
                  <input type="date" id="fechaRegresoGabinete" name="fechaRegresoGabinete" class="mt-1 block w-full px-3 py-2 border rounded-xl">
              </div>
              <div>
                  <label class="block text-sm font-medium">Env√≠o a Fiscal√≠a</label>
                  <input type="date" id="fechaEnvioFiscalia" name="fechaEnvioFiscalia" class="mt-1 block w-full px-3 py-2 border rounded-xl">
              </div>
              <div>
                  <label class="block text-sm font-medium">Env√≠o a Defensor√≠a</label>
                  <input type="date" id="fechaEnvioDefensoria" name="fechaEnvioDefensoria" class="mt-1 block w-full px-3 py-2 border rounded-xl">
              </div>
              <div>
                  <label class="block text-sm font-medium">Para Despacho</label>
                  <input type="date" id="fechaDespacho" name="fechaDespacho" class="mt-1 block w-full px-3 py-2 border rounded-xl">
              </div>
            </div>
          </div>
          
          <div id="finalizeFieldsContainer" class="border-t pt-4 mt-4">
            <h3 class="text-md font-semibold mb-2">Datos de Finalizaci√≥n</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium">Fecha de Finalizaci√≥n</label>
                    <input type="date" id="fechaFinalizado" name="fechaFinalizado" class="mt-1 block w-full px-3 py-2 border rounded-xl">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">Motivo de Finalizaci√≥n</label>
                    <textarea id="motivoFinalizadoEdit" name="motivoFinalizado" rows="2" class="mt-1 block w-full px-3 py-2 border rounded-xl"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium">Enlace a Resoluci√≥n</label>
                    <input type="url" id="enlaceResolucionEdit" name="enlaceResolucion" placeholder="https://..." class="mt-1 block w-full px-3 py-2 border rounded-xl">
                </div>
            </div>
          </div>
        </form>
      </div>
      <div class="flex justify-between items-center pt-4">
        <button type="button" id="deleteCaseBtn" class="btn btn-danger hidden">Eliminar</button>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" form="caseForm" id="saveCaseBtn" class="btn btn-primary w-36 flex justify-center items-center">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="finalizeModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Finalizar Tr√°mite</h2>
      <form id="finalizeForm" class="space-y-4">
        <input type="hidden" id="finalizeCaseId">
        <div>
          <label class="block text-sm font-medium">Motivo / Raz√≥n de Finalizaci√≥n</label>
          <textarea id="motivoFinalizado" rows="3" class="mt-1 block w-full px-3 py-2 border rounded-xl" required></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium">Enlace a Resoluci√≥n (Opcional)</label>
          <input type="url" id="enlaceResolucion" placeholder="https://..." class="mt-1 block w-full px-3 py-2 border rounded-xl">
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="cancelFinalizeBtn" class="btn btn-secondary">Cancelar</button>
          <button type="submit" class="btn btn-primary">Confirmar Finalizaci√≥n</button>
        </div>
      </form>
    </div>
  </div>

  <div id="alertModal" class="modal-backdrop">
    <div class="modal p-6 w-full max-w-md">
      <h2 id="alertTitle" class="text-xl font-bold mb-3 text-yellow-500">Alerta</h2>
      <p id="alertMessage" class="text-gray-700 dark:text-gray-200 mb-4"></p>
      <div class="flex justify-end">
        <button type="button" id="closeAlertBtn" class="btn btn-secondary">Entendido</button>
      </div>
    </div>
  </div>

  <footer class="text-center py-8 mt-8 border-t border-gray-200 dark:border-gray-700">
    <p class="text-sm text-gray-500">By create RBM 2025</p>
  </footer>

<script>
/**********************
 * CONFIG
 **********************/
const googleWebAppUrl = "https://script.google.com/macros/s/AKfycbyeY6uqUypUlY_JZnWxA09ygNdf9wd54LrHPWXSLuhK00nF370qrS1N3t9oZ2Fk5bJU/exec";
const PASSWORD = "454545"; // ¬°ADVERTENCIA DE SEGURIDAD! Esto no es seguro para producci√≥n.
const CHAR_LIMIT = 255;

let allData = { legajos: [], sentencias: [], beneficios: [], tramitesVarios: [] };
let isAuthenticated = false;
let currentLegajoId = null;
let isDetailModalOpen = false;
let currentSentencia = null;

const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

/**********************
 * THEME / SETTINGS
 **********************/
function applyThemeFromStorage(){
  const p = localStorage.getItem('theme_primary');
  const a = localStorage.getItem('theme_accent');
  const d = localStorage.getItem('theme_dark')==='1';
  if(p) document.documentElement.style.setProperty('--color-primary', p);
  if(a) document.documentElement.style.setProperty('--color-accent', a);
  if(d) $('#body').classList.add('dark');
  loadBenefitColors(); // Cargar colores de beneficios
}
function showToast(msg, ms=2000){
  const t = $('#toast'), tx = $('#toastText');
  tx.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=>{ t.style.display='none'; }, ms);
}
$('#themeToggle').addEventListener('click', ()=>{
  const bodyEl = $('#body');
  bodyEl.classList.toggle('dark');
  localStorage.setItem('theme_dark', bodyEl.classList.contains('dark')?'1':'0');
});
$('#settingsBtn').onclick = ()=>{
  $('#settingsModal').classList.add('show');
  $('#colorPrimary').value = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim() || '#1e3a8a';
  $('#colorAccent').value  = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim() || '#2563eb';
  $('#darkToggle').checked = $('#body').classList.contains('dark');
  renderBenefitColorSettings(); // Renderizar pickers de colores
};
$('#closeSettings').onclick = ()=> $('#settingsModal').classList.remove('show');
$('#resetTheme').onclick = ()=>{
  localStorage.removeItem('theme_primary');
  localStorage.removeItem('theme_accent');
  localStorage.removeItem('theme_dark');
  localStorage.removeItem('benefit_colors'); // Resetear colores de beneficios
  document.documentElement.style.setProperty('--color-primary','#1e3a8a');
  document.documentElement.style.setProperty('--color-accent','#2563eb');
  $('#body').classList.remove('dark');
  loadBenefitColors(); // Recargar colores por defecto
  renderBoard(casesData); // Refrescar tablero
};
$('#saveTheme').onclick = ()=>{
  // Guardar tema general
  const p = $('#colorPrimary').value;
  const a = $('#colorAccent').value;
  const d = $('#darkToggle').checked;
  document.documentElement.style.setProperty('--color-primary', p);
  document.documentElement.style.setProperty('--color-accent', a);
  localStorage.setItem('theme_primary', p);
  localStorage.setItem('theme_accent', a);
  localStorage.setItem('theme_dark', d?'1':'0');
  d? $('#body').classList.add('dark') : $('#body').classList.remove('dark');
  
  // Guardar colores de beneficios
  const customColors = {};
  $$('#benefitColorSettings input[type="color"]').forEach(input => {
      customColors[input.dataset.benefit] = input.value;
  });
  localStorage.setItem('benefit_colors', JSON.stringify(customColors));
  loadBenefitColors();

  $('#settingsModal').classList.remove('show');
  showToast('Preferencias guardadas');
  renderBoard(casesData); // Refrescar tablero con nuevos colores
};

/**********************
 * NAV / AUTH
 **********************/
$('#nav-legajos').onclick = ()=>{
  $('#view-legajos').classList.remove('hidden');
  $('#view-beneficios').classList.add('hidden');
};
$('#nav-beneficios').onclick = ()=>{
  $('#view-legajos').classList.add('hidden');
  $('#view-beneficios').classList.remove('hidden');
  renderBoard(casesData);
  renderChart(casesData);
  calcStats(casesData);
};

const loginModal = $('#loginModal');
$('#authBtn').onclick = ()=>{
  if(isAuthenticated){
    isAuthenticated=false;
    $('#authBtn').textContent='Iniciar Sesi√≥n';
    $('#addSentenceBtn').classList.add('hidden');
    $('#addCaseBtn').classList.add('hidden');
    showToast('Sesi√≥n finalizada');
    renderBoard(casesData);
  } else {
    loginModal.classList.add('show');
  }
};
$('#cancelLoginBtn').onclick = ()=> loginModal.classList.remove('show');
$('#loginForm').onsubmit = (e)=>{
  e.preventDefault();
  if($('#password').value === PASSWORD){
    isAuthenticated = true;
    $('#authBtn').textContent = 'Cerrar Sesi√≥n';
    $('#addSentenceBtn').classList.remove('hidden');
    $('#addCaseBtn').classList.remove('hidden');
    loginModal.classList.remove('show');
    $('#loginError').classList.add('hidden');
    showToast('Sesi√≥n iniciada');
    renderBoard(casesData);
  } else {
    $('#loginError').classList.remove('hidden');
  }
};

/**********************
 * DATA (GET / POST)
 **********************/
async function fetchData(){
  const res = await fetch(googleWebAppUrl);
  allData = await res.json();
  renderLegajosTable(allData.legajos || []);
  hydrateCasesFromBeneficios(allData.beneficios || []);
  if (!$('#view-beneficios').classList.contains('hidden')) {
    renderBoard(casesData);
    renderChart(casesData);
    calcStats(casesData);
  }
}

async function postData(payload, {refreshData=true, refreshModal=false} = {}){
  if(!isAuthenticated){ alert('Debes iniciar sesi√≥n'); return; }
  await fetch(googleWebAppUrl,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:'data='+encodeURIComponent(JSON.stringify({...payload,password:PASSWORD}))
  });
  if (refreshData) await fetchData();
  if (refreshModal && isDetailModalOpen && currentLegajoId) {
    openLegajoDetail(currentLegajoId);
  }
}

/**********************
 * LISTADO LEGAJOS
 **********************/
function renderLegajosTable(legajos){
  const tbody=$("#legajosTableBody"); tbody.innerHTML="";
  (legajos||[]).forEach(l=>{
    const tr=document.createElement("tr");
    tr.className="border-b hover:bg-gray-50 dark:hover:bg-[#0f172a] cursor-pointer";
    const fin = (l.fecha_fin_condena||'').toString().slice(0,10);
    tr.innerHTML = `<td class='px-4 py-3'>${l.id_legajo}</td>
      <td class='px-4 py-3'>${l.nro_prontuario||''}</td>
      <td class='px-4 py-3'>${l.nombre_completo||''}</td>
      <td class='px-4 py-3'>${l.defensor_actual||''}</td>
      <td class='px-4 py-3'>${l.estado_computo||''}</td>
      <td class='px-4 py-3'>${fin}</td>`;
    tr.onclick = ()=> openLegajoDetail(l.id_legajo);
    tbody.appendChild(tr);
  });
}
$('#searchLegajosInput').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('#legajosTableBody tr');
  rows.forEach(r=>{ r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none'; });
});

/**********************
 * MODAL SENTENCIA (nuevo/alta)
 **********************/
$('#addSentenceBtn').onclick = ()=> $('#ingresarSentenciaModal').classList.add('show');
$('#cancelIngresoBtn').onclick = ()=> $('#ingresarSentenciaModal').classList.remove('show');
$('#ingresarSentenciaForm').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const payload = Object.fromEntries(fd.entries());
  payload.es_unificada = fd.has('es_unificada');
  payload.action = payload.id_legajo ? 'addSentencia' : 'addLegajoYsentencia';
  await postData(payload, {refreshData:true, refreshModal:false});
  $('#ingresarSentenciaModal').classList.remove('show');
  showToast('Sentencia guardada');
};

/**********************
 * MODAL EDITAR SENTENCIA
 **********************/
const editarSentenciaModal = $('#editarSentenciaModal');
$('#cancelEditarSentenciaBtn').onclick = ()=> editarSentenciaModal.classList.remove('show');

function openEditarSentenciaModal(id_sentencia){
  currentSentencia = (allData.sentencias||[]).find(s=>s.id_sentencia==id_sentencia);
  if(!currentSentencia) return;
  $('#edit_id_sentencia').value   = currentSentencia.id_sentencia || '';
  $('#edit_id_legajo').value      = currentSentencia.id_legajo || '';
  $('#edit_nro_causa').value      = currentSentencia.nro_causa || '';
  $('#edit_delito').value         = currentSentencia.delito || '';
  $('#edit_pena_impuesta').value  = currentSentencia.pena_impuesta || '';
  const fecha = (currentSentencia.fecha_sentencia||'').toString().slice(0,10);
  $('#edit_fecha_sentencia').value= fecha || '';
  $('#edit_enlace_sentencia').value= currentSentencia.enlace_sentencia || '';
  $('#edit_es_unificada').checked = !!(currentSentencia.es_unificada === true || currentSentencia.es_unificada === 'SI' || currentSentencia.es_unificada === 'true');
  editarSentenciaModal.classList.add('show');
}

$('#editarSentenciaForm').onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  const obj = Object.fromEntries(fd.entries());
  obj.es_unificada = fd.has('es_unificada');
  // NOTA: Esto podr√≠a optimizarse en una sola llamada al backend
  await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'nro_causa', value:obj.nro_causa},{refreshData:false});
  await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'delito', value:obj.delito},{refreshData:false});
  await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'pena_impuesta', value:obj.pena_impuesta},{refreshData:false});
  await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'fecha_sentencia', value:obj.fecha_sentencia},{refreshData:false});
  await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'enlace_sentencia', value:obj.enlace_sentencia},{refreshData:false});
  await postData({action:'updateSentenciaField', id_sentencia:obj.id_sentencia, field:'es_unificada', value:obj.es_unificada},{refreshData:true, refreshModal:true});
  editarSentenciaModal.classList.remove('show');
  showToast('Sentencia actualizada');
};

async function deleteSentencia(id_sentencia){
  if(!isAuthenticated) return alert('Inicia sesi√≥n');
  if(!confirm('¬øEliminar esta sentencia? Esta acci√≥n no se puede deshacer.')) return;
  await postData({action:'deleteSentencia', id_sentencia}, {refreshData:true, refreshModal:true});
  showToast('Sentencia eliminada');
}

/**********************
 * DETALLE LEGAJO
 **********************/
const detailModal = $('#legajoDetailModal');
$('#closeDetail').onclick = ()=>{
  detailModal.classList.remove('show');
  isDetailModalOpen = false;
};
function getLegajoById(id){ return (allData.legajos||[]).find(x=>x.id_legajo==id) || {}; }
function getSentenciasByLegajo(id){ return (allData.sentencias||[]).filter(s=>s.id_legajo==id); }
function getBeneficiosByLegajo(id){ return (allData.beneficios||[]).filter(b=>b.id_legajo==id); }
function getTramitesByLegajo(id){ return (allData.tramitesVarios||[]).filter(t=>t.id_legajo==id); }

const stateOrder = ['Pendiente SPP','Provisorio','Enviado a Defensor√≠a','Enviado a Fiscal√≠a','Aprobado'];
const stateToKey = {
  'Pendiente SPP':'solicitudSPP',
  'Provisorio':'computoProvisorio',
  'Enviado a Defensor√≠a':'envioDefensoria',
  'Enviado a Fiscal√≠a':'envioFiscalia',
  'Aprobado':'autoAprobacion'
};
const steps = [
  { key:'solicitudSPP',     label:'SPP/Defensor' },
  { key:'computoProvisorio',label:'Provisorio' },
  { key:'envioDefensoria',  label:'Defensor√≠a' },
  { key:'envioFiscalia',    label:'Fiscal√≠a' },
  { key:'autoAprobacion',   label:'Aprobaci√≥n' }
];

function openLegajoDetail(id){
  currentLegajoId=id;
  isDetailModalOpen = true;
  const leg = getLegajoById(id);

  $('#detailTitle').textContent = `${leg.nombre_completo||'Legajo'} ‚Äî ${id}`;
  if(isAuthenticated){ $('#deleteLegajoBtn').classList.remove('hidden'); $('#editLegajoBtn').classList.remove('hidden'); }
  else { $('#deleteLegajoBtn').classList.add('hidden'); $('#editLegajoBtn').classList.add('hidden'); }

  $$('.tab-btn').forEach(b=>b.classList.remove('active'));
  $$('.tab-btn')[0].classList.add('active');

  const tabContent = $('#tab-content');

  function renderTimeline(legRef){
    const currentState = legRef.estado_computo || '';
    const currentIdx = stateOrder.indexOf(currentState);
    let fechas={}; try{ fechas = JSON.parse(legRef.fechas_clave_json||'{}'); }catch(e){}
    return `<div class="timeline">
      ${steps.map((s,i)=>
        `<div class="tl-step">
          <div class="tl-dot
            ${currentIdx>-1 && i<currentIdx ? 'completed' : ''}
            ${currentIdx===i ? 'current' : ''}"></div>
          <div class="text-xs">${s.label}</div>
          <div class="text-[11px] ${fechas[s.key]?'':'text-gray-400'}">
            ${fechas[s.key]? new Date(fechas[s.key]).toLocaleDateString(): '‚Äî'}
          </div>
        </div>
        ${i<steps.length-1?`<div class="tl-line ${(currentIdx>-1 && i<currentIdx)?'active':''}"></div>`:''}
      `).join('')}
    </div>`;
  }

  function renderInfoTab(){
    const fin = (leg.fecha_fin_condena||'').toString().slice(0,10);
    const linkBtn = leg.link_computo ? `<button id="openComputoBtnInfo" class="btn btn-primary mt-3">Abrir C√≥mputo PDF</button>` : '';
    tabContent.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-sm">ID Legajo</label><input value="${leg.id_legajo||''}" disabled class="w-full border rounded px-3 py-2 bg-gray-50 dark:bg-[#0f172a]"></div>
        <div><label class="text-sm">N¬∞ Prontuario</label><input id="editProntuario" value="${leg.nro_prontuario||''}" class="w-full border rounded px-3 py-2" disabled></div>
        <div><label class="text-sm">Nombre Completo</label><input id="editNombre" value="${leg.nombre_completo||''}" class="w-full border rounded px-3 py-2" disabled></div>
        <div><label class="text-sm">Defensor Actual</label><input id="editDefensor" value="${leg.defensor_actual||''}" class="w-full border rounded px-3 py-2" disabled></div>
        <div><label class="text-sm">Fiscal Actual</label><input id="editFiscal" value="${leg.fiscal_actual||''}" class="w-full border rounded px-3 py-2" disabled></div>
        <div><label class="text-sm">Estado C√≥mputo</label>
          <select id="editEstado" class="w-full border rounded px-3 py-2" disabled>
            ${['Pendiente SPP','Provisorio','Enviado a Defensor√≠a','Enviado a Fiscal√≠a','Aprobado','Observado'].map(v=>`<option ${v===(leg.estado_computo||'')?'selected':''}>${v}</option>`).join('')}
          </select>
        </div>
        <div><label class="text-sm">Fecha Fin Condena</label><input id="editFin" type="date" value="${fin}" class="w-full border rounded px-3 py-2" disabled></div>
        <div><label class="text-sm">Link C√≥mputo</label><input id="editLink" type="url" value="${leg.link_computo||''}" class="w-full border rounded px-3 py-2" disabled></div>
      </div>

      <div class="mt-6">
        <h3 class="font-semibold mb-2">L√≠nea de tiempo del c√≥mputo</h3>
        <div id="timelineWrap">${renderTimeline(leg)}</div>
        ${linkBtn}
      </div>

      ${isAuthenticated?`<div class="mt-5 flex justify-end gap-2">
        <button id="saveLegajoBtn" class="btn btn-primary hidden">Guardar</button>
      </div>`:''}`;
    if (leg.link_computo) $('#openComputoBtnInfo').onclick = ()=> window.open(leg.link_computo, '_blank');

    $('#editLegajoBtn').onclick = ()=>{
      if(!isAuthenticated) return alert('Inicia sesi√≥n');
      if(confirm('¬øSeguro que quieres modificar este legajo?')){
        ['#editProntuario','#editNombre','#editDefensor','#editFiscal','#editEstado','#editFin','#editLink'].forEach(sel=>{
          const el = document.querySelector(sel); if(el) el.disabled=false;
        });
        $('#saveLegajoBtn').classList.remove('hidden');
        $('#editEstado').addEventListener('change', async (ev)=>{
          const newState = ev.target.value;
          await postData({ action:'updateComputoEstado', id_legajo:leg.id_legajo, newState }, {refreshData:false, refreshModal:false});
          const key = stateToKey[newState];
          if (key){
            let fechas={}; try{ fechas = JSON.parse(leg.fechas_clave_json||'{}'); }catch(e){}
            fechas[key] = new Date().toISOString();
            await postData({ action:'updateLegajoField', id_legajo:leg.id_legajo, field:'fechas_clave_json', value: JSON.stringify(fechas) }, {refreshData:true, refreshModal:true});
          } else {
            await fetchData();
            if(isDetailModalOpen) openLegajoDetail(leg.id_legajo);
          }
        }, { once:true });
      }
    };

    $('#saveLegajoBtn').onclick = async ()=>{
      if(!confirm('¬øSeguro de guardar los cambios?')) return;
      const btn = $('#saveLegajoBtn');
      btn.textContent = 'Guardando datos...'; btn.disabled = true;

      // NOTA: Esto podr√≠a optimizarse en una sola llamada al backend
      await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'nro_prontuario',value:$('#editProntuario').value},{refreshData:false});
      await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'nombre_completo',value:$('#editNombre').value},{refreshData:false});
      await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'defensor_actual',value:$('#editDefensor').value},{refreshData:false});
      await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'fiscal_actual',value:$('#editFiscal').value},{refreshData:false});
      await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'fecha_fin_condena',value:$('#editFin').value},{refreshData:false});
      await postData({action:'updateLegajoField',id_legajo:leg.id_legajo,field:'link_computo',value:$('#editLink').value},{refreshData:true, refreshModal:true});

      btn.textContent = 'Guardar'; btn.disabled=false;
      ['#editProntuario','#editNombre','#editDefensor','#editFiscal','#editEstado','#editFin','#editLink'].forEach(sel=>{
        const el = document.querySelector(sel); if(el) el.disabled=true;
      });
      btn.classList.add('hidden');
      showToast('Datos guardados con √©xito');
    };
  }

  function renderSentenciasTab(){
    const sent = getSentenciasByLegajo(id);
    $('#tab-content').innerHTML = sent.length
      ? sent.map(s=>
        `<div class='p-3 border rounded flex items-center justify-between gap-3'>
          <div class='min-w-0'>
            <div class='font-medium truncate'>Causa ${s.nro_causa}</div>
            <div class='text-sm opacity-80 truncate'>${s.delito} ‚Ä¢ ${s.pena_impuesta} ‚Ä¢ ${ (s.fecha_sentencia||'').toString().slice(0,10) }</div>
          </div>
          <div class='flex items-center gap-2 flex-shrink-0'>
            ${s.enlace_sentencia?`<a class='btn btn-secondary' target='_blank' href='${s.enlace_sentencia}'>Ver</a>`:''}
            ${isAuthenticated?`<button class='btn btn-secondary' onclick="openEditarSentenciaModal('${s.id_sentencia}')">Modificar</button>`:''}
            ${isAuthenticated?`<button class='btn btn-danger' onclick="deleteSentencia('${s.id_sentencia}')">Eliminar</button>`:''}
          </div>
        </div>`).join('')
      : '<div class="text-sm opacity-70">Sin sentencias.</div>';
  }

  function renderComputoTab(){
    const leg = getLegajoById(id);
    const linkBtn = leg.link_computo ? `<button id="openComputoBtnComp" class="btn btn-primary mt-3">Abrir C√≥mputo PDF</button>` : '';
    $('#tab-content').innerHTML = `
      <div id="timelineWrap">${renderTimeline(leg)}</div>
      ${linkBtn}
    `;
    if (leg.link_computo) $('#openComputoBtnComp').onclick = ()=> window.open(leg.link_computo, '_blank');
  }

  function renderTramitesTab(){
    const ben  = getBeneficiosByLegajo(id);
    const tram = getTramitesByLegajo(id);
    const all  = ben.concat(tram);
    $('#tab-content').innerHTML = (all.length
      ? all.map(t=>
        `<div class='p-3 border rounded'>
          <div class='font-medium'>${t.expediente||t.tipo_tramite||''}</div>
          <div class='text-sm opacity-80'>${t.beneficio||t.tipo_tramite||''} ‚Ä¢ Estado: ${t.estado||''}</div>
        </div>`).join('')
      : '<div class="text-sm opacity-70">Sin tr√°mites/beneficios.</div>');
  }

  // Bind de tabs
  $$('.tab-btn').forEach(btn=>{
    btn.onclick = ()=>{
      $$('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      if(tab==='info')      renderInfoTab();
      if(tab==='sentencias')renderSentenciasTab();
      if(tab==='computo')   renderComputoTab();
      if(tab==='tramites')  renderTramitesTab();
    };
  });
  renderInfoTab(); // default

  $('#deleteLegajoBtn').onclick = async ()=>{
    if(!isAuthenticated) return alert('Inicia sesi√≥n');
    if(confirm('¬øEliminar legajo y TODOS sus registros vinculados? Esta acci√≥n no se puede deshacer.')){
      await postData({action:'deleteLegajoCompleto',id_legajo:id}, {refreshData:true, refreshModal:false});
      detailModal.classList.remove('show');
      isDetailModalOpen = false;
      showToast('Legajo eliminado');
    }
  };

  detailModal.classList.add('show');
}

/**********************
 * KANBAN BENEFICIOS (Monitor integrado)
 **********************/
const KANBAN_COLUMNS = [
  'Ingresado','En Gabinete','Regreso','Fiscal√≠a','Defensor√≠a','Para Despacho','Finalizado'
];
const DEFAULT_BENEFIT_COLORS = {
  'Salidas Transitorias':'#dbeafe','Prisi√≥n Domiciliaria':'#d1fae5','Est√≠mulo Educativo':'#e9d5ff',
  'Libertad Asistida':'#ccfbf1','Libertad Condicional':'#e0e7ff','R√©gimen Preparatorio':'#fce7f3','Otro':'#f3f4f6'
};
let benefitColors = {...DEFAULT_BENEFIT_COLORS};
let casesData = [];
let benefitsChart = null;
let caseIdToFinalize = null;

function loadBenefitColors() {
    const savedColors = localStorage.getItem('benefit_colors');
    benefitColors = {...DEFAULT_BENEFIT_COLORS}; // Reset to default first
    if (savedColors) {
        try {
            const customColors = JSON.parse(savedColors);
            Object.assign(benefitColors, customColors); // Merge saved colors
        } catch (e) {
            console.error("Error parsing benefit colors from localStorage", e);
        }
    }
}
function renderBenefitColorSettings() {
    const container = $('#benefitColorSettings');
    container.innerHTML = '';
    Object.keys(DEFAULT_BENEFIT_COLORS).forEach(benefit => {
        const currentColor = benefitColors[benefit] || DEFAULT_BENEFIT_COLORS[benefit];
        const wrapper = document.createElement('label');
        wrapper.className = 'text-sm';
        wrapper.innerHTML = `${benefit}
            <input type="color" data-benefit="${benefit}" value="${currentColor}" class="w-full h-10 border rounded mt-1">`;
        container.appendChild(wrapper);
    });
}

function hydrateCasesFromBeneficios(beneficios){
  casesData = (beneficios||[]).map(b=>({
    id: b.id_beneficio_legajo,
    id_legajo: b.id_legajo,
    expediente: b.expediente,
    interno: b.interno,
    beneficio: b.beneficio,
    estado: b.estado,
    observacion: b.Observacion, // <-- CAMBIO: Aseg√∫rate que el nombre de la propiedad coincida con el encabezado de la hoja
    fechaIngreso: b.fechaIngreso,
    fechaEnvioGabinete: b.fechaEnvioGabinete,
    fechaRegresoGabinete: b.fechaRegresoGabinete,
    fechaEnvioFiscalia: b.fechaEnvioFiscalia,
    fechaEnvioDefensoria: b.fechaEnvioDefensoria,
    fechaDespacho: b.fechaDespacho,
    fechaFinalizado: b.fechaFinalizado,
    motivoFinalizado: b.motivoFinalizado,
    enlaceResolucion: b.enlaceResolucion
  }));
}

function initializeBoard(){
  const board = $('#kanban-board');
  board.innerHTML = '';
  const topRow = document.createElement('div');
  topRow.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6';
  const bottomRow = document.createElement('div');
  bottomRow.className = 'mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';

  KANBAN_COLUMNS.forEach((status, index)=>{
    const col = document.createElement('div');
    col.className = 'rounded-xl p-4 kanban-column relief-border';
    col.dataset.status = status;
    col.innerHTML = `<h2 class="font-bold text-lg mb-4 flex justify-between items-center dark:text-white">
      ${status}
      <span id="count-${status.toLowerCase().replace(/ /g,'-')}" class="text-xs bg-gray-200 text-gray-700 rounded-full px-2 py-0.5">0</span>
    </h2>
    <div class="space-y-3 card-container" ondragover="event.preventDefault()"></div>`;
    if (index<4) topRow.appendChild(col); else bottomRow.appendChild(col);
  });

  board.appendChild(topRow);
  board.appendChild(bottomRow);
}

function renderBoard(data){
  initializeBoard();
  const board = $('#kanban-board');
  if (!Array.isArray(data)) return;
  KANBAN_COLUMNS.forEach(status=> updateColumnCounter(status, 0, true));

  data.forEach(item=>{
    const status = (item.estado||'').trim();
    const col = board.querySelector(`.kanban-column[data-status="${status}"] .card-container`);
    if (!col) return;
    const card = createCardElement(item);
    col.appendChild(card);
    updateColumnCounter(status, 1);
  });

  if (isAuthenticated) setupDragAndDrop();
}

function createCardElement(caseItem){
  const card = document.createElement('div');
  card.className = 'kanban-card p-4 rounded-xl relief-border cursor-pointer';
  card.dataset.id = caseItem.id;

  const bgColor = benefitColors[caseItem.beneficio] || benefitColors['Otro'];
  const textColor = getContrastColor(bgColor);
  const displayDate = caseItem.fechaIngreso ? new Date(caseItem.fechaIngreso).toLocaleDateString() : 'N/A';
  const legajoInfo = caseItem.id_legajo ? `<div class="text-xs mt-1 font-semibold">Legajo: #${caseItem.id_legajo}</div>` : '';
  const observacionInfo = caseItem.observacion ? `<p class="mt-2 text-xs italic text-gray-600 dark:text-gray-400 border-l-2 border-gray-300 pl-2 truncate" title="${caseItem.observacion}">${caseItem.observacion}</p>` : '';

  card.innerHTML = `
    <div class="font-bold text-lg card-text-main">${caseItem.expediente || 'S/N'}</div>
    <div class="text-sm mb-2 card-text-secondary">${caseItem.interno || 'S/N'}</div>
    <div class="benefit-tag text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full" style="background-color:${bgColor}; color:${textColor};">${caseItem.beneficio || 'Otro'}</div>
    ${legajoInfo}
    <div class="text-xs mt-2 card-dates card-text-secondary">
      <div>Ingreso: ${displayDate}</div>
    </div>
    ${observacionInfo}
    <div class="finalizado-info">
      ${caseItem.estado==='Finalizado' && caseItem.motivoFinalizado ? `<p class="mt-2 text-xs italic">Motivo: ${caseItem.motivoFinalizado}</p>`:''}
      ${caseItem.estado==='Finalizado' && caseItem.enlaceResolucion ? `<a href="${caseItem.enlaceResolucion}" target="_blank" class="mt-2 inline-block text-xs text-indigo-600 hover:underline">Ver Resoluci√≥n</a>`:''}
    </div>
  `;
  if (caseItem.estado === 'En Gabinete' && caseItem.fechaEnvioGabinete) {
    const entryDate = new Date(caseItem.fechaEnvioGabinete);
    const days = (Date.now()-entryDate.getTime())/(1000*3600*24);
    if ($('#alarmToggle').checked && days > 7) {
      card.style.boxShadow = '0 0 0 0 rgba(239,68,68,.7)';
      card.animate([
        { boxShadow: '0 0 0 0 rgba(239,68,68,.7)' },
        { boxShadow: '0 0 18px 6px rgba(239,68,68,0)' },
        { boxShadow: '0 0 0 0 rgba(239,68,68,0)' }
      ], { duration: 1500, iterations: Infinity });
    }
  }

  if (isAuthenticated) {
    card.classList.add('draggable');
    card.draggable = true;
    card.addEventListener('click', ()=> openEditModal(caseItem));
  }
  return card;
}

function setupDragAndDrop(){
  const cards = $$('.draggable');
  const columns = $$('.kanban-column');
  cards.forEach(c=>{
    c.addEventListener('dragstart', ()=> c.classList.add('dragging'));
    c.addEventListener('dragend', ()=> c.classList.remove('dragging'));
  });
  columns.forEach(column=>{
    column.addEventListener('dragover', e=>{ e.preventDefault(); if($('.dragging')) column.classList.add('drag-over'); });
    column.addEventListener('dragleave', ()=> column.classList.remove('drag-over'));
    column.addEventListener('drop', async e=>{
      e.preventDefault();
      column.classList.remove('drag-over');
      const draggingCard = $('.dragging');
      if (!draggingCard) return;
      const cardId = draggingCard.dataset.id;
      const newStatus = column.dataset.status;
      const oldStatus = draggingCard.closest('.kanban-column').dataset.status;
      if (oldStatus === newStatus) return;
      
      const item = casesData.find(c=>c.id==cardId);
      if (!item) return;

      if (newStatus === 'Finalizado') {
        caseIdToFinalize = cardId;
        $('#finalizeModal').classList.add('show');
        return;
      }
      
      column.querySelector('.card-container').appendChild(draggingCard);
      updateColumnCounter(oldStatus,-1);
      updateColumnCounter(newStatus,1);
      
      item.estado = newStatus;
      item.observacion = ''; // <-- RESETEO DE OBSERVACI√ìN
      
      // Actualizar backend: resetear observaci√≥n primero
      await postData({ action:'updateBeneficioField', id_beneficio_legajo:cardId, field:'Observacion', value: '' }, {refreshData:false});
      
      const map = {
        'Fiscal√≠a':'fechaEnvioFiscalia','Defensor√≠a':'fechaEnvioDefensoria','En Gabinete':'fechaEnvioGabinete',
        'Regreso':'fechaRegresoGabinete','Para Despacho':'fechaDespacho'
      };
      const field = map[newStatus];
      if (field) {
        const iso = new Date().toISOString();
        item[field] = iso;
        await postData({ action:'updateBeneficioStatus', id_beneficio_legajo:cardId, newStatus }, {refreshData:false});
        await postData({ action:'updateBeneficioField', id_beneficio_legajo:cardId, field, value: iso }, {refreshData:true});
      } else {
        await postData({ action:'updateBeneficioStatus', id_beneficio_legajo:cardId, newStatus }, {refreshData:true});
      }
    });
  });
}

function updateColumnCounter(status, change, reset=false){
  const id = `#count-${status.toLowerCase().replace(/ /g,'-')}`;
  const el = $(id);
  if (!el) return;
  if (reset) el.textContent = '0';
  else el.textContent = String(parseInt(el.textContent,10) + change);
}

function getContrastColor(hex){ if(!hex) return '#000'; const r=parseInt(hex.substr(1,2),16),g=parseInt(hex.substr(3,2),16),b=parseInt(hex.substr(5,2),16); return (((r*299)+(g*587)+(b*114))/1000>=128)?'#000':'#fff'; }

function calcStats(data){
  const active = (data||[]).filter(c=>c.estado!=='Finalizado');
  $('#total-activos').textContent = active.length;
  const gabinete = (data||[]).filter(c=>c.fechaEnvioGabinete && c.fechaRegresoGabinete);
  if (gabinete.length>0){
    const total = gabinete.reduce((acc,c)=> acc + (Math.abs(new Date(c.fechaRegresoGabinete)-new Date(c.fechaEnvioGabinete))/(1000*60*60*24)), 0);
    $('#avg-time').textContent = `${(total/gabinete.length).toFixed(1)} d√≠as`;
  } else { $('#avg-time').textContent = 'N/A'; }
}

function renderChart(data){
  const el = $('#benefitsChart'); if(!el) return;
  const ctx = el.getContext('2d');
  const counts = {};
  (data||[]).filter(c=>c.estado!=='Finalizado').forEach(b=> counts[b.beneficio]=(counts[b.beneficio]||0)+1 );
  const labels = Object.keys(counts);
  const values = Object.values(counts);
  if (benefitsChart) benefitsChart.destroy();
  const isDark = $('#body').classList.contains('dark');
  benefitsChart = new Chart(ctx,{
    type:'pie',
    data:{ labels, datasets:[{ data: values, backgroundColor: labels.map(l=> benefitColors[l] || benefitColors['Otro']), borderColor: isDark? 'var(--dark-bg-general)':'var(--light-bg-general)', borderWidth:3 }]},
    options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right', labels:{ color: isDark ? '#d1d5db' : '#4b5563' } } } }
  });
}

function populateLegajosDropdown(selectedId = null) {
    const select = $('#id_legajo');
    select.innerHTML = '<option value="">-- Seleccione un legajo --</option>';
    (allData.legajos || []).sort((a, b) => (a.nombre_completo || '').localeCompare(b.nombre_completo)).forEach(legajo => {
        const option = document.createElement('option');
        option.value = legajo.id_legajo;
        option.textContent = `${legajo.nombre_completo} - Pront. ${legajo.nro_prontuario || 'S/N'}`;
        if (selectedId && legajo.id_legajo == selectedId) {
            option.selected = true;
        }
        select.appendChild(option);
    });
}

const toInputDate = (isoString) => {
    if (!isoString) return '';
    try {
        const d = new Date(isoString);
        const off = d.getTimezoneOffset();
        const adj = new Date(d.getTime() - off * 60 * 1000);
        return adj.toISOString().split('T')[0];
    } catch (e) { return ''; }
};

/* Abrir/editar beneficio */
function openEditModal(caseItem){
  $('#modalTitle').textContent = 'Editar Tr√°mite';
  $('#deleteCaseBtn').classList.remove('hidden');
  populateLegajosDropdown(caseItem.id_legajo);
  
  $('#id_legajo').value = caseItem.id_legajo || '';
  $('#interno').value = caseItem.interno || '';

  $('#caseId').value = caseItem.id || '';
  $('#expediente').value = caseItem.expediente || '';
  $('#beneficio').value = caseItem.beneficio || 'Otro';
  $('#observacion').value = caseItem.observacion || '';
  $('#fechaIngreso').value = toInputDate(caseItem.fechaIngreso);
  $('#fechaEnvioGabinete').value = toInputDate(caseItem.fechaEnvioGabinete);
  $('#fechaRegresoGabinete').value = toInputDate(caseItem.fechaRegresoGabinete);
  $('#fechaEnvioFiscalia').value = toInputDate(caseItem.fechaEnvioFiscalia);
  $('#fechaEnvioDefensoria').value = toInputDate(caseItem.fechaEnvioDefensoria);
  $('#fechaDespacho').value = toInputDate(caseItem.fechaDespacho);
  $('#fechaFinalizado').value = toInputDate(caseItem.fechaFinalizado);
  $('#motivoFinalizadoEdit').value = caseItem.motivoFinalizado || '';
  $('#enlaceResolucionEdit').value = caseItem.enlaceResolucion || '';

  updateCharCounter(); // Actualizar contador al abrir
  $('#caseModal').classList.add('show');
}

/* Guardar alta/edici√≥n beneficio */
$('#cancelBtn').onclick = ()=> $('#caseModal').classList.remove('show');
$('#caseModal').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) e.currentTarget.classList.remove('show'); });

$('#caseForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const saveBtn = $('#saveCaseBtn');
  const orig = saveBtn.textContent;
  saveBtn.textContent = 'Guardando...'; saveBtn.disabled = true; $('#cancelBtn').disabled=true;

  const fd = new FormData(e.target);
  const id = fd.get('caseId');
  const payload = Object.fromEntries(fd.entries());

  if (id){ // UPDATE
    for (const [key, value] of Object.entries(payload)) {
        if (key !== 'caseId') {
            await postData({ action:'updateBeneficioField', id_beneficio_legajo:id, field:key, value }, {refreshData:false});
        }
    }
    await fetchData();
  } else { // ALTA
    payload.estado = 'Ingresado';
    await postData({ action:'addBeneficio', ...payload }, {refreshData:true});
  }

  $('#caseModal').classList.remove('show');
  saveBtn.textContent = orig; saveBtn.disabled=false; $('#cancelBtn').disabled=false;
});

$('#id_legajo').addEventListener('change', (e) => {
    const legajoId = e.target.value;
    const legajo = getLegajoById(legajoId);
    $('#interno').value = legajo.nombre_completo || '';
});

$('#deleteCaseBtn').addEventListener('click', async () => {
    const id = $('#caseId').value;
    if (!id) return;
    if (confirm('¬øEst√° seguro de que desea eliminar este beneficio? Esta acci√≥n no se puede deshacer.')) {
        await postData({ action: 'deleteBeneficio', id_beneficio_legajo: id }, { refreshData: true });
        $('#caseModal').classList.remove('show');
        showToast('Beneficio eliminado correctamente.');
    }
});


/* Finalizar arrastre a Finalizado */
$('#finalizeForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    id_beneficio_legajo: caseIdToFinalize,
    motivoFinalizado: $('#motivoFinalizado').value,
    enlaceResolucion: $('#enlaceResolucion').value
  };
  await postData({ action:'updateBeneficioStatus', id_beneficio_legajo:payload.id_beneficio_legajo, newStatus:'Finalizado' }, {refreshData:false});
  await postData({ action:'updateBeneficioField', id_beneficio_legajo:payload.id_beneficio_legajo, field:'motivoFinalizado', value:payload.motivoFinalizado }, {refreshData:false});
  await postData({ action:'updateBeneficioField', id_beneficio_legajo:payload.id_beneficio_legajo, field:'enlaceResolucion', value:payload.enlaceResolucion }, {refreshData:false});
  await postData({ action:'updateBeneficioField', id_beneficio_legajo:payload.id_beneficio_legajo, field:'fechaFinalizado', value:new Date().toISOString() }, {refreshData:true});
  $('#finalizeModal').classList.remove('show');
  $('#finalizeForm').reset();
});
$('#cancelFinalizeBtn').onclick = ()=>{
  $('#finalizeModal').classList.remove('show');
  $('#finalizeForm').reset();
  fetchData();
};

/* Buscar en tablero */
$('#searchInput').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase();
  const filtered = casesData.filter(c=> (c.expediente||'').toLowerCase().includes(q) || (c.interno||'').toLowerCase().includes(q));
  renderBoard(filtered);
  renderChart(filtered);
  calcStats(filtered);
});

/* Toggle alarmas */
$('#alarmToggle').addEventListener('change', ()=> renderBoard(casesData));

/* Botones Beneficios */
$('#addCaseBtn').addEventListener('click', ()=>{
  $('#caseForm').reset();
  $('#modalTitle').textContent = 'Agregar Nuevo Tr√°mite';
  $('#caseId').value = '';
  $('#deleteCaseBtn').classList.add('hidden');
  populateLegajosDropdown();
  updateCharCounter();
  $('#caseModal').classList.add('show');
});
$('#refreshBenefitsBtn').addEventListener('click', ()=> fetchData());

/* Alert modal */
function showAlert(title, message){ $('#alertTitle').textContent=title; $('#alertMessage').textContent=message; $('#alertModal').classList.add('show'); }
$('#closeAlertBtn').onclick = ()=> $('#alertModal').classList.remove('show');

/* Contador de caracteres para Observaci√≥n */
function updateCharCounter() {
    const obsText = $('#observacion');
    const counter = $('#charCounter');
    const len = obsText.value.length;
    if (len > CHAR_LIMIT) {
        obsText.value = obsText.value.substring(0, CHAR_LIMIT);
    }
    counter.textContent = `${obsText.value.length} / ${CHAR_LIMIT}`;
}
$('#observacion').addEventListener('input', updateCharCounter);


/**********************
 * INICIO
 **********************/
applyThemeFromStorage();

document.querySelectorAll('.modal-backdrop').forEach(m=>{
  m.addEventListener('click', (e)=>{
    if(e.target===m){
      m.classList.remove('show');
      if(m.id==='legajoDetailModal') isDetailModalOpen = false;
    }
  });
});

const today = new Date().toISOString().split('T')[0];
document.querySelectorAll('input[type="date"]').forEach(input => input.max = today);

fetchData();

</script>
</body>
</html>
